
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Pour Les Gouverner Tous - Partie 3/3 - Jetoile</title>
  <meta name="author" content="Khanh Maudoux">

  <meta content='blog sur Java jee' name='description'/>
  <meta content='jee, java, cloud, nosql' name='keywords'/>
  <meta content='index, follow' name='robots'/>
  <link href='url' rel='canonical'/>

  
  <meta name="description" content="Pour Les Gouverner Tous - Partie 3/3 February 24, 2011 Cet article fait suite à mes précédents posts (ici et là) et à pour objectif d&#8217;intégrer &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://blog.jetoile.fr/2011/02/pour-les-gouverner-tous-partie-33.html">
  <link href="/favicon.ico" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="Jetoile" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="./javascripts/libs/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>

  <script src="/javascripts/monthly_archive.js"></script>
  <!-- font-family: 'Knewave', cursive; -->
<link href='http://fonts.googleapis.com/css?family=Knewave' rel='stylesheet' type='text/css'>
<!-- font-family: 'Cantata One', serif; -->
<link href='http://fonts.googleapis.com/css?family=Cantata+One' rel='stylesheet' type='text/css'>

  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-11955429-1']);
    _gaq.push(['_trackPageview']);
    _gaq.push(['_setDomainName','github.io']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

  <body>
    <a href="/" class="home-icon">
      <img src="/images/home.png"/>
    </a>

    <article role="article" class="full-single-article">
  <div class="container">
    <div class="row">
      <div class="col-md-8 col-md-offset-2">
        <h1>Pour Les Gouverner Tous - Partie 3/3</h1>
        <div class="meta">
          








  



<time datetime="2011-02-24T18:49:13+01:00" pubdate data-updated="true">February 24, 2011</time>  
        </div>
        <p><img src="http://3.bp.blogspot.com/_XLL8sJPQ97g/TUcoTratqiI/AAAAAAAAAUQ/Gmc1h0rvA2w/s1600/jmx_jgroups01.png" alt="left-small" /></p>

<p>Cet article fait suite à mes précédents posts (<a href="/2011/01/pour-les-gouverner-tous-partie-13.html">ici</a> et <a href="/2011/02/pour-les-gouverner-tous-partie-23.html">là</a>) et à pour objectif d&#8217;intégrer la partie JMX à mon petit POC JGroups afin d&#8217;offrir une solution permettant de rendre complètement scalable la partie supervision/administration par JMX d&#8217;une application distribuée (ie. d&#8217;aggréger tous les MBeans au sein de tous les serveurs JMX). Pour rappel, le post précédent introduisait JGroups dans une petite application qui permettait à chaque instance d&#8217;une application d&#8217;obtenir la valeur d&#8217;une donnée offerte par les autres instances.</p>

<!-- more -->


<h1>Expression du besoin et conception</h1>

<p>Comme je l&#8217;ai expliqué <a href="/2011/01/pour-les-gouverner-tous-partie-13.html">ici</a>, le principe est simple : en démarrant son application qui aura à sa charge d&#8217;appeler un petit bout de code de notre toolkit, tous les MBeans se trouvant sur les autres serveurs JMX (modulo que l&#8217;application qui les ait démarrés ait démarré en instanciant notre toolkit) doivent être remonter dans notre serveur JMX courant. Réciproquement, tous les MBeanServer devront enregistrer les MBeans offerts par notre instance d&#8217;application.</p>

<p>Pour ce faire, notre toolkit gérera la partie JMX, c&#8217;est-à-dire qu&#8217;il créera un connecteur JMX serveur (connecteur s&#8217;appuyant sur le protocole RMI) permettant d&#8217;accéder au MBeanServer courant (ie. il utilisera le MBeanServer s&#8217;il en existe un ou, dans le cas échéant, il en créera un) et qu&#8217;il l&#8217;exposera aux autres instances en fournissant un stub de la partie connecteur JMX cliente. Ce stub permettra aux autres instances d&#8217;instancier la couche de communication nécessaire vers le MBeanServer cible. C&#8217;est ce stub qui sera transmis par JGroups (et qui remplacera donc la donnée partagée de notre <em>POC</em> JGroups).</p>

<p>Ca va? Tout le monde suit? Bon, on va pouvoir accélérer&hellip; ;&ndash;)</p>

<p>Ainsi, lorsqu&#8217;une nouvelle instance sera démarrée dans le système, les instances déjà présentes seront notifiées de l&#8217;arrivé d&#8217;un nouveau membre dans la vue (<a href="/2010/12/jgroups-tour-d.html">concepts JGroups</a> et cf. <a href="/2011/02/pour-les-gouverner-tous-partie-23.html">post précédent</a>). Suite à cela, elles récupèreront le stub du JMXConnector du nouveau MBeanServer (toujours cf. <a href="/2011/02/pour-les-gouverner-tous-partie-23.html">post précédent</a>) qui leur permettra de créer un proxy dynamique correspondant aux MBeans présents dans le MBeanServer cible. Ce proxy dynamique sera instancié et enregistré comme étant un nouveau MBean dans le MBeanServer de l&#8217;instance courante.</p>

<p>Cependant, ce proxy dynamique ne pourra pas être utilisé directement (sinon ça serait trop simple). En effet, la méthode statique <code>JMX.newMBeanProxy()</code> permet de créer un proxy dynamique du MBean standard d&#8217;un MBeanServer distant ou local. Cependant, il n&#8217;est pas possible de l&#8217;enregistrer comme MBean au sein d&#8217;un MBeanServer car il ne répond alors pas à la règle : &ldquo;un MBean doit implémenter une interface de type MBean ou DynamicMBean&rdquo;. Aussi, la solution retenue a été de wrapper ce proxy dynamique dans un MBean dynamique. Ce wrapper fera donc passe-plat (en utilisant la réflexion) avec le proxy dynamique récupéré par la méthode <code>JMX.newMBeanProxy()</code> lors de l&#8217;invocation d&#8217;opérations dessus (pour ce faire, il s&#8217;appuiera sur les normes spécifiées par JMX pour l&#8217;accès en lecture/écriture aux variables d&#8217;instance).</p>

<p>En outre, pour le cas spécifique des MXBeans (un certain nombre de MXBean est spécifié par JMX : <a href="http://download.oracle.com/javase/6/docs/api/">http://download.oracle.com/javase/6/docs/api/</a>), un traitement particulier sera effectué. En effet, JMX offre la possibilité de créer directement un proxy de l&#8217;interface d&#8217;un MXBean donné via la méthode statique <code>ManagementFactory.newPlatformMXBeanProxy()</code>. Aussi, pour les MXBeans, notre wrapper ne sera pas utilisé puisqu&#8217;il est possible d&#8217;enregistrer directement au sein de notre MBeanServer courant le MXBean distant.</p>

<p>Bien sûr, encore une fois, cela aurait été trop simple s&#8217;il n&#8217;y avait pas un mais&hellip; ;&ndash;) En effet, la spécification JMX précise qu&#8217;il est possible d&#8217;avoir plusieurs MXBeans de type <code>MemoryPoolMXBean</code>, <code>MemoryManagerMXBean</code> et <code>GarbageCollector</code> (cf. <a href="http://download.oracle.com/javase/6/docs/api/">http://download.oracle.com/javase/6/docs/api/</a>). Dans ces cas précis, ce sont les propriétés de ces MXBeans qui permettent de les différencier : un traitement particulier sera donc effectué dans ces cas précis puisqu&#8217;une recherche pour décrouvrir les propritétés du MXBean sera faite.</p>

<p>En outre, un cas particulier lié à la JRE 6 de Sun (Hostpot) a, ici, été traité (du coup, cela rend le code proposé adhérent à notre jdk&hellip;) puisque le MXBean <code>HotpostDiagnostic</code> a fait l&#8217;objet d&#8217;une attention particulière&hellip;</p>

<h1>Mise en oeuvre</h1>

<h2>Intégration de JMX</h2>

<p><u>Note</u> : à noter que le code présenté dans cet article comporte quelques raccourcis et n&#8217;a pour objectif que de montrer les points clé. Aussi, certaines portions (comme, entre autre, la gestion des threads, des exceptions ou les méthodes <code>equals()</code>, <code>hashCode()</code> ou <code>toString()</code>) ne sont pas présentes par soucis de clarté. Le code complet peut être trouvé sur GitHub : <a href="https://github.com/jetoile/jmanager4all.">https://github.com/jetoile/jmanager4all.</a></p>

<p>Ici, la donnée, traduite par la classe <code>Data</code> dans mon article précédent, sera remplacée par le stub au <code>JMXConnector</code>. Ce stub sera créé par la classe utilisée pour instancier les objets nécessaires à la bonne initalisation du toolkit et il sera encapsulé dans la classe <code>JManagerConnector</code> (à noter, bien sûr que la classe <code>RMIConnector</code> (implémentation de l&#8217;interface <code>JMXConnector</code>) utilisée ici est sérialisable) lors de sa transmission entre les différentes instances de l&#8217;application.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kd">public</span> <span class="kd">class</span> <span class="nc">JManagerConnector</span> <span class="kd">implements</span> <span class="n">Serializable</span> <span class="o">{</span>
</span><span class='line'> <span class="kd">private</span> <span class="n">String</span> <span class="n">location</span><span class="o">;</span>
</span><span class='line'> <span class="kd">private</span> <span class="n">JMXConnector</span> <span class="n">connector</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'> <span class="kd">public</span> <span class="nf">JManagerConnector</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'> <span class="o">}</span>
</span><span class='line'>
</span><span class='line'> <span class="kd">public</span> <span class="n">String</span> <span class="nf">getLocation</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>  <span class="k">return</span> <span class="n">location</span><span class="o">;</span>
</span><span class='line'> <span class="o">}</span>
</span><span class='line'>
</span><span class='line'> <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setLocation</span><span class="o">(</span><span class="kd">final</span> <span class="n">String</span> <span class="n">location</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>  <span class="k">this</span><span class="o">.</span><span class="na">location</span> <span class="o">=</span> <span class="n">location</span><span class="o">;</span>
</span><span class='line'> <span class="o">}</span>
</span><span class='line'>
</span><span class='line'> <span class="kd">public</span> <span class="n">JMXConnector</span> <span class="nf">getConnector</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>  <span class="k">return</span> <span class="n">connector</span><span class="o">;</span>
</span><span class='line'> <span class="o">}</span>
</span><span class='line'>
</span><span class='line'> <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setConnector</span><span class="o">(</span><span class="kd">final</span> <span class="n">JMXConnector</span> <span class="n">connector</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>  <span class="k">this</span><span class="o">.</span><span class="na">connector</span> <span class="o">=</span> <span class="n">connector</span><span class="o">;</span>
</span><span class='line'> <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Du point de vue création des objets JMX exposés (ie. le <code>JMXConnector</code> et son stub) et de l&#8217;initialisation de ces derniers (ie. démarrage du connecteur), cela sera fait, comme dit précédemment, par notre classe qui nous servira de point d&#8217;entrée à notre toolkit <code>JManager4All</code> :</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kd">public</span> <span class="kd">class</span> <span class="nc">JManager4All</span> <span class="o">{</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">final</span> <span class="kd">static</span> <span class="kd">private</span> <span class="n">Logger</span> <span class="n">LOGGER</span> <span class="o">=</span> <span class="n">LoggerFactory</span><span class="o">.</span><span class="na">getLogger</span><span class="o">(</span><span class="n">JManager4All</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">CONNECTOR_PROTOCOL</span> <span class="o">=</span> <span class="s">&quot;rmi&quot;</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">private</span> <span class="n">JMXConnectorServer</span> <span class="n">jmxConnector</span><span class="o">;</span>
</span><span class='line'>    <span class="kd">private</span> <span class="n">JMXServiceURL</span> <span class="n">jmxServiceUrl</span><span class="o">;</span>
</span><span class='line'>    <span class="kd">final</span> <span class="kd">private</span> <span class="n">JManagerConnector</span> <span class="n">jmanagerConnector</span> <span class="o">=</span> <span class="k">new</span> <span class="n">JManagerConnector</span><span class="o">();</span>
</span><span class='line'>    <span class="kd">private</span> <span class="kd">final</span> <span class="n">MBeanServer</span> <span class="n">mBeanServer</span><span class="o">;</span>
</span><span class='line'>    <span class="kd">final</span> <span class="kd">private</span> <span class="n">JMXConnectorStubCache</span> <span class="n">connectorsStub</span> <span class="o">=</span> <span class="k">new</span> <span class="n">JMXConnectorStubCache</span><span class="o">();</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">private</span> <span class="n">JGroupsBindingComponent</span> <span class="n">jmanagerBindingComponent</span><span class="o">;</span>
</span><span class='line'>    <span class="kd">public</span> <span class="nf">JManager4All</span><span class="o">(</span><span class="kd">final</span> <span class="kt">int</span> <span class="n">port</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>        <span class="k">try</span> <span class="o">{</span>
</span><span class='line'>            <span class="k">this</span><span class="o">.</span><span class="na">jmxServiceUrl</span> <span class="o">=</span> <span class="k">new</span> <span class="n">JMXServiceURL</span><span class="o">(</span><span class="n">CONNECTOR_PROTOCOL</span><span class="o">,</span> <span class="kc">null</span><span class="o">,</span> <span class="n">port</span><span class="o">);</span>
</span><span class='line'>        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">MalformedURLException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>            <span class="n">LOGGER</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="s">&quot;unable to create JMXServiceURL: {}&quot;</span><span class="o">,</span> <span class="n">e</span><span class="o">);</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>        <span class="k">this</span><span class="o">.</span><span class="na">mBeanServer</span> <span class="o">=</span> <span class="n">ManagementFactory</span><span class="o">.</span><span class="na">getPlatformMBeanServer</span><span class="o">();</span>
</span><span class='line'>        <span class="n">init</span><span class="o">();</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">private</span> <span class="kt">void</span> <span class="nf">init</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>        <span class="k">try</span> <span class="o">{</span>
</span><span class='line'>            <span class="k">this</span><span class="o">.</span><span class="na">jmxConnector</span> <span class="o">=</span> <span class="n">JMXConnectorServerFactory</span><span class="o">.</span><span class="na">newJMXConnectorServer</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">jmxServiceUrl</span><span class="o">,</span> <span class="kc">null</span><span class="o">,</span> <span class="n">mBeanServer</span><span class="o">);</span>
</span><span class='line'>            <span class="k">this</span><span class="o">.</span><span class="na">jmxConnector</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
</span><span class='line'>
</span><span class='line'>            <span class="kd">final</span> <span class="n">ObjectName</span> <span class="n">objectName</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ObjectName</span><span class="o">(</span><span class="s">&quot;:type=csserver, name=csserver&quot;</span><span class="o">);</span>
</span><span class='line'>            <span class="n">mBeanServer</span><span class="o">.</span><span class="na">registerMBean</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">jmxConnector</span><span class="o">,</span> <span class="n">objectName</span><span class="o">);</span>
</span><span class='line'>            <span class="k">this</span><span class="o">.</span><span class="na">jmanagerConnector</span><span class="o">.</span><span class="na">setConnector</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">jmxConnector</span><span class="o">.</span><span class="na">toJMXConnector</span><span class="o">(</span><span class="kc">null</span><span class="o">));</span>
</span><span class='line'>
</span><span class='line'>            <span class="k">this</span><span class="o">.</span><span class="na">jmanagerBindingComponent</span> <span class="o">=</span> <span class="k">new</span> <span class="n">JGroupsBindingComponent</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">jmanagerConnector</span><span class="o">);</span>
</span><span class='line'>            <span class="k">this</span><span class="o">.</span><span class="na">jmanagerBindingComponent</span><span class="o">.</span><span class="na">setConnectorsStub</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">connectorsStub</span><span class="o">);</span>
</span><span class='line'>        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>            <span class="n">LOGGER</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="s">&quot;unable to init: {}&quot;</span><span class="o">,</span> <span class="n">e</span><span class="o">);</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">stop</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">IOException</span> <span class="o">{</span>
</span><span class='line'>        <span class="k">this</span><span class="o">.</span><span class="na">jmxConnector</span><span class="o">.</span><span class="na">stop</span><span class="o">();</span>
</span><span class='line'>        <span class="k">this</span><span class="o">.</span><span class="na">jmanagerBindingComponent</span><span class="o">.</span><span class="na">stop</span><span class="o">();</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">start</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>        <span class="k">this</span><span class="o">.</span><span class="na">jmanagerBindingComponent</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">public</span> <span class="n">JManagerConnector</span> <span class="nf">getStubConnector</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>        <span class="k">return</span> <span class="k">this</span><span class="o">.</span><span class="na">jmanagerConnector</span><span class="o">;</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>On remarquera également que cette classe instancie et démarre une instance d&#8217;un <code>JGroupsBindingComponent</code> qui s&#8217;occupe de la couche communication pour récupérer nos stubs du système (ici, ça sera JGroups). Je ne reviendrai pas sur les détails d&#8217;implémentation de cette partie puisque cela a déjà été traité <a href="/2011/02/pour-les-gouverner-tous-partie-23.html">ici</a>.</p>

<p>A noter également que nos stubs seront conservés dans un cache <code>JMXConnectorStubCache</code> qui déclenchera, lorsqu&#8217;un élément (ie. un stub d&#8217;un <code>JMXConnector</code>) sera ajouté ou supprimé, la récupération de nos MBean distant et leur enregistrement au sein du MBeanServer courant (resp. leur suppression).</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kd">public</span> <span class="kd">class</span> <span class="nc">JMXConnectorStubCache</span> <span class="kd">implements</span> <span class="n">Serializable</span> <span class="o">{</span>
</span><span class='line'>
</span><span class='line'> <span class="kd">volatile</span> <span class="kd">private</span> <span class="n">Map</span><span class="o">&lt;</span><span class="n">JManagerAddress</span><span class="o">,</span> <span class="n">JMXConnector</span><span class="o">&gt;</span> <span class="n">connectorsStub</span> <span class="o">=</span> <span class="n">Collections</span><span class="o">.</span><span class="na">synchronizedMap</span><span class="o">(</span><span class="k">new</span> <span class="n">HashMap</span><span class="o">&lt;</span><span class="n">JManagerAddress</span><span class="o">,</span> <span class="n">JMXConnector</span><span class="o">&gt;());</span>
</span><span class='line'>
</span><span class='line'> <span class="kd">synchronized</span> <span class="kd">public</span> <span class="n">Map</span><span class="o">&lt;</span><span class="n">JManagerAddress</span><span class="o">,</span> <span class="n">JMXConnector</span><span class="o">&gt;</span> <span class="n">getValue</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>  <span class="k">return</span> <span class="k">this</span><span class="o">.</span><span class="na">connectorsStub</span><span class="o">;</span>
</span><span class='line'> <span class="o">}</span>
</span><span class='line'>
</span><span class='line'> <span class="kd">synchronized</span> <span class="kd">public</span> <span class="n">JMXConnector</span> <span class="nf">put</span><span class="o">(</span><span class="n">JManagerAddress</span> <span class="n">key</span><span class="o">,</span> <span class="n">JMXConnector</span> <span class="n">value</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>  <span class="n">JMXConnector</span> <span class="n">result</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">connectorsStub</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">key</span><span class="o">,</span> <span class="n">value</span><span class="o">);</span>
</span><span class='line'>  <span class="n">MBeanHandler</span> <span class="n">mBeanHandler</span> <span class="o">=</span> <span class="k">new</span> <span class="n">MBeanHandler</span><span class="o">(</span><span class="n">key</span><span class="o">,</span> <span class="n">value</span><span class="o">);</span>
</span><span class='line'>  <span class="n">mBeanHandler</span><span class="o">.</span><span class="na">handleAdd</span><span class="o">();</span>
</span><span class='line'>  <span class="k">return</span> <span class="n">result</span><span class="o">;</span>
</span><span class='line'> <span class="o">}</span>
</span><span class='line'>
</span><span class='line'> <span class="kd">synchronized</span> <span class="kd">public</span> <span class="n">JMXConnector</span> <span class="nf">remove</span><span class="o">(</span><span class="n">JManagerAddress</span> <span class="n">key</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>  <span class="n">JMXConnector</span> <span class="n">result</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">connectorsStub</span><span class="o">.</span><span class="na">remove</span><span class="o">(</span><span class="n">key</span><span class="o">);</span>
</span><span class='line'>  <span class="n">MBeanHandler</span> <span class="n">mBeanHandler</span> <span class="o">=</span> <span class="k">new</span> <span class="n">MBeanHandler</span><span class="o">(</span><span class="n">key</span><span class="o">,</span> <span class="n">result</span><span class="o">);</span>
</span><span class='line'>  <span class="n">mBeanHandler</span><span class="o">.</span><span class="na">handleRemove</span><span class="o">();</span>
</span><span class='line'>  <span class="k">return</span> <span class="n">result</span><span class="o">;</span>
</span><span class='line'> <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Ce dernier point nous amène au paragraphe suivant, à savoir la récupération des MBeans distants et leur enregistrement.</p>

<h1>Récupération des MBeans distants et enregistrement</h1>

<p>La récupération des MBeans distants est globalement simple et suit le schéma suivant (cet algorithme ne s&#8217;applique pas aux MXBeans) :</p>

<ul>
<li>à partir du <code>JMXConnector</code> client, récupération du <code>MBeanServerConnection</code>,</li>
<li>à partir du <code>MBeanServerConnection</code>, une recherche est lancée sur le <code>MBeanServer</code> distant pour récupérer l&#8217;ensemble des <code>ObjectInstance</code> présenst sur ce dernier,</li>
<li>pour chaque <code>ObjectInstance</code> qui n&#8217;est pas dans le domaine JMX <em>&ldquo;remote&rdquo;</em> (qui sera le domaine utilisé pour stocker les proxy des MBeans distants), création d&#8217;un proxy dynamique représentant l&#8217;objet exposé par le MBean et encapsulation de ce dernier dans la classe <code>MBeanWrapper</code> qui est un <code>DynamicMBean</code>,</li>
<li>enfin enregistrement de chaque <code>DynamicMBean</code> créé dans le <code>MBeanServer</code> local via un <code>ObjectName</code> défini grâce à :

<ul>
<li>ses propriétés,</li>
<li>son domaine JMX distant sous forme de propriété <em>&ldquo;subdomain&rdquo;</em>,</li>
<li>mais également avec une propriété permettant de connaitre la provenance du MBean (propriété qui sera appelée <em>&ldquo;instance&rdquo;</em>).</li>
</ul>
</li>
</ul>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kd">public</span> <span class="kd">class</span> <span class="nc">MBeanHandler</span> <span class="o">{</span>
</span><span class='line'><span class="err"> </span><span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">DOMAIN_REMOTE</span> <span class="o">=</span> <span class="s">&quot;remote&quot;</span><span class="o">;</span>
</span><span class='line'><span class="err"> </span>
</span><span class='line'><span class="err"> </span><span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">Logger</span> <span class="n">LOGGER</span> <span class="o">=</span> <span class="n">LoggerFactory</span><span class="o">.</span><span class="na">getLogger</span><span class="o">(</span><span class="n">MBeanHandler</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
</span><span class='line'><span class="err"> </span>
</span><span class='line'><span class="err"> </span><span class="kd">private</span> <span class="kd">final</span> <span class="n">MBeanServer</span> <span class="n">mbeanServer</span> <span class="o">=</span> <span class="n">ManagementFactory</span><span class="o">.</span><span class="na">getPlatformMBeanServer</span><span class="o">();</span>
</span><span class='line'><span class="err"> </span><span class="kd">private</span> <span class="kd">final</span> <span class="n">JMXConnector</span> <span class="n">connector</span><span class="o">;</span>
</span><span class='line'><span class="err"> </span><span class="kd">private</span> <span class="kd">final</span> <span class="n">JManagerAddress</span> <span class="n">address</span><span class="o">;</span>
</span><span class='line'><span class="err"> </span>
</span><span class='line'><span class="err"> </span><span class="kd">public</span> <span class="n">MBeanHandler</span><span class="o">(</span><span class="kd">final</span> <span class="n">JManagerAddress</span> <span class="n">address</span><span class="o">,</span> <span class="kd">final</span> <span class="n">JMXConnector</span> <span class="n">connector</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'><span class="err">  </span><span class="k">this</span><span class="o">.</span><span class="na">connector</span> <span class="o">=</span> <span class="n">connector</span><span class="o">;</span>
</span><span class='line'><span class="err">  </span><span class="k">this</span><span class="o">.</span><span class="na">address</span> <span class="o">=</span> <span class="n">address</span><span class="o">;</span>
</span><span class='line'><span class="err"> </span><span class="o">}</span>
</span><span class='line'><span class="err"> </span>
</span><span class='line'><span class="err"> </span><span class="kt">void</span> <span class="n">handleAdd</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
</span><span class='line'><span class="err">  </span><span class="k">if</span> <span class="o">(</span><span class="n">connector</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'><span class="err">   </span><span class="n">connector</span><span class="o">.</span><span class="na">connect</span><span class="o">();</span>
</span><span class='line'><span class="err">   </span><span class="n">ObjectName</span> <span class="n">objectName</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ObjectName</span><span class="o">(</span><span class="s">&quot;*:*&quot;</span><span class="o">);</span>
</span><span class='line'><span class="err">   </span><span class="kd">final</span> <span class="n">MBeanServerConnection</span> <span class="n">mBeanServerConnection</span> <span class="o">=</span> <span class="n">connector</span><span class="o">.</span><span class="na">getMBeanServerConnection</span><span class="o">();</span>
</span><span class='line'><span class="err"> </span>
</span><span class='line'><span class="err">   </span><span class="kd">final</span> <span class="n">Set</span><span class="o">&lt;</span><span class="n">ObjectInstance</span><span class="o">&gt;</span> <span class="n">instances</span> <span class="o">=</span> <span class="n">mBeanServerConnection</span><span class="o">.</span><span class="na">queryMBeans</span><span class="o">(</span><span class="n">objectName</span><span class="o">,</span> <span class="kc">null</span><span class="o">);</span>
</span><span class='line'><span class="err"> </span>
</span><span class='line'><span class="err">   </span><span class="k">for</span> <span class="o">(</span><span class="n">ObjectInstance</span> <span class="n">objectInstance</span> <span class="o">:</span> <span class="n">instances</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'><span class="err">    </span><span class="kd">final</span> <span class="n">ObjectName</span> <span class="n">distantObjectName</span> <span class="o">=</span> <span class="n">objectInstance</span><span class="o">.</span><span class="na">getObjectName</span><span class="o">();</span>
</span><span class='line'><span class="err">    </span><span class="k">if</span> <span class="o">(</span><span class="n">DOMAIN_REMOTE</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">distantObjectName</span><span class="o">.</span><span class="na">getDomain</span><span class="o">()))</span> <span class="o">{</span>
</span><span class='line'><span class="err">     </span><span class="k">continue</span><span class="o">;</span>
</span><span class='line'><span class="err">    </span><span class="o">}</span>
</span><span class='line'><span class="err">    </span><span class="kd">final</span> <span class="n">ObjectName</span> <span class="n">newObjectName</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ObjectName</span><span class="o">(</span><span class="n">DOMAIN_REMOTE</span> <span class="o">+</span> <span class="s">&quot;:instance=&quot;</span> <span class="o">+</span> <span class="n">address</span> <span class="o">+</span> <span class="s">&quot;, &quot;</span> <span class="o">+</span> <span class="s">&quot;subdomain=&quot;</span> <span class="o">+</span> <span class="n">distantObjectName</span><span class="o">.</span><span class="na">getDomain</span><span class="o">()</span>
</span><span class='line'><span class="err">      </span><span class="o">+</span> <span class="s">&quot;, &quot;</span> <span class="o">+</span> <span class="n">distantObjectName</span><span class="o">.</span><span class="na">getKeyPropertyListString</span><span class="o">());</span>
</span><span class='line'><span class="err">    </span><span class="kd">final</span> <span class="n">MBeanInfo</span> <span class="n">mBeanInfo</span> <span class="o">=</span> <span class="n">mBeanServerConnection</span><span class="o">.</span><span class="na">getMBeanInfo</span><span class="o">(</span><span class="n">distantObjectName</span><span class="o">);</span>
</span><span class='line'><span class="err">    </span><span class="n">registerRemoteMBean</span><span class="o">(</span><span class="n">mBeanServerConnection</span><span class="o">,</span> <span class="n">distantObjectName</span><span class="o">,</span> <span class="n">newObjectName</span><span class="o">,</span> <span class="n">mBeanInfo</span><span class="o">);</span>
</span><span class='line'><span class="err">   </span><span class="o">}</span>
</span><span class='line'><span class="err">  </span><span class="o">}</span>
</span><span class='line'><span class="err"> </span><span class="o">}</span>
</span><span class='line'><span class="err"> </span>
</span><span class='line'><span class="err"> </span><span class="kd">private</span> <span class="kt">void</span> <span class="n">registerRemoteMBean</span><span class="o">(</span><span class="kd">final</span> <span class="n">MBeanServerConnection</span> <span class="n">mBeanServerConnection</span><span class="o">,</span> <span class="kd">final</span> <span class="n">ObjectName</span> <span class="n">distantObjectName</span><span class="o">,</span> <span class="kd">final</span> <span class="n">ObjectName</span> <span class="n">newObjectName</span><span class="o">,</span>
</span><span class='line'><span class="err">   </span><span class="kd">final</span> <span class="n">MBeanInfo</span> <span class="n">mBeanInfo</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
</span><span class='line'><span class="err">  </span><span class="n">Object</span> <span class="n">mBean</span> <span class="o">=</span> <span class="n">getRemoteMBean</span><span class="o">(</span><span class="n">mBeanServerConnection</span><span class="o">,</span> <span class="n">mBeanInfo</span><span class="o">,</span> <span class="n">distantObjectName</span><span class="o">);</span>
</span><span class='line'><span class="err">  </span><span class="k">if</span> <span class="o">(</span><span class="n">mBean</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'><span class="err">   </span><span class="n">mbeanServer</span><span class="o">.</span><span class="na">registerMBean</span><span class="o">(</span><span class="n">mBean</span><span class="o">,</span> <span class="n">newObjectName</span><span class="o">);</span>
</span><span class='line'><span class="err">  </span><span class="o">}</span>
</span><span class='line'><span class="err"> </span><span class="o">}</span>
</span><span class='line'><span class="err"> </span>
</span><span class='line'><span class="err"> </span><span class="kd">public</span> <span class="n">Object</span> <span class="n">getRemoteMBean</span><span class="o">(</span><span class="kd">final</span> <span class="n">MBeanServerConnection</span> <span class="n">mBeanServerConnection</span><span class="o">,</span> <span class="kd">final</span> <span class="n">MBeanInfo</span> <span class="n">mBeanInfo</span><span class="o">,</span> <span class="kd">final</span> <span class="n">ObjectName</span> <span class="n">distantObjectName</span><span class="o">)</span>
</span><span class='line'><span class="err">   </span><span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
</span><span class='line'><span class="err">  </span><span class="k">if</span> <span class="o">(!</span><span class="n">Boolean</span><span class="o">.</span><span class="na">parseBoolean</span><span class="o">((</span><span class="n">String</span><span class="o">)</span> <span class="n">mBeanInfo</span><span class="o">.</span><span class="na">getDescriptor</span><span class="o">().</span><span class="na">getFieldValue</span><span class="o">(</span><span class="s">&quot;mxbean&quot;</span><span class="o">)))</span> <span class="o">{</span>
</span><span class='line'><span class="err">   </span><span class="n">LOGGER</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">&quot;current mxBeanInfo : {}&quot;</span><span class="o">,</span> <span class="n">mBeanInfo</span><span class="o">);</span>
</span><span class='line'><span class="err">   </span><span class="kd">final</span> <span class="n">Class</span><span class="o">&lt;?&gt;</span> <span class="n">clazz</span> <span class="o">=</span> <span class="n">Class</span><span class="o">.</span><span class="na">forName</span><span class="o">(</span><span class="n">mBeanInfo</span><span class="o">.</span><span class="na">getClassName</span><span class="o">());</span>
</span><span class='line'><span class="err">   </span><span class="kd">final</span> <span class="n">Class</span><span class="o">&lt;?&gt;[]</span> <span class="n">interfazes</span> <span class="o">=</span> <span class="n">clazz</span><span class="o">.</span><span class="na">getInterfaces</span><span class="o">();</span>
</span><span class='line'><span class="err">   </span><span class="k">if</span> <span class="o">(</span><span class="n">interfazes</span><span class="o">.</span><span class="na">length</span> <span class="o">==</span> <span class="mi">1</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'><span class="err">    </span><span class="n">LOGGER</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">&quot;current interface : {}&quot;</span><span class="o">,</span> <span class="n">interfazes</span><span class="o">[</span><span class="mi">0</span><span class="o">]);</span>
</span><span class='line'><span class="err">    </span><span class="kd">final</span> <span class="n">Object</span> <span class="n">proxy</span> <span class="o">=</span> <span class="n">JMX</span><span class="o">.</span><span class="na">newMBeanProxy</span><span class="o">(</span><span class="n">mBeanServerConnection</span><span class="o">,</span> <span class="n">distantObjectName</span><span class="o">,</span> <span class="n">interfazes</span><span class="o">[</span><span class="mi">0</span><span class="o">]);</span>
</span><span class='line'><span class="err">    </span><span class="kd">final</span> <span class="n">MBeanWrapper</span> <span class="n">mBeanWrapper</span> <span class="o">=</span> <span class="k">new</span> <span class="n">MBeanWrapper</span><span class="o">(</span><span class="n">mBeanInfo</span><span class="o">,</span> <span class="n">proxy</span><span class="o">);</span>
</span><span class='line'><span class="err">    </span><span class="k">return</span> <span class="n">mBeanWrapper</span><span class="o">;</span>
</span><span class='line'><span class="err">   </span><span class="o">}</span>
</span><span class='line'><span class="err">  </span><span class="o">}</span>
</span><span class='line'><span class="err">  </span><span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
</span><span class='line'><span class="err"> </span><span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<br/>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
<span class='line-number'>94</span>
<span class='line-number'>95</span>
<span class='line-number'>96</span>
<span class='line-number'>97</span>
<span class='line-number'>98</span>
<span class='line-number'>99</span>
<span class='line-number'>100</span>
<span class='line-number'>101</span>
<span class='line-number'>102</span>
<span class='line-number'>103</span>
<span class='line-number'>104</span>
<span class='line-number'>105</span>
<span class='line-number'>106</span>
<span class='line-number'>107</span>
<span class='line-number'>108</span>
<span class='line-number'>109</span>
<span class='line-number'>110</span>
<span class='line-number'>111</span>
<span class='line-number'>112</span>
<span class='line-number'>113</span>
<span class='line-number'>114</span>
<span class='line-number'>115</span>
<span class='line-number'>116</span>
<span class='line-number'>117</span>
<span class='line-number'>118</span>
<span class='line-number'>119</span>
<span class='line-number'>120</span>
<span class='line-number'>121</span>
<span class='line-number'>122</span>
<span class='line-number'>123</span>
<span class='line-number'>124</span>
<span class='line-number'>125</span>
<span class='line-number'>126</span>
<span class='line-number'>127</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kd">public</span> <span class="kd">class</span> <span class="nc">MBeanWrapper</span> <span class="kd">implements</span> <span class="n">DynamicMBean</span> <span class="o">{</span>
</span><span class='line'>
</span><span class='line'> <span class="kd">static</span> <span class="kd">final</span> <span class="kd">private</span> <span class="n">Logger</span> <span class="n">LOGGER</span> <span class="o">=</span> <span class="n">LoggerFactory</span><span class="o">.</span><span class="na">getLogger</span><span class="o">(</span><span class="n">MBeanWrapper</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
</span><span class='line'>
</span><span class='line'> <span class="kd">private</span> <span class="kd">final</span> <span class="n">MBeanInfo</span> <span class="n">mBeanInfo</span><span class="o">;</span>
</span><span class='line'> <span class="kd">private</span> <span class="kd">final</span> <span class="n">Object</span> <span class="n">proxy</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'> <span class="kd">public</span> <span class="nf">MBeanWrapper</span><span class="o">(</span><span class="kd">final</span> <span class="n">MBeanInfo</span> <span class="n">mBeanInfo</span><span class="o">,</span> <span class="kd">final</span> <span class="n">Object</span> <span class="n">proxy</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>  <span class="k">this</span><span class="o">.</span><span class="na">mBeanInfo</span> <span class="o">=</span> <span class="n">mBeanInfo</span><span class="o">;</span>
</span><span class='line'>  <span class="k">this</span><span class="o">.</span><span class="na">proxy</span> <span class="o">=</span> <span class="n">proxy</span><span class="o">;</span>
</span><span class='line'> <span class="o">}</span>
</span><span class='line'>
</span><span class='line'> <span class="nd">@Override</span>
</span><span class='line'> <span class="kd">public</span> <span class="n">Object</span> <span class="nf">getAttribute</span><span class="o">(</span><span class="n">String</span> <span class="n">attribute</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">AttributeNotFoundException</span><span class="o">,</span> <span class="n">MBeanException</span><span class="o">,</span> <span class="n">ReflectionException</span> <span class="o">{</span>
</span><span class='line'>  <span class="n">MBeanAttributeInfo</span><span class="o">[]</span> <span class="n">mBeanAttributeInfos</span> <span class="o">=</span> <span class="n">mBeanInfo</span><span class="o">.</span><span class="na">getAttributes</span><span class="o">();</span>
</span><span class='line'>  <span class="k">for</span> <span class="o">(</span><span class="n">MBeanAttributeInfo</span> <span class="n">mBeanAttributeInfo</span> <span class="o">:</span> <span class="n">mBeanAttributeInfos</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>   <span class="k">if</span> <span class="o">(</span><span class="n">StringUtils</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">attribute</span><span class="o">,</span> <span class="n">mBeanAttributeInfo</span><span class="o">.</span><span class="na">getName</span><span class="o">()))</span> <span class="o">{</span>
</span><span class='line'>    <span class="k">if</span> <span class="o">(</span><span class="n">mBeanAttributeInfo</span><span class="o">.</span><span class="na">isReadable</span><span class="o">())</span> <span class="o">{</span>
</span><span class='line'>     <span class="k">return</span> <span class="nf">invokeGetter</span><span class="o">(</span><span class="n">attribute</span><span class="o">,</span> <span class="n">mBeanAttributeInfo</span><span class="o">);</span>
</span><span class='line'>    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
</span><span class='line'>     <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>   <span class="o">}</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'>  <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
</span><span class='line'> <span class="o">}</span>
</span><span class='line'>
</span><span class='line'> <span class="n">Object</span> <span class="nf">invokeGetter</span><span class="o">(</span><span class="n">String</span> <span class="n">attribute</span><span class="o">,</span> <span class="n">MBeanAttributeInfo</span> <span class="n">mBeanAttributeInfo</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>  <span class="k">try</span> <span class="o">{</span>
</span><span class='line'>   <span class="n">Method</span> <span class="n">method</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
</span><span class='line'>   <span class="k">if</span> <span class="o">(</span><span class="n">mBeanAttributeInfo</span><span class="o">.</span><span class="na">isIs</span><span class="o">())</span> <span class="o">{</span>
</span><span class='line'>    <span class="n">method</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">proxy</span><span class="o">.</span><span class="na">getClass</span><span class="o">().</span><span class="na">getMethod</span><span class="o">(</span><span class="s">&quot;is&quot;</span> <span class="o">+</span> <span class="n">StringUtils</span><span class="o">.</span><span class="na">capitalize</span><span class="o">(</span><span class="n">attribute</span><span class="o">),</span> <span class="k">new</span> <span class="n">Class</span><span class="o">[</span><span class="mi">0</span><span class="o">]);</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">method</span><span class="o">.</span><span class="na">invoke</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">proxy</span><span class="o">,</span> <span class="k">new</span> <span class="n">Object</span><span class="o">[</span><span class="mi">0</span><span class="o">]);</span>
</span><span class='line'>   <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
</span><span class='line'>    <span class="n">method</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">proxy</span><span class="o">.</span><span class="na">getClass</span><span class="o">().</span><span class="na">getMethod</span><span class="o">(</span><span class="s">&quot;get&quot;</span> <span class="o">+</span> <span class="n">StringUtils</span><span class="o">.</span><span class="na">capitalize</span><span class="o">(</span><span class="n">attribute</span><span class="o">),</span> <span class="k">new</span> <span class="n">Class</span><span class="o">[</span><span class="mi">0</span><span class="o">]);</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">method</span><span class="o">.</span><span class="na">invoke</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">proxy</span><span class="o">,</span> <span class="k">new</span> <span class="n">Object</span><span class="o">[</span><span class="mi">0</span><span class="o">]);</span>
</span><span class='line'>   <span class="o">}</span>
</span><span class='line'>  <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>   <span class="n">LOGGER</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="s">&quot;unable to get remote attribute info {}: {}&quot;</span><span class="o">,</span> <span class="n">attribute</span><span class="o">,</span> <span class="n">e</span><span class="o">);</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'>  <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
</span><span class='line'> <span class="o">}</span>
</span><span class='line'>
</span><span class='line'> <span class="nd">@Override</span>
</span><span class='line'> <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setAttribute</span><span class="o">(</span><span class="n">Attribute</span> <span class="n">attribute</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">AttributeNotFoundException</span><span class="o">,</span> <span class="n">InvalidAttributeValueException</span><span class="o">,</span> <span class="n">MBeanException</span><span class="o">,</span> <span class="n">ReflectionException</span> <span class="o">{</span>
</span><span class='line'>  <span class="n">MBeanAttributeInfo</span><span class="o">[]</span> <span class="n">mBeanAttributeInfos</span> <span class="o">=</span> <span class="n">mBeanInfo</span><span class="o">.</span><span class="na">getAttributes</span><span class="o">();</span>
</span><span class='line'>  <span class="k">for</span> <span class="o">(</span><span class="n">MBeanAttributeInfo</span> <span class="n">mBeanAttributeInfo</span> <span class="o">:</span> <span class="n">mBeanAttributeInfos</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>   <span class="k">if</span> <span class="o">(</span><span class="n">StringUtils</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">attribute</span><span class="o">.</span><span class="na">getName</span><span class="o">(),</span> <span class="n">mBeanAttributeInfo</span><span class="o">.</span><span class="na">getName</span><span class="o">()))</span> <span class="o">{</span>
</span><span class='line'>    <span class="k">if</span> <span class="o">(</span><span class="n">mBeanAttributeInfo</span><span class="o">.</span><span class="na">isWritable</span><span class="o">())</span> <span class="o">{</span>
</span><span class='line'>     <span class="n">invokeSetter</span><span class="o">(</span><span class="n">attribute</span><span class="o">,</span> <span class="n">mBeanAttributeInfo</span><span class="o">);</span>
</span><span class='line'>    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
</span><span class='line'>     <span class="k">return</span><span class="o">;</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>   <span class="o">}</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'>  <span class="k">return</span><span class="o">;</span>
</span><span class='line'> <span class="o">}</span>
</span><span class='line'>
</span><span class='line'> <span class="kt">void</span> <span class="nf">invokeSetter</span><span class="o">(</span><span class="n">Attribute</span> <span class="n">attribute</span><span class="o">,</span> <span class="n">MBeanAttributeInfo</span> <span class="n">mBeanAttributeInfo</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>  <span class="k">try</span> <span class="o">{</span>
</span><span class='line'>   <span class="n">Method</span> <span class="n">method</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
</span><span class='line'>   <span class="k">if</span> <span class="o">(</span><span class="n">mBeanAttributeInfo</span><span class="o">.</span><span class="na">isIs</span><span class="o">())</span> <span class="o">{</span>
</span><span class='line'>    <span class="n">method</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">proxy</span><span class="o">.</span><span class="na">getClass</span><span class="o">().</span><span class="na">getMethod</span><span class="o">(</span><span class="s">&quot;set&quot;</span> <span class="o">+</span> <span class="n">StringUtils</span><span class="o">.</span><span class="na">capitalize</span><span class="o">(</span><span class="n">attribute</span><span class="o">.</span><span class="na">getName</span><span class="o">()),</span> <span class="kt">boolean</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
</span><span class='line'>    <span class="n">method</span><span class="o">.</span><span class="na">invoke</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">proxy</span><span class="o">,</span> <span class="n">attribute</span><span class="o">.</span><span class="na">getValue</span><span class="o">());</span>
</span><span class='line'>   <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
</span><span class='line'>    <span class="n">method</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">proxy</span><span class="o">.</span><span class="na">getClass</span><span class="o">().</span><span class="na">getMethod</span><span class="o">(</span><span class="s">&quot;set&quot;</span> <span class="o">+</span> <span class="n">StringUtils</span><span class="o">.</span><span class="na">capitalize</span><span class="o">(</span><span class="n">attribute</span><span class="o">.</span><span class="na">getName</span><span class="o">()),</span> <span class="n">attribute</span><span class="o">.</span><span class="na">getValue</span><span class="o">().</span><span class="na">getClass</span><span class="o">());</span>
</span><span class='line'>    <span class="n">method</span><span class="o">.</span><span class="na">invoke</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">proxy</span><span class="o">,</span> <span class="n">attribute</span><span class="o">.</span><span class="na">getValue</span><span class="o">());</span>
</span><span class='line'>   <span class="o">}</span>
</span><span class='line'>  <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>   <span class="n">LOGGER</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="s">&quot;unable to set remote attribute info {}: {}&quot;</span><span class="o">,</span> <span class="n">attribute</span><span class="o">,</span> <span class="n">e</span><span class="o">);</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'> <span class="o">}</span>
</span><span class='line'>
</span><span class='line'> <span class="nd">@Override</span>
</span><span class='line'> <span class="kd">public</span> <span class="n">AttributeList</span> <span class="nf">getAttributes</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">attributes</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>  <span class="n">AttributeList</span> <span class="n">result</span> <span class="o">=</span> <span class="k">new</span> <span class="n">AttributeList</span><span class="o">();</span>
</span><span class='line'>  <span class="k">for</span> <span class="o">(</span><span class="n">String</span> <span class="n">attribute</span> <span class="o">:</span> <span class="n">attributes</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>   <span class="n">Attribute</span> <span class="n">currentAttribute</span><span class="o">;</span>
</span><span class='line'>   <span class="k">try</span> <span class="o">{</span>
</span><span class='line'>    <span class="n">currentAttribute</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Attribute</span><span class="o">(</span><span class="n">attribute</span><span class="o">,</span> <span class="n">getAttribute</span><span class="o">(</span><span class="n">attribute</span><span class="o">));</span>
</span><span class='line'>    <span class="n">result</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">currentAttribute</span><span class="o">);</span>
</span><span class='line'>   <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>    <span class="n">LOGGER</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="s">&quot;unable to get remote attribute info {}: {}&quot;</span><span class="o">,</span> <span class="n">attribute</span><span class="o">,</span> <span class="n">e</span><span class="o">);</span>
</span><span class='line'>   <span class="o">}</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'>  <span class="k">return</span> <span class="n">result</span><span class="o">;</span>
</span><span class='line'> <span class="o">}</span>
</span><span class='line'>
</span><span class='line'> <span class="nd">@Override</span>
</span><span class='line'> <span class="kd">public</span> <span class="n">AttributeList</span> <span class="nf">setAttributes</span><span class="o">(</span><span class="n">AttributeList</span> <span class="n">attributes</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>  <span class="n">AttributeList</span> <span class="n">result</span> <span class="o">=</span> <span class="k">new</span> <span class="n">AttributeList</span><span class="o">();</span>
</span><span class='line'>  <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">attributes</span><span class="o">.</span><span class="na">size</span><span class="o">();</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
</span><span class='line'>   <span class="n">Attribute</span> <span class="n">attribute</span> <span class="o">=</span> <span class="o">(</span><span class="n">Attribute</span><span class="o">)</span> <span class="n">attributes</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">i</span><span class="o">);</span>
</span><span class='line'>   <span class="k">try</span> <span class="o">{</span>
</span><span class='line'>    <span class="n">setAttribute</span><span class="o">(</span><span class="n">attribute</span><span class="o">);</span>
</span><span class='line'>    <span class="n">result</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">attribute</span><span class="o">);</span>
</span><span class='line'>   <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>    <span class="n">LOGGER</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="s">&quot;unable to set remote attribute {}: {}&quot;</span><span class="o">,</span> <span class="n">attribute</span><span class="o">.</span><span class="na">getName</span><span class="o">(),</span> <span class="n">e</span><span class="o">);</span>
</span><span class='line'>   <span class="o">}</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'>  <span class="k">return</span> <span class="n">result</span><span class="o">;</span>
</span><span class='line'> <span class="o">}</span>
</span><span class='line'>
</span><span class='line'> <span class="nd">@Override</span>
</span><span class='line'> <span class="kd">public</span> <span class="n">Object</span> <span class="nf">invoke</span><span class="o">(</span><span class="n">String</span> <span class="n">actionName</span><span class="o">,</span> <span class="n">Object</span><span class="o">[]</span> <span class="n">params</span><span class="o">,</span> <span class="n">String</span><span class="o">[]</span> <span class="n">signature</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">MBeanException</span><span class="o">,</span> <span class="n">ReflectionException</span> <span class="o">{</span>
</span><span class='line'>  <span class="n">Class</span><span class="o">[]</span> <span class="n">paramTypes</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
</span><span class='line'>  <span class="k">if</span> <span class="o">(</span><span class="n">signature</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>   <span class="n">paramTypes</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Class</span><span class="o">[</span><span class="n">signature</span><span class="o">.</span><span class="na">length</span><span class="o">];</span>
</span><span class='line'>   <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">signature</span><span class="o">.</span><span class="na">length</span><span class="o">;</span> <span class="o">++</span><span class="n">i</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>    <span class="n">paramTypes</span><span class="o">[</span><span class="n">i</span><span class="o">]</span> <span class="o">=</span> <span class="n">signature</span><span class="o">[</span><span class="n">i</span><span class="o">].</span><span class="na">getClass</span><span class="o">();</span>
</span><span class='line'>   <span class="o">}</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">try</span> <span class="o">{</span>
</span><span class='line'>   <span class="n">Method</span> <span class="n">method</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">proxy</span><span class="o">.</span><span class="na">getClass</span><span class="o">().</span><span class="na">getMethod</span><span class="o">(</span><span class="n">actionName</span><span class="o">,</span> <span class="n">paramTypes</span><span class="o">);</span>
</span><span class='line'>   <span class="k">return</span> <span class="n">method</span><span class="o">.</span><span class="na">invoke</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">proxy</span><span class="o">,</span> <span class="n">params</span><span class="o">);</span>
</span><span class='line'>  <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>   <span class="n">LOGGER</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="s">&quot;unable to invoke {}: {}&quot;</span><span class="o">,</span> <span class="n">actionName</span><span class="o">,</span> <span class="n">e</span><span class="o">);</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'>  <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
</span><span class='line'> <span class="o">}</span>
</span><span class='line'>
</span><span class='line'> <span class="nd">@Override</span>
</span><span class='line'> <span class="kd">public</span> <span class="n">MBeanInfo</span> <span class="nf">getMBeanInfo</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>  <span class="k">return</span> <span class="k">this</span><span class="o">.</span><span class="na">mBeanInfo</span><span class="o">;</span>
</span><span class='line'> <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>On voit donc que le processus n&#8217;est pas vraiment compliqué. Pour le cas des MXBeans, cela est un peu plus sioux&hellip; mais globalement pas compliqué non plus ;&ndash;)</p>

<p>En effet, plusieurs cas se présentent :</p>

<ul>
<li>Pour les <code>MXBeans</code> de types (type au sens propriété JMX) <strong>Compilation</strong>, <strong>ClassLoading</strong>, <strong>Memory</strong>, <strong>OperationSystem</strong>, <strong>Runtime</strong> et <strong>Threading</strong>, cela ne pose pas de problèmes puisque la spécification JMX nous dit qu&#8217;il n&#8217;y a qu&#8217;un seul MBean de ce type dans le <code>MBeanServer</code> pour domaine <em>java.lang</em>. Dans ce cas, il suffit juste d&#8217;instancier un proxy dynamique du MXBean lui-même et de l&#8217;enregistrer avec le &ldquo;bon&rdquo; <code>ObjectName</code>.</li>
<li>par contre, pour les <code>MXBeans</code> de types <strong>MemoryPool</strong>, <strong>GarbageCollector</strong> et <strong>MemoryManager</strong>, vu qu&#8217;il peut y en avoir plusieurs, une recherche est effectuée (en limitant la recherche aux <code>MBeans</code> voulus bien sûr&hellip;) sur le <code>MBeanServer</code> distant afin d&#8217;obtenir (mais également d&#8217;instancier) le bon type de proxy dynamique mais également les bonnes propriétés sous lequel il est enregistré.</li>
</ul>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kd">final</span> <span class="kd">private</span> <span class="kd">static</span> <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Class</span><span class="o">&lt;?&gt;&gt;</span> <span class="n">MXBEAN_MAP</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HashMap</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Class</span><span class="o">&lt;?&gt;&gt;();</span>
</span><span class='line'><span class="err"> </span><span class="kd">static</span> <span class="o">{</span>
</span><span class='line'><span class="err">  </span><span class="n">MXBEAN_MAP</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">ManagementFactory</span><span class="o">.</span><span class="na">COMPILATION_MXBEAN_NAME</span><span class="o">,</span> <span class="n">CompilationMXBean</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
</span><span class='line'><span class="err">  </span><span class="n">MXBEAN_MAP</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">ManagementFactory</span><span class="o">.</span><span class="na">CLASS_LOADING_MXBEAN_NAME</span><span class="o">,</span> <span class="n">ClassLoadingMXBean</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
</span><span class='line'><span class="err">  </span><span class="n">MXBEAN_MAP</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">ManagementFactory</span><span class="o">.</span><span class="na">MEMORY_MXBEAN_NAME</span><span class="o">,</span> <span class="n">MemoryMXBean</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
</span><span class='line'><span class="err">  </span><span class="n">MXBEAN_MAP</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">ManagementFactory</span><span class="o">.</span><span class="na">OPERATING_SYSTEM_MXBEAN_NAME</span><span class="o">,</span> <span class="n">OperatingSystemMXBean</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
</span><span class='line'><span class="err">  </span><span class="n">MXBEAN_MAP</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">ManagementFactory</span><span class="o">.</span><span class="na">RUNTIME_MXBEAN_NAME</span><span class="o">,</span> <span class="n">RuntimeMXBean</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
</span><span class='line'><span class="err">  </span><span class="n">MXBEAN_MAP</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">ManagementFactory</span><span class="o">.</span><span class="na">THREAD_MXBEAN_NAME</span><span class="o">,</span> <span class="n">ThreadMXBean</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
</span><span class='line'><span class="err">  </span><span class="n">MXBEAN_MAP</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">&quot;java.util.logging:type=Logging&quot;</span><span class="o">,</span> <span class="n">LoggingMXBean</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
</span><span class='line'><span class="err"> </span><span class="o">}</span>
</span><span class='line'><span class="err"> </span>
</span><span class='line'><span class="err"> </span><span class="kd">public</span> <span class="n">RemoteMXBeanHandler</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'><span class="err"> </span><span class="o">}</span>
</span><span class='line'><span class="err"> </span>
</span><span class='line'><span class="err"> </span><span class="kd">public</span> <span class="n">Object</span> <span class="n">getRemoteMBean</span><span class="o">(</span><span class="kd">final</span> <span class="n">MBeanServerConnection</span> <span class="n">mBeanServerConnection</span><span class="o">,</span> <span class="kd">final</span> <span class="n">MBeanInfo</span> <span class="n">mBeanInfo</span><span class="o">,</span> <span class="kd">final</span> <span class="n">ObjectName</span> <span class="n">distantObjectName</span><span class="o">)</span>
</span><span class='line'><span class="err">   </span><span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
</span><span class='line'><span class="err">  </span><span class="k">if</span> <span class="o">(</span><span class="n">Boolean</span><span class="o">.</span><span class="na">parseBoolean</span><span class="o">((</span><span class="n">String</span><span class="o">)</span> <span class="n">mBeanInfo</span><span class="o">.</span><span class="na">getDescriptor</span><span class="o">().</span><span class="na">getFieldValue</span><span class="o">(</span><span class="s">&quot;mxbean&quot;</span><span class="o">)))</span> <span class="o">{</span>
</span><span class='line'><span class="err">   </span><span class="n">LOGGER</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">&quot;current mxBeanInfo : {}&quot;</span><span class="o">,</span> <span class="n">mBeanInfo</span><span class="o">);</span>
</span><span class='line'><span class="err">   </span><span class="n">Object</span> <span class="n">proxy</span> <span class="o">=</span> <span class="n">getMxBeanProxy</span><span class="o">(</span><span class="n">mBeanServerConnection</span><span class="o">,</span> <span class="n">mBeanInfo</span><span class="o">,</span> <span class="n">distantObjectName</span><span class="o">);</span>
</span><span class='line'><span class="err">   </span><span class="k">return</span> <span class="n">proxy</span><span class="o">;</span>
</span><span class='line'><span class="err">  </span><span class="o">}</span>
</span><span class='line'><span class="err">  </span><span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
</span><span class='line'><span class="err"> </span><span class="o">}</span>
</span><span class='line'><span class="err"> </span>
</span><span class='line'><span class="err"> </span><span class="kd">private</span> <span class="n">Object</span> <span class="n">getMxBeanProxy</span><span class="o">(</span><span class="kd">final</span> <span class="n">MBeanServerConnection</span> <span class="n">mBeanServerConnection</span><span class="o">,</span> <span class="kd">final</span> <span class="n">MBeanInfo</span> <span class="n">mBeanInfo</span><span class="o">,</span> <span class="kd">final</span> <span class="n">ObjectName</span> <span class="n">distantObjectName</span><span class="o">)</span>
</span><span class='line'><span class="err">   </span><span class="kd">throws</span> <span class="n">IOException</span> <span class="o">{</span>
</span><span class='line'><span class="err">  </span><span class="n">String</span> <span class="n">distantName</span> <span class="o">=</span> <span class="n">distantObjectName</span><span class="o">.</span><span class="na">toString</span><span class="o">();</span>
</span><span class='line'><span class="err">  </span><span class="kt">int</span> <span class="n">index</span> <span class="o">=</span> <span class="n">distantName</span><span class="o">.</span><span class="na">indexOf</span><span class="o">(</span><span class="s">&quot;,&quot;</span><span class="o">);</span>
</span><span class='line'><span class="err">  </span><span class="n">String</span> <span class="n">substring</span> <span class="o">=</span> <span class="n">distantName</span><span class="o">.</span><span class="na">substring</span><span class="o">(</span><span class="mi">0</span><span class="o">,</span> <span class="o">(</span><span class="n">index</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="o">)</span> <span class="o">?</span> <span class="n">index</span> <span class="o">:</span> <span class="n">distantName</span><span class="o">.</span><span class="na">length</span><span class="o">());</span>
</span><span class='line'><span class="err">  </span><span class="n">Class</span><span class="o">&lt;?&gt;</span> <span class="n">mBeanClass</span> <span class="o">=</span> <span class="n">MXBEAN_MAP</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">substring</span><span class="o">);</span>
</span><span class='line'><span class="err">  </span><span class="k">if</span> <span class="o">(</span><span class="n">mBeanClass</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'><span class="err">   </span><span class="k">return</span> <span class="n">ManagementFactory</span><span class="o">.</span><span class="na">newPlatformMXBeanProxy</span><span class="o">(</span><span class="n">mBeanServerConnection</span><span class="o">,</span> <span class="n">distantName</span><span class="o">,</span> <span class="n">mBeanClass</span><span class="o">);</span>
</span><span class='line'><span class="err">  </span><span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(!</span><span class="n">StringUtils</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">ManagementFactory</span><span class="o">.</span><span class="na">MEMORY_POOL_MXBEAN_DOMAIN_TYPE</span><span class="o">,</span> <span class="n">substring</span><span class="o">)</span>
</span><span class='line'><span class="err">    </span><span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">StringUtils</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">ManagementFactory</span><span class="o">.</span><span class="na">GARBAGE_COLLECTOR_MXBEAN_DOMAIN_TYPE</span><span class="o">,</span> <span class="n">substring</span><span class="o">)</span>
</span><span class='line'><span class="err">    </span><span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">StringUtils</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">ManagementFactory</span><span class="o">.</span><span class="na">MEMORY_MANAGER_MXBEAN_DOMAIN_TYPE</span><span class="o">,</span> <span class="n">substring</span><span class="o">)</span>
</span><span class='line'><span class="err">    </span><span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">StringUtils</span><span class="o">.</span><span class="na">contains</span><span class="o">(</span><span class="n">substring</span><span class="o">,</span> <span class="s">&quot;com.sun.management&quot;</span><span class="o">))</span> <span class="o">{</span>
</span><span class='line'><span class="err">   </span><span class="k">return</span> <span class="n">ManagementFactory</span><span class="o">.</span><span class="na">newPlatformMXBeanProxy</span><span class="o">(</span><span class="n">mBeanServerConnection</span><span class="o">,</span> <span class="n">ManagementFactory</span><span class="o">.</span><span class="na">RUNTIME_MXBEAN_NAME</span><span class="o">,</span> <span class="n">RuntimeMXBean</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
</span><span class='line'><span class="err">  </span><span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
</span><span class='line'><span class="err">   </span><span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
</span><span class='line'><span class="err">  </span><span class="o">}</span>
</span><span class='line'><span class="err"> </span><span class="o">}</span>
</span><span class='line'><span class="err"> </span>
</span><span class='line'><span class="err"> </span><span class="kd">private</span> <span class="kt">void</span> <span class="n">handleSpecificMXBean</span><span class="o">(</span><span class="kd">final</span> <span class="n">MBeanServerConnection</span> <span class="n">mBeanServerConnection</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
</span><span class='line'><span class="err">  </span><span class="c1">// cf. http://download.oracle.com/javase/6/docs/api/</span>
</span><span class='line'><span class="err"> </span>
</span><span class='line'><span class="err">  </span><span class="c1">// traitement particulier pour les MXBeans de type MemoryPoolMXBean</span>
</span><span class='line'><span class="err">  </span><span class="n">registerOtherMxBean</span><span class="o">(</span><span class="n">mBeanServerConnection</span><span class="o">,</span> <span class="n">ManagementFactory</span><span class="o">.</span><span class="na">MEMORY_POOL_MXBEAN_DOMAIN_TYPE</span><span class="o">,</span> <span class="n">MemoryPoolMXBean</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
</span><span class='line'><span class="err">  </span><span class="c1">// traitement particulier pour les MXBeans de type MemoryManagerMXBean</span>
</span><span class='line'><span class="err">  </span><span class="n">registerOtherMxBean</span><span class="o">(</span><span class="n">mBeanServerConnection</span><span class="o">,</span> <span class="n">ManagementFactory</span><span class="o">.</span><span class="na">MEMORY_MANAGER_MXBEAN_DOMAIN_TYPE</span><span class="o">,</span> <span class="n">MemoryManagerMXBean</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
</span><span class='line'><span class="err">  </span><span class="c1">// traitement particulier pour les MXBeans de type GarbageCollector</span>
</span><span class='line'><span class="err">  </span><span class="n">registerOtherMxBean</span><span class="o">(</span><span class="n">mBeanServerConnection</span><span class="o">,</span> <span class="n">ManagementFactory</span><span class="o">.</span><span class="na">GARBAGE_COLLECTOR_MXBEAN_DOMAIN_TYPE</span><span class="o">,</span> <span class="n">GarbageCollectorMXBean</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
</span><span class='line'><span class="err"> </span>
</span><span class='line'><span class="err">  </span><span class="c1">// traitement particulier pour les MXBeans de type Hotspot</span>
</span><span class='line'><span class="err">  </span><span class="n">registerOtherMxBean</span><span class="o">(</span><span class="n">mBeanServerConnection</span><span class="o">,</span> <span class="s">&quot;com.sun.management:type=HotSpotDiagnostic&quot;</span><span class="o">,</span> <span class="n">HotSpotDiagnosticMXBean</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
</span><span class='line'><span class="err"> </span><span class="o">}</span>
</span><span class='line'><span class="err"> </span>
</span><span class='line'><span class="err"> </span><span class="kd">private</span> <span class="kt">void</span> <span class="n">registerOtherMxBean</span><span class="o">(</span><span class="kd">final</span> <span class="n">MBeanServerConnection</span> <span class="n">mBeanServerConnection</span><span class="o">,</span> <span class="n">String</span> <span class="n">type</span><span class="o">,</span> <span class="n">Class</span><span class="o">&lt;?&gt;</span> <span class="n">clazz</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
</span><span class='line'><span class="err">  </span><span class="kd">final</span> <span class="n">ObjectName</span> <span class="n">requestedObjectName</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ObjectName</span><span class="o">(</span><span class="n">type</span> <span class="o">+</span> <span class="s">&quot;,*&quot;</span><span class="o">);</span>
</span><span class='line'><span class="err">  </span><span class="kd">final</span> <span class="n">Set</span><span class="o">&lt;</span><span class="n">ObjectName</span><span class="o">&gt;</span> <span class="n">objectNames</span> <span class="o">=</span> <span class="n">mBeanServerConnection</span><span class="o">.</span><span class="na">queryNames</span><span class="o">(</span><span class="n">requestedObjectName</span><span class="o">,</span> <span class="kc">null</span><span class="o">);</span>
</span><span class='line'><span class="err">  </span><span class="k">for</span> <span class="o">(</span><span class="n">ObjectName</span> <span class="n">objectName</span> <span class="o">:</span> <span class="n">objectNames</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'><span class="err">   </span><span class="kd">final</span> <span class="n">Object</span> <span class="n">proxy</span> <span class="o">=</span> <span class="n">ManagementFactory</span><span class="o">.</span><span class="na">newPlatformMXBeanProxy</span><span class="o">(</span><span class="n">mBeanServerConnection</span><span class="o">,</span> <span class="n">objectName</span><span class="o">.</span><span class="na">getCanonicalName</span><span class="o">(),</span> <span class="n">clazz</span><span class="o">);</span>
</span><span class='line'><span class="err">   </span><span class="kd">final</span> <span class="n">ObjectName</span> <span class="n">newObjectName</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ObjectName</span><span class="o">(</span><span class="s">&quot;remote:instance=&quot;</span> <span class="o">+</span> <span class="n">address</span> <span class="o">+</span> <span class="s">&quot;, &quot;</span> <span class="o">+</span> <span class="s">&quot;subdomain=&quot;</span> <span class="o">+</span> <span class="n">objectName</span><span class="o">.</span><span class="na">getDomain</span><span class="o">()</span> <span class="o">+</span> <span class="s">&quot;, &quot;</span>
</span><span class='line'><span class="err">     </span><span class="o">+</span> <span class="n">objectName</span><span class="o">.</span><span class="na">getKeyPropertyListString</span><span class="o">());</span>
</span><span class='line'><span class="err">   </span><span class="n">mbeanServer</span><span class="o">.</span><span class="na">registerMBean</span><span class="o">(</span><span class="n">proxy</span><span class="o">,</span> <span class="n">newObjectName</span><span class="o">);</span>
</span><span class='line'><span class="err">  </span><span class="o">}</span>
</span><span class='line'><span class="err"> </span><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Pour le cas particulier du <code>MXBean HotspotDiagnostic</code>, je vous laisse le soin de jeter un oeil sur le code&hellip; ;&ndash;)</p>

<h1>Désenregistrement d&#8217;une instance (et donc de ses MBeans associés)</h1>

<p>Bien entendu, si une instance venait à disparaitre, il est nécessaire de désenregistrer ses <code>MBeans</code> pour chaque instance de l&#8217;application encore présente.</p>

<p>Là encore, la principe est ultra-simple puisqu&#8217;il suffit de récupérer l&#8217;ensemble des MBeans qui se trouvent dans le domaine JMX <em>&ldquo;remote&rdquo;</em> (qui pour rappel est le domaine utilisé pour enregistrer tous nos proxy) avec la &ldquo;bonne&rdquo; propriété (à savoir la propriété <code>instance</code> qui doit valoir la valeur de l&#8217;adresse de l&#8217;instance à supprimer) et de les désenregistrer du <code>MBeanServer</code> local.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kt">void</span> <span class="nf">handleRemove</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
</span><span class='line'>  <span class="kd">final</span> <span class="n">ObjectName</span> <span class="n">queryObjectName</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ObjectName</span><span class="o">(</span><span class="n">DOMAIN_REMOTE</span> <span class="o">+</span> <span class="s">&quot;:instance=&quot;</span> <span class="o">+</span> <span class="n">address</span> <span class="o">+</span> <span class="s">&quot;,*&quot;</span><span class="o">);</span>
</span><span class='line'>  <span class="kd">final</span> <span class="n">Set</span><span class="o">&lt;</span><span class="n">ObjectName</span><span class="o">&gt;</span> <span class="n">objectNames</span> <span class="o">=</span> <span class="n">mbeanServer</span><span class="o">.</span><span class="na">queryNames</span><span class="o">(</span><span class="n">queryObjectName</span><span class="o">,</span> <span class="kc">null</span><span class="o">);</span>
</span><span class='line'>  <span class="k">for</span> <span class="o">(</span><span class="n">ObjectName</span> <span class="n">objectName</span> <span class="o">:</span> <span class="n">objectNames</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>   <span class="n">LOGGER</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">&quot;remove from mBeanServer objectName : {}&quot;</span><span class="o">,</span> <span class="n">objectName</span><span class="o">);</span>
</span><span class='line'>   <span class="n">mbeanServer</span><span class="o">.</span><span class="na">unregisterMBean</span><span class="o">(</span><span class="n">objectName</span><span class="o">);</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'> <span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<h1>Conclusion</h1>

<p>On a vu tout au long de cette article comment il était possible d&#8217;utiliser JMX coté client (on récupère des <code>MBeans</code> distants) mais également coté serveur (on créé des <code>MBeans</code>). Bien sûr, la couche JGroups n&#8217;est qu&#8217;un prétexte mais je trouvais intéressant de pouvoir s&#8217;appuyer sur ce dernier pour être notifié de changement dans le système. Si je suis motivé, j&#8217;intégrerais peut être une implémentation NoSQL pour stocker et partager les JMXConnector ou un truc du genre&hellip; ;&ndash;)</p>

<p>Par contre, je n&#8217;ai pas testé le comportement dans le cas où des notifications seraient émises&hellip; en outre, si un service de <strong>Relation</strong> JMX était utilisé, je pense que cela pourrait poser quelques soucis&hellip;</p>

<p>A noter que je suis tombé tout récemment sur une <a href="http://blog.infin-it.fr/2010/08/05/aggregateur-jmx-2/">autre solution</a> (que je n&#8217;ai pas testé) qui permet d&#8217;aggréger des informations JMX au sein d&#8217;un même serveur <code>MBeanServer</code>. La cible n&#8217;est pas tout à fait identique mais peut être suffisante pour la plupart des cas&hellip; par contre, il faut aimer Spring&hellip; ;&ndash;)</p>

<h1>Pour aller plus loin&hellip;</h1>

<ul>
<li>Site officiel de JGroups : <a href="http://www.jgroups.org/">http://www.jgroups.org/</a></li>
<li>Wiki de JGroups : <a href="http://community.jboss.org/wiki/JGroups">http://community.jboss.org/wiki/JGroups</a></li>
<li>Site de la JSR 3 &ndash; Java Management Extensions (JMX) Specification : <a href="http://www.jcp.org/en/jsr/detail?id=3">http://www.jcp.org/en/jsr/detail?id=3</a></li>
<li>Site de la JSR 160 &ndash; Java Management Extensions (JMX) Remote API : <a href="http://jcp.org/en/jsr/detail?id=160">http://jcp.org/en/jsr/detail?id=160</a></li>
<li>Site officiel d&#8217;Oracle sur JMX : <a href="http://www.oracle.com/technetwork/java/javase/tech/docs-jsp-135989.html">http://www.oracle.com/technetwork/java/javase/tech/docs-jsp-135989.html</a></li>
</ul>



<footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">Khanh Maudoux</span></span>

      </p>
      <p class="meta">
      








  



<time datetime="2011-02-24T18:49:13+01:00" pubdate data-updated="true">February 24, 2011</time> in 

<span class="categories">
  
    <a class='category' href='/blog/categories/java/'>java</a>, <a class='category' href='/blog/categories/jgroups/'>jgroups</a>, <a class='category' href='/blog/categories/jmx/'>jmx</a>
  
</span>


    </p>
    
      <div class="sharing">
  
  <a href="//twitter.com/share" class="twitter-share-button" data-url="http://blog.jetoile.fr/2011/02/pour-les-gouverner-tous-partie-33.html" data-via="jetoile" data-counturl="http://blog.jetoile.fr/2011/02/pour-les-gouverner-tous-partie-33.html" >Tweet</a>
  
  
  <div class="g-plusone" data-size="medium"></div>
  
  
</div>

    
</footer>

<!--
<section>
<h1>Comments</h1>
<script>
var idcomments_acct = '1a2a89d3b135fb1f774e938fd286d920';
var idcomments_post_id;
var idcomments_post_url;
</script>
<span id="IDCommentsPostTitle" style="display:none"></span>
<script type='text/javascript' src='http://www.intensedebate.com/js/genericCommentWrapperV2.js'></script>

</section>
-->


  <section>
    <h1>Comments</h1>

    <!--
<div id="disqus_thread"></div>
    <script type="text/javascript">
        /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
        var disqus_shortname = 'jetoile'; // required: replace example with your forum shortname

        /* * * DON'T EDIT BELOW THIS LINE * * */
        (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script>
    <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
    <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
    
    <div id="disqus_thread" aria-live="polite"><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
-->

<div id="disqus_thread"></div>
  

<script type="text/javascript">
      var disqus_shortname = 'jetoile';
      
        
        // var disqus_developer = 1;
        var disqus_identifier = 'http://blog.jetoile.fr/2011/02/pour-les-gouverner-tous-partie-33.html';
        var disqus_url = 'http://blog.jetoile.fr/2011/02/pour-les-gouverner-tous-partie-33.html';
        var disqus_script = 'embed.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>


  <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
    <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
    
    <div id="disqus_thread" aria-live="polite"><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>

  </section>


      </div>
    </div>
  </div>



</article>

<hr class="divider-short"/>

<div class="archive-link">
  <div class="container">
    <div class="row">
      <a class="pull-center" href="/" title="Home">Home</a>
    </div>
    <div class="row">
      <div class="col-md-8 col-md-offset-2">
        
          <a class="pull-left" href="/2011/02/pour-les-gouverner-tous-partie-23.html" title="Previous Post: Pour les gouverner tous - partie 2/3">&laquo; Previous: Pour les gouverner tous - partie 2/3</a>
        

        
          <a class="pull-right" href="/2011/03/microbenchmark-mode-d.html" title="Next Post: MicroBenchmark : mode d'emploi">Next: MicroBenchmark : mode d'emploi &raquo;</a>
        
      </div>
    </div>
  </div>
</div>
<script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');</script>
<script type="text/javascript">
  window.___gcfg = {lang: 'fr'};

  (function() {
    var po = document.createElement('script'); po.type = 'text/javascript'; po.async = true;
    po.src = 'https://apis.google.com/js/platform.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(po, s);
  })();
</script>

    <footer id="footer" class="her-row">
  <div class="container">
    <div class="row">
      <div id='footer-shadow'></div>
<!--//please give me a respect for keep these credits line -->
<div class='credits'>
<div align='center'>

<table style="border:none;border-spacing: 20px;border-collapse: separate;">
<tr style="border:none">
<td style="border:none">
<a href="http://twitter.com/jetoile" class="twitter-follow-button" data-show-count="false" data-lang="fr">Follow @jetoile</a>
<script src="http://platform.twitter.com/widgets.js" type="text/javascript"></script>
</td>
<td style="border:none">
<a href="https://plus.google.com/u/0/114765959876500830478/posts?prsrc=3" style="text-decoration: none; color: #333;"><div style="display: inline-block;"><span style="float: left; font: bold 13px/16px arial,sans-serif; margin-right: 4px; margin-top: 7px;">khanh</span><span style="float: left; font: 13px/16px arial,sans-serif; margin-right: 11px; margin-top: 7px;">on</span><div style="float: left;"><img src="/images/gplus-32.png" width="32" height="32" style="border: 0;"/></div><div style="clear: both"></div></div></a>
</td>
<td style="border:none">
<a href="http://fr.linkedin.com/pub/khanh-tuong-maudoux/19/92b/11b"><img src="/images/btn_profile_bluetxt_8
0x15_fr_FR.png" width="80" height="15" border="0" alt="Voir le profil de Khanh Tuong Maudoux sur LinkedIn" /></a>
</td>
</tr>
</table>


<img alt='Jetoile' height='50' src='/images/logoJetoile_v51.png' style='border-width:0; vertical-align: middle' width='180'/>
<p>&#169; 2011 <a href='http://blog.jetoile.fr/'>Je toile ou j* au choix...</a> - Khanh Maudoux</p>
<a href='http://creativecommons.org/licenses/by/4.0/' rel='license'><img alt='Licence Creative Commons' src='/images/creative_common88x31.png' style='border-width:0'/></a> Cette œuvre de <a href='http://blog.jetoile.fr' property='cc:attributionName' rel='cc:attributionURL' xmlns:cc='http://creativecommons.org/ns#'>http://blog.jetoile.fr</a> est mise à disposition selon les termes de la <a href='http://creativecommons.org/licenses/by/4.0/' rel='license'>licence Creative Commons Attribution 4.0 International</a>.
<!--img alt='Creative Commons License' src='http://i.creativecommons.org/l/by/2.0/fr/88x31.png' style='border-width:0; vertical-align: middle;'/> <small>Sauf mention contraire, le contenu de ce blog est mis à disposition selon les termes de la licence <a href='http://creativecommons.org/licenses/by/2.0/fr/'>Creative Commons Attribution 2.0 License</a>.</small-->
<br/>
<small>Powered by <a href="http://octopress.org">Octopress</a><br/>
</small>
</div>
</div>


    </div>
  </div>
</footer>

  </body>
</html>
