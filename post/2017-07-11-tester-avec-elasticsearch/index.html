<!DOCTYPE html>
<html lang="en">

<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="">
  <meta name="generator" content="Hugo 0.83.1" />

  <title>Des tests d&#39;intégration avec Elasticsearch &middot; Jetoile</title>

    

  
  
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/pure/1.0.0/pure-min.css">

  <!--[if lte IE 8]>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/pure/1.0.0/grids-responsive-old-ie-min.css">
  <![endif]-->
  <!--[if gt IE 8]><!-->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/pure/1.0.0/grids-responsive-min.css">
  <!--<![endif]-->

  <!--[if lte IE 8]>
  <link rel="stylesheet" href="https://blog.jetoile.fr/css/side-menu-old-ie.css">
  <![endif]-->
  <!--[if gt IE 8]><!-->
  <link rel="stylesheet" href="https://blog.jetoile.fr/css/side-menu.css">
  <!--<![endif]-->

  <link rel="stylesheet" href="https://blog.jetoile.fr/css/blackburn.css">

  
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.2/css/all.min.css">

  
  <link rel="preconnect" href="https://fonts.gstatic.com">
  <link href="https://fonts.googleapis.com/css2?family=Raleway&display=swap" rel="stylesheet" type="text/css">

  
  <script async src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.9/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

 
  

  
  <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/10.6.0/styles/androidstudio.min.css">
  <script async src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/10.6.0/highlight.min.js"></script>
  
  <script async src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/10.6.0/languages/yaml.min.js"></script>
  
  <script>hljs.initHighlightingOnLoad();</script>
  

  <link rel="shortcut icon" href="https://blog.jetoile.fr/img/favicon.ico" type="image/x-icon" />

  
    
        <link rel="stylesheet" href="https://blog.jetoile.fr/css/my.css">
    
  
  
    
        <script src="https://blog.jetoile.fr/js/my.js"></script>
    
  

</head>


<body>
<div id="layout">

  
<a href="#menu" id="menuLink" class="menu-link">
  
  <span></span>
</a>
<div id="menu">

  
  <a class="pure-menu-heading brand" href="https://blog.jetoile.fr/">Jetoile</a>


  <div class="pure-menu">
    <ul class="pure-menu-list">
      
      
        <li class="pure-menu-item">
          <a class="pure-menu-link" href="https://blog.jetoile.fr/"><i class='fa fa-home fa-fw'></i>Home</a>
      
        </li>
      
      
        <li class="pure-menu-item">
          <a class="pure-menu-link" href="https://blog.jetoile.fr/post"><i class='fa fa-list fa-fw'></i>Posts</a>
      
        </li>
      
      
        <li class="pure-menu-item">
          <a class="pure-menu-link" href="https://blog.jetoile.fr/about"><i class='fa fa-user fa-fw'></i>About</a>
      
        </li>
      
      
        <li class="pure-menu-item">
          <a class="pure-menu-link" href="https://blog.jetoile.fr/contact/"><i class='fa fa-phone fa-fw'></i>Contact</a>
      
        </li>
      
      
        <li class="pure-menu-item">
          <a class="pure-menu-link" href="https://blog.jetoile.fr/hadoop-unit"><i class='fa fa-list fa-fw'></i>Hadoop Unit</a>
      
        </li>
      
    </ul>
  </div>

  <div class="pure-menu social">
  <ul class="pure-menu-list">

    

    

    
    <li class="pure-menu-item">
      <a class="pure-menu-link" href="https://twitter.com/jetoile" rel="me" target="_blank"><i class="fab fa-twitter-square fa-fw"></i>Twitter</a>
    </li>
    

    

    

    

    

    

    

    

    

    

    

    

    

    
    <li class="pure-menu-item">
      <a class="pure-menu-link" href="http://slideshare.net/jetoile" rel="me" target="_blank"><i class="fab fa-slideshare fa-fw"></i>SlideShare</a>
    </li>
    

    

    
    <li class="pure-menu-item">
      <a class="pure-menu-link" href="https://linkedin.com/in/khanh-tuong-maudoux-11b92b19" rel="me" target="_blank"><i class="fab fa-linkedin fa-fw"></i>LinkedIn</a>
    </li>
    

    

    

    

    

    

    
    <li class="pure-menu-item">
      <a class="pure-menu-link" href="https://github.com/jetoile" rel="me" target="_blank"><i class="fab fa-github-square fa-fw"></i>GitHub</a>
    </li>
    

    

    

    

    

    

    

    

    

    

    

    

    

  </ul>
</div>


  <div>
  <div class="small-print">
    <small><a href='http://creativecommons.org/licenses/by/4.0/' rel='license'><img alt='Licence Creative Commons' src='https://blog.jetoile.fr/images/creative_common88x31.png' style='border-width:0'/></a></small>
  </div>
  <div class="small-print">
    <small>Built with&nbsp;<a href="https://gohugo.io/" target="_blank">Hugo</a></small>
    <small>Theme&nbsp;<a href="https://github.com/yoshiharuyamashita/blackburn" target="_blank">Blackburn</a></small>
  </div>
</div>

</div>


  <div id="main">


<div class="header">
  <h1>Des tests d&#39;intégration avec Elasticsearch</h1>
  <h2></h2>
</div>
<div class="content">

  <div class="post-meta">

  <div>
    <i class="fa fa-calendar fa-fw"></i>
    <time>11 Jul 2017</time>
  </div>

  

  

  
  
  
  <div>
    <i class="fa fa-tags fa-fw"></i>
    
      <a class="post-taxonomy-tag" href="https://blog.jetoile.fr/tags/elasticsearch">Elasticsearch</a>&nbsp;&#47;
    
      <a class="post-taxonomy-tag" href="https://blog.jetoile.fr/tags/test">Test</a>
    
  </div>
  
  

</div>

  <p><img src="https://blog.jetoile.fr/images/logo-elastic.png" alt="left-small"> La version 5.0.0-alpha4 a signé la fin du support du mode embedded d&rsquo;Elasticsearch.</p>
<p>Cela a été annoncé <a href="https://www.elastic.co/blog/elasticsearch-the-server#_embedded_elasticsearch_not_supported">là</a> et la classe <code>NodeBuilder</code> permettant de démarrer un noeud programmatiquement a été supprimée.</p>
<p>Cependant, même si la raison de l&rsquo;arrêt du support de ce mode est compréhensible, cela pose le problème des tests d&rsquo;intégration puisqu&rsquo;il n&rsquo;est plus possible de démarrer un Elasticsearch pendant la phase de test.</p>
<p>Oui, Elastic propose officiellement une <a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/testing-framework.html">alternative</a> via l&rsquo;utilisation de ESIntegTestCase mais personnellement, je ne suis pas très fan de cette approche&hellip;</p>
<p>Cet article va tenter de dresser un panorama non exhaustif de ce que j&rsquo;ai pu trouver d&rsquo;intéressant pour permettre de réaliser des tests d&rsquo;intégration avec Elasticsearch.</p>
<p>Parmi les solutions intéressantes et simples que j&rsquo;ai trouvés pour faire des tests d&rsquo;intégration, il y a surtout 2 projets que j&rsquo;ai retenus.</p>
<h1 id="plugin-maven-permettant-de-télécharger-installer-et-démarrer-elasticsearch">Plugin maven permettant de télécharger, installer et démarrer Elasticsearch</h1>
<p>Le premier se trouve être celui de <a href="https://github.com/alexcojocaru/elasticsearch-maven-plugin">alexcojocaru</a>.</p>
<p>Il s&rsquo;agit d&rsquo;un plugin maven s&rsquo;appuyant sur <a href="https://github.com/apache/maven-resolver">maven-resolver</a> qui permet sur les phases de pré-intégration et post-intégration de démarrer et d&rsquo;arrêter Elasticsearch.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-xml" data-lang="xml"><span style="color:#f92672">&lt;plugin&gt;</span>
    <span style="color:#f92672">&lt;groupId&gt;</span>com.github.alexcojocaru<span style="color:#f92672">&lt;/groupId&gt;</span>
    <span style="color:#f92672">&lt;artifactId&gt;</span>elasticsearch-maven-plugin<span style="color:#f92672">&lt;/artifactId&gt;</span>
    <span style="color:#f92672">&lt;version&gt;</span>5.7<span style="color:#f92672">&lt;/version&gt;</span>
    <span style="color:#f92672">&lt;configuration&gt;</span>
        <span style="color:#f92672">&lt;clusterName&gt;</span>elasticsearch<span style="color:#f92672">&lt;/clusterName&gt;</span>
        <span style="color:#f92672">&lt;transportPort&gt;</span>9300<span style="color:#f92672">&lt;/transportPort&gt;</span>
        <span style="color:#f92672">&lt;httpPort&gt;</span>9200<span style="color:#f92672">&lt;/httpPort&gt;</span>
        <span style="color:#f92672">&lt;autoCreateIndex&gt;</span>true<span style="color:#f92672">&lt;/autoCreateIndex&gt;</span>
    <span style="color:#f92672">&lt;/configuration&gt;</span>
    <span style="color:#f92672">&lt;executions&gt;</span>
        <span style="color:#f92672">&lt;execution&gt;</span>
            <span style="color:#f92672">&lt;id&gt;</span>start-elasticsearch<span style="color:#f92672">&lt;/id&gt;</span>
            <span style="color:#f92672">&lt;phase&gt;</span>pre-integration-test<span style="color:#f92672">&lt;/phase&gt;</span>
            <span style="color:#f92672">&lt;goals&gt;</span>
                <span style="color:#f92672">&lt;goal&gt;</span>runforked<span style="color:#f92672">&lt;/goal&gt;</span>
            <span style="color:#f92672">&lt;/goals&gt;</span>
        <span style="color:#f92672">&lt;/execution&gt;</span>
        <span style="color:#f92672">&lt;execution&gt;</span>
            <span style="color:#f92672">&lt;id&gt;</span>stop-elasticsearch<span style="color:#f92672">&lt;/id&gt;</span>
            <span style="color:#f92672">&lt;phase&gt;</span>post-integration-test<span style="color:#f92672">&lt;/phase&gt;</span>
            <span style="color:#f92672">&lt;goals&gt;</span>
                <span style="color:#f92672">&lt;goal&gt;</span>stop<span style="color:#f92672">&lt;/goal&gt;</span>
            <span style="color:#f92672">&lt;/goals&gt;</span>
        <span style="color:#f92672">&lt;/execution&gt;</span>
    <span style="color:#f92672">&lt;/executions&gt;</span>
<span style="color:#f92672">&lt;/plugin&gt;</span>
</code></pre></div><h2 id="exemple">Exemple</h2>
<p>Code java de test :</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">ElasticsearchIntegrationTest</span> <span style="color:#f92672">{</span>

    <span style="color:#a6e22e">@Test</span>
    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">transportClient_should_success</span><span style="color:#f92672">()</span> <span style="color:#66d9ef">throws</span> IOException<span style="color:#f92672">,</span> InterruptedException <span style="color:#f92672">{</span>
        TransportClient client <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> PreBuiltTransportClient<span style="color:#f92672">(</span>Settings<span style="color:#f92672">.</span><span style="color:#a6e22e">EMPTY</span><span style="color:#f92672">)</span>
                <span style="color:#f92672">.</span><span style="color:#a6e22e">addTransportAddress</span><span style="color:#f92672">(</span><span style="color:#66d9ef">new</span> InetSocketTransportAddress<span style="color:#f92672">(</span>InetAddress<span style="color:#f92672">.</span><span style="color:#a6e22e">getByName</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;localhost&#34;</span><span style="color:#f92672">),</span> 9300<span style="color:#f92672">));</span>

        ObjectMapper mapper <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> ObjectMapper<span style="color:#f92672">();</span>

        Sample sample <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> Sample<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;value&#34;</span><span style="color:#f92672">,</span> 0<span style="color:#f92672">.</span><span style="color:#a6e22e">33</span><span style="color:#f92672">,</span> 3<span style="color:#f92672">);</span>

        String jsonString <span style="color:#f92672">=</span> mapper<span style="color:#f92672">.</span><span style="color:#a6e22e">writeValueAsString</span><span style="color:#f92672">(</span>sample<span style="color:#f92672">);</span>

        <span style="color:#75715e">// indexing document
</span><span style="color:#75715e"></span>        IndexResponse ir <span style="color:#f92672">=</span> client<span style="color:#f92672">.</span><span style="color:#a6e22e">prepareIndex</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;test_index&#34;</span><span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;type&#34;</span><span style="color:#f92672">).</span><span style="color:#a6e22e">setSource</span><span style="color:#f92672">(</span>jsonString<span style="color:#f92672">).</span><span style="color:#a6e22e">setId</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;1&#34;</span><span style="color:#f92672">).</span><span style="color:#a6e22e">execute</span><span style="color:#f92672">().</span><span style="color:#a6e22e">actionGet</span><span style="color:#f92672">();</span>
        client<span style="color:#f92672">.</span><span style="color:#a6e22e">admin</span><span style="color:#f92672">().</span><span style="color:#a6e22e">indices</span><span style="color:#f92672">().</span><span style="color:#a6e22e">prepareRefresh</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;test_index&#34;</span><span style="color:#f92672">).</span><span style="color:#a6e22e">execute</span><span style="color:#f92672">().</span><span style="color:#a6e22e">actionGet</span><span style="color:#f92672">();</span>

        assertNotNull<span style="color:#f92672">(</span>ir<span style="color:#f92672">);</span>

        GetResponse gr <span style="color:#f92672">=</span> client<span style="color:#f92672">.</span><span style="color:#a6e22e">prepareGet</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;test_index&#34;</span><span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;type&#34;</span><span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;1&#34;</span><span style="color:#f92672">).</span><span style="color:#a6e22e">execute</span><span style="color:#f92672">().</span><span style="color:#a6e22e">actionGet</span><span style="color:#f92672">();</span>

        assertNotNull<span style="color:#f92672">(</span>gr<span style="color:#f92672">);</span>
        assertEquals<span style="color:#f92672">(</span>gr<span style="color:#f92672">.</span><span style="color:#a6e22e">getSourceAsString</span><span style="color:#f92672">(),</span> <span style="color:#e6db74">&#34;{\&#34;value\&#34;:\&#34;value\&#34;,\&#34;size\&#34;:0.33,\&#34;price\&#34;:3.0}&#34;</span><span style="color:#f92672">);</span>
    <span style="color:#f92672">}</span>

    <span style="color:#a6e22e">@Test</span>
    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">restClient_should_success</span><span style="color:#f92672">()</span> <span style="color:#66d9ef">throws</span> IOException<span style="color:#f92672">,</span> JSONException <span style="color:#f92672">{</span>

        RestClient restClient <span style="color:#f92672">=</span> RestClient<span style="color:#f92672">.</span><span style="color:#a6e22e">builder</span><span style="color:#f92672">(</span>
                <span style="color:#66d9ef">new</span> HttpHost<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;localhost&#34;</span><span style="color:#f92672">,</span> 9200<span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;http&#34;</span><span style="color:#f92672">)).</span><span style="color:#a6e22e">build</span><span style="color:#f92672">();</span>

        org<span style="color:#f92672">.</span><span style="color:#a6e22e">elasticsearch</span><span style="color:#f92672">.</span><span style="color:#a6e22e">client</span><span style="color:#f92672">.</span><span style="color:#a6e22e">Response</span> response <span style="color:#f92672">=</span> restClient<span style="color:#f92672">.</span><span style="color:#a6e22e">performRequest</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;GET&#34;</span><span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;/&#34;</span><span style="color:#f92672">,</span>
                Collections<span style="color:#f92672">.</span><span style="color:#a6e22e">singletonMap</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;pretty&#34;</span><span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;true&#34;</span><span style="color:#f92672">));</span>
        System<span style="color:#f92672">.</span><span style="color:#a6e22e">out</span><span style="color:#f92672">.</span><span style="color:#a6e22e">println</span><span style="color:#f92672">(</span>EntityUtils<span style="color:#f92672">.</span><span style="color:#a6e22e">toString</span><span style="color:#f92672">(</span>response<span style="color:#f92672">.</span><span style="color:#a6e22e">getEntity</span><span style="color:#f92672">()));</span>

        <span style="color:#75715e">// indexing document
</span><span style="color:#75715e"></span>        HttpEntity entity <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> NStringEntity<span style="color:#f92672">(</span>
                <span style="color:#e6db74">&#34;{\n&#34;</span> <span style="color:#f92672">+</span>
                        <span style="color:#e6db74">&#34;    \&#34;user\&#34; : \&#34;kimchy\&#34;,\n&#34;</span> <span style="color:#f92672">+</span>
                        <span style="color:#e6db74">&#34;    \&#34;post_date\&#34; : \&#34;2009-11-15T14:12:12\&#34;,\n&#34;</span> <span style="color:#f92672">+</span>
                        <span style="color:#e6db74">&#34;    \&#34;message\&#34; : \&#34;trying out Elasticsearch\&#34;\n&#34;</span> <span style="color:#f92672">+</span>
                        <span style="color:#e6db74">&#34;}&#34;</span><span style="color:#f92672">,</span> ContentType<span style="color:#f92672">.</span><span style="color:#a6e22e">APPLICATION_JSON</span><span style="color:#f92672">);</span>

        org<span style="color:#f92672">.</span><span style="color:#a6e22e">elasticsearch</span><span style="color:#f92672">.</span><span style="color:#a6e22e">client</span><span style="color:#f92672">.</span><span style="color:#a6e22e">Response</span> indexResponse <span style="color:#f92672">=</span> restClient<span style="color:#f92672">.</span><span style="color:#a6e22e">performRequest</span><span style="color:#f92672">(</span>
                <span style="color:#e6db74">&#34;PUT&#34;</span><span style="color:#f92672">,</span>
                <span style="color:#e6db74">&#34;/twitter/tweet/1&#34;</span><span style="color:#f92672">,</span>
                Collections<span style="color:#f92672">.&lt;</span>String<span style="color:#f92672">,</span> String<span style="color:#f92672">&gt;</span>emptyMap<span style="color:#f92672">(),</span>
                entity<span style="color:#f92672">);</span>

        response <span style="color:#f92672">=</span> restClient<span style="color:#f92672">.</span><span style="color:#a6e22e">performRequest</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;GET&#34;</span><span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;/_search&#34;</span><span style="color:#f92672">,</span>
                Collections<span style="color:#f92672">.</span><span style="color:#a6e22e">singletonMap</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;pretty&#34;</span><span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;true&#34;</span><span style="color:#f92672">));</span>

        String result <span style="color:#f92672">=</span> EntityUtils<span style="color:#f92672">.</span><span style="color:#a6e22e">toString</span><span style="color:#f92672">(</span>response<span style="color:#f92672">.</span><span style="color:#a6e22e">getEntity</span><span style="color:#f92672">());</span>
        System<span style="color:#f92672">.</span><span style="color:#a6e22e">out</span><span style="color:#f92672">.</span><span style="color:#a6e22e">println</span><span style="color:#f92672">(</span>result<span style="color:#f92672">);</span>
        JSONObject obj <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> JSONObject<span style="color:#f92672">(</span>result<span style="color:#f92672">);</span>
        <span style="color:#66d9ef">int</span> nbResult <span style="color:#f92672">=</span> obj<span style="color:#f92672">.</span><span style="color:#a6e22e">getJSONObject</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;hits&#34;</span><span style="color:#f92672">).</span><span style="color:#a6e22e">getInt</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;total&#34;</span><span style="color:#f92672">);</span>
        assertThat<span style="color:#f92672">(</span>nbResult<span style="color:#f92672">).</span><span style="color:#a6e22e">isEqualTo</span><span style="color:#f92672">(</span>1<span style="color:#f92672">);</span>

        restClient<span style="color:#f92672">.</span><span style="color:#a6e22e">close</span><span style="color:#f92672">();</span>
    <span style="color:#f92672">}</span>

<span style="color:#f92672">}</span>

<span style="color:#a6e22e">@EqualsAndHashCode</span>
<span style="color:#a6e22e">@Data</span>
<span style="color:#a6e22e">@AllArgsConstructor</span>
<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Sample</span> <span style="color:#66d9ef">implements</span> Serializable <span style="color:#f92672">{</span>
    <span style="color:#66d9ef">private</span> String value<span style="color:#f92672">;</span>
    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">double</span> size<span style="color:#f92672">;</span>
    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">double</span> price<span style="color:#f92672">;</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>Dépendence maven (façon gradle) :</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-plain" data-lang="plain">dependencies {
    compile group: &#39;org.apache.logging.log4j&#39;, name: &#39;log4j-to-slf4j&#39;, version:&#39;2.7&#39;
    compile group: &#39;org.slf4j&#39;, name: &#39;slf4j-api&#39;, version:&#39;1.7.12&#39;
    compile group: &#39;ch.qos.logback&#39;, name: &#39;logback-classic&#39;, version:&#39;1.1.3&#39;
    testCompile group: &#39;org.elasticsearch.client&#39;, name: &#39;transport&#39;, version:&#39;5.4.3&#39;
    testCompile group: &#39;org.elasticsearch.client&#39;, name: &#39;rest&#39;, version:&#39;5.4.3&#39;
    testCompile group: &#39;com.fasterxml.jackson.core&#39;, name: &#39;jackson-core&#39;, version:&#39;2.7.1&#39;
    testCompile group: &#39;com.fasterxml.jackson.core&#39;, name: &#39;jackson-databind&#39;, version:&#39;2.7.1&#39;
    testCompile group: &#39;org.codehaus.jettison&#39;, name: &#39;jettison&#39;, version:&#39;1.3.8&#39;
    testCompile group: &#39;org.assertj&#39;, name: &#39;assertj-core&#39;, version:&#39;3.8.0&#39;
    testCompile group: &#39;junit&#39;, name: &#39;junit&#39;, version:&#39;4.11&#39;
    compile(group: &#39;org.projectlombok&#39;, name: &#39;lombok&#39;, version:&#39;1.16.6&#39;) {
       /* This dependency was originally in the Maven provided scope, but the project was not of type war.
       This behavior is not yet supported by Gradle, so this dependency has been converted to a compile dependency.
       Please review and delete this closure when resolved. */
    }
}
</code></pre></div><p>Plugins maven utilisés :</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-xml" data-lang="xml"><span style="color:#f92672">&lt;plugin&gt;</span>
    <span style="color:#f92672">&lt;artifactId&gt;</span>maven-surefire-plugin<span style="color:#f92672">&lt;/artifactId&gt;</span>
    <span style="color:#f92672">&lt;configuration&gt;</span>
        <span style="color:#f92672">&lt;excludes&gt;</span>
            <span style="color:#f92672">&lt;exclude&gt;</span>**/*IntegrationTest.java<span style="color:#f92672">&lt;/exclude&gt;</span>
        <span style="color:#f92672">&lt;/excludes&gt;</span>
    <span style="color:#f92672">&lt;/configuration&gt;</span>
    <span style="color:#f92672">&lt;executions&gt;</span>
        <span style="color:#f92672">&lt;execution&gt;</span>
            <span style="color:#f92672">&lt;id&gt;</span>integration-test<span style="color:#f92672">&lt;/id&gt;</span>
            <span style="color:#f92672">&lt;goals&gt;</span>
                <span style="color:#f92672">&lt;goal&gt;</span>test<span style="color:#f92672">&lt;/goal&gt;</span>
            <span style="color:#f92672">&lt;/goals&gt;</span>
            <span style="color:#f92672">&lt;phase&gt;</span>integration-test<span style="color:#f92672">&lt;/phase&gt;</span>
            <span style="color:#f92672">&lt;configuration&gt;</span>
                <span style="color:#f92672">&lt;excludes&gt;</span>
                    <span style="color:#f92672">&lt;exclude&gt;</span>none<span style="color:#f92672">&lt;/exclude&gt;</span>
                <span style="color:#f92672">&lt;/excludes&gt;</span>
                <span style="color:#f92672">&lt;includes&gt;</span>
                    <span style="color:#f92672">&lt;include&gt;</span>**/*IntegrationTest.java<span style="color:#f92672">&lt;/include&gt;</span>
                <span style="color:#f92672">&lt;/includes&gt;</span>
            <span style="color:#f92672">&lt;/configuration&gt;</span>
        <span style="color:#f92672">&lt;/execution&gt;</span>
    <span style="color:#f92672">&lt;/executions&gt;</span>
<span style="color:#f92672">&lt;/plugin&gt;</span>

<span style="color:#f92672">&lt;plugin&gt;</span>
    <span style="color:#f92672">&lt;groupId&gt;</span>com.github.alexcojocaru<span style="color:#f92672">&lt;/groupId&gt;</span>
    <span style="color:#f92672">&lt;artifactId&gt;</span>elasticsearch-maven-plugin<span style="color:#f92672">&lt;/artifactId&gt;</span>
    <span style="color:#f92672">&lt;version&gt;</span>5.7<span style="color:#f92672">&lt;/version&gt;</span>
    <span style="color:#f92672">&lt;configuration&gt;</span>
        <span style="color:#f92672">&lt;clusterName&gt;</span>elasticsearch<span style="color:#f92672">&lt;/clusterName&gt;</span>
        <span style="color:#f92672">&lt;transportPort&gt;</span>9300<span style="color:#f92672">&lt;/transportPort&gt;</span>
        <span style="color:#f92672">&lt;httpPort&gt;</span>9200<span style="color:#f92672">&lt;/httpPort&gt;</span>
        <span style="color:#f92672">&lt;autoCreateIndex&gt;</span>true<span style="color:#f92672">&lt;/autoCreateIndex&gt;</span>
    <span style="color:#f92672">&lt;/configuration&gt;</span>
    <span style="color:#f92672">&lt;executions&gt;</span>
        <span style="color:#f92672">&lt;execution&gt;</span>
            <span style="color:#f92672">&lt;id&gt;</span>start-elasticsearch<span style="color:#f92672">&lt;/id&gt;</span>
            <span style="color:#f92672">&lt;phase&gt;</span>pre-integration-test<span style="color:#f92672">&lt;/phase&gt;</span>
            <span style="color:#f92672">&lt;goals&gt;</span>
                <span style="color:#f92672">&lt;goal&gt;</span>runforked<span style="color:#f92672">&lt;/goal&gt;</span>
            <span style="color:#f92672">&lt;/goals&gt;</span>
        <span style="color:#f92672">&lt;/execution&gt;</span>
        <span style="color:#f92672">&lt;execution&gt;</span>
            <span style="color:#f92672">&lt;id&gt;</span>stop-elasticsearch<span style="color:#f92672">&lt;/id&gt;</span>
            <span style="color:#f92672">&lt;phase&gt;</span>post-integration-test<span style="color:#f92672">&lt;/phase&gt;</span>
            <span style="color:#f92672">&lt;goals&gt;</span>
                <span style="color:#f92672">&lt;goal&gt;</span>stop<span style="color:#f92672">&lt;/goal&gt;</span>
            <span style="color:#f92672">&lt;/goals&gt;</span>
        <span style="color:#f92672">&lt;/execution&gt;</span>
    <span style="color:#f92672">&lt;/executions&gt;</span>
<span style="color:#f92672">&lt;/plugin&gt;</span>
</code></pre></div><h1 id="téléchargement-installation-et-démarrage-delasticsearch">Téléchargement, installation et démarrage d&rsquo;Elasticsearch</h1>
<p>Le deuxième projet est celui d'<a href="https://github.com/allegro/embedded-elasticsearch">Allegro Tech</a>.</p>
<p>Contrairement à la solution précédente, ce projet permet programmatiquement de télécharger, installer et démarrer/arrêter Elasticsearch.</p>
<p>En outre, l&rsquo;avantage de cette solution est qu&rsquo;il n&rsquo;est pas nécessaire de configurer la partie test d&rsquo;intégration dans maven. Ainsi, utiliser un autre outils de build est possible.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">final</span> embeddedElastic <span style="color:#f92672">=</span> EmbeddedElastic<span style="color:#f92672">.</span><span style="color:#a6e22e">builder</span><span style="color:#f92672">()</span>
    <span style="color:#f92672">.</span><span style="color:#a6e22e">withElasticVersion</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;5.4.3&#34;</span><span style="color:#f92672">)</span>
    <span style="color:#f92672">.</span><span style="color:#a6e22e">withSetting</span><span style="color:#f92672">(</span>PopularProperties<span style="color:#f92672">.</span><span style="color:#a6e22e">TRANSPORT_TCP_PORT</span><span style="color:#f92672">,</span> 9300<span style="color:#f92672">)</span>
    <span style="color:#f92672">.</span><span style="color:#a6e22e">withSetting</span><span style="color:#f92672">(</span>PopularProperties<span style="color:#f92672">.</span><span style="color:#a6e22e">CLUSTER_NAME</span><span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;elasticsearch&#34;</span><span style="color:#f92672">)</span>
    <span style="color:#f92672">.</span><span style="color:#a6e22e">withPlugin</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;analysis-stempel&#34;</span><span style="color:#f92672">)</span>
    <span style="color:#f92672">.</span><span style="color:#a6e22e">withIndex</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;cars&#34;</span><span style="color:#f92672">,</span> IndexSettings<span style="color:#f92672">.</span><span style="color:#a6e22e">builder</span><span style="color:#f92672">()</span>
        <span style="color:#f92672">.</span><span style="color:#a6e22e">withType</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;car&#34;</span><span style="color:#f92672">,</span> getSystemResourceAsStream<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;car-mapping.json&#34;</span><span style="color:#f92672">))</span>
        <span style="color:#f92672">.</span><span style="color:#a6e22e">build</span><span style="color:#f92672">())</span>
    <span style="color:#f92672">.</span><span style="color:#a6e22e">withIndex</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;books&#34;</span><span style="color:#f92672">,</span> IndexSettings<span style="color:#f92672">.</span><span style="color:#a6e22e">builder</span><span style="color:#f92672">()</span>
        <span style="color:#f92672">.</span><span style="color:#a6e22e">withType</span><span style="color:#f92672">(</span>PAPER_BOOK_INDEX_TYPE<span style="color:#f92672">,</span> getSystemResourceAsStream<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;paper-book-mapping.json&#34;</span><span style="color:#f92672">))</span>
        <span style="color:#f92672">.</span><span style="color:#a6e22e">withType</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;audio_book&#34;</span><span style="color:#f92672">,</span> getSystemResourceAsStream<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;audio-book-mapping.json&#34;</span><span style="color:#f92672">))</span>
        <span style="color:#f92672">.</span><span style="color:#a6e22e">withSettings</span><span style="color:#f92672">(</span>getSystemResourceAsStream<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;elastic-settings.json&#34;</span><span style="color:#f92672">))</span>
        <span style="color:#f92672">.</span><span style="color:#a6e22e">build</span><span style="color:#f92672">())</span>
    <span style="color:#f92672">.</span><span style="color:#a6e22e">build</span><span style="color:#f92672">()</span>
    <span style="color:#f92672">.</span><span style="color:#a6e22e">start</span><span style="color:#f92672">()</span>
</code></pre></div><h1 id="exemple-1">Exemple</h1>
<p>Code java :</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">ElasticsearchTest</span> <span style="color:#f92672">{</span>

    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">static</span> EmbeddedElastic elasticsearchCluster<span style="color:#f92672">;</span>

    <span style="color:#a6e22e">@BeforeClass</span>
    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">setup</span><span style="color:#f92672">()</span> <span style="color:#66d9ef">throws</span> IOException<span style="color:#f92672">,</span> InterruptedException <span style="color:#f92672">{</span>
        elasticsearchCluster <span style="color:#f92672">=</span> EmbeddedElastic<span style="color:#f92672">.</span><span style="color:#a6e22e">builder</span><span style="color:#f92672">()</span>
                <span style="color:#f92672">.</span><span style="color:#a6e22e">withElasticVersion</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;5.4.3&#34;</span><span style="color:#f92672">)</span>
                <span style="color:#f92672">.</span><span style="color:#a6e22e">withSetting</span><span style="color:#f92672">(</span>PopularProperties<span style="color:#f92672">.</span><span style="color:#a6e22e">TRANSPORT_TCP_PORT</span><span style="color:#f92672">,</span> 9300<span style="color:#f92672">)</span>
                <span style="color:#f92672">.</span><span style="color:#a6e22e">withSetting</span><span style="color:#f92672">(</span>PopularProperties<span style="color:#f92672">.</span><span style="color:#a6e22e">HTTP_PORT</span><span style="color:#f92672">,</span> 9200<span style="color:#f92672">)</span>
                <span style="color:#f92672">.</span><span style="color:#a6e22e">withSetting</span><span style="color:#f92672">(</span>PopularProperties<span style="color:#f92672">.</span><span style="color:#a6e22e">CLUSTER_NAME</span><span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;elasticsearch&#34;</span><span style="color:#f92672">)</span>
                <span style="color:#f92672">.</span><span style="color:#a6e22e">withSetting</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;network.host&#34;</span><span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;localhost&#34;</span><span style="color:#f92672">)</span>
                <span style="color:#f92672">.</span><span style="color:#a6e22e">withCleanInstallationDirectoryOnStop</span><span style="color:#f92672">(</span><span style="color:#66d9ef">true</span><span style="color:#f92672">)</span>
                <span style="color:#f92672">.</span><span style="color:#a6e22e">build</span><span style="color:#f92672">()</span>
                <span style="color:#f92672">.</span><span style="color:#a6e22e">start</span><span style="color:#f92672">();</span>
    <span style="color:#f92672">}</span>

    <span style="color:#a6e22e">@AfterClass</span>
    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">teardown</span><span style="color:#f92672">()</span> <span style="color:#66d9ef">throws</span> IOException<span style="color:#f92672">,</span> InterruptedException <span style="color:#f92672">{</span>
        elasticsearchCluster<span style="color:#f92672">.</span><span style="color:#a6e22e">stop</span><span style="color:#f92672">();</span>
    <span style="color:#f92672">}</span>

    <span style="color:#a6e22e">@Test</span>
    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">transportClient_should_success</span><span style="color:#f92672">()</span> <span style="color:#66d9ef">throws</span> IOException<span style="color:#f92672">,</span> InterruptedException <span style="color:#f92672">{</span>
        TransportClient client <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> PreBuiltTransportClient<span style="color:#f92672">(</span>Settings<span style="color:#f92672">.</span><span style="color:#a6e22e">EMPTY</span><span style="color:#f92672">)</span>
                <span style="color:#f92672">.</span><span style="color:#a6e22e">addTransportAddress</span><span style="color:#f92672">(</span><span style="color:#66d9ef">new</span> InetSocketTransportAddress<span style="color:#f92672">(</span>InetAddress<span style="color:#f92672">.</span><span style="color:#a6e22e">getByName</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;localhost&#34;</span><span style="color:#f92672">),</span> 9300<span style="color:#f92672">));</span>

        ObjectMapper mapper <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> ObjectMapper<span style="color:#f92672">();</span>

        Sample sample <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> Sample<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;value&#34;</span><span style="color:#f92672">,</span> 0<span style="color:#f92672">.</span><span style="color:#a6e22e">33</span><span style="color:#f92672">,</span> 3<span style="color:#f92672">);</span>

        String jsonString <span style="color:#f92672">=</span> mapper<span style="color:#f92672">.</span><span style="color:#a6e22e">writeValueAsString</span><span style="color:#f92672">(</span>sample<span style="color:#f92672">);</span>

        <span style="color:#75715e">// indexing document
</span><span style="color:#75715e"></span>        IndexResponse ir <span style="color:#f92672">=</span> client<span style="color:#f92672">.</span><span style="color:#a6e22e">prepareIndex</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;test_index&#34;</span><span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;type&#34;</span><span style="color:#f92672">).</span><span style="color:#a6e22e">setSource</span><span style="color:#f92672">(</span>jsonString<span style="color:#f92672">).</span><span style="color:#a6e22e">setId</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;1&#34;</span><span style="color:#f92672">).</span><span style="color:#a6e22e">execute</span><span style="color:#f92672">().</span><span style="color:#a6e22e">actionGet</span><span style="color:#f92672">();</span>
        client<span style="color:#f92672">.</span><span style="color:#a6e22e">admin</span><span style="color:#f92672">().</span><span style="color:#a6e22e">indices</span><span style="color:#f92672">().</span><span style="color:#a6e22e">prepareRefresh</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;test_index&#34;</span><span style="color:#f92672">).</span><span style="color:#a6e22e">execute</span><span style="color:#f92672">().</span><span style="color:#a6e22e">actionGet</span><span style="color:#f92672">();</span>

        assertNotNull<span style="color:#f92672">(</span>ir<span style="color:#f92672">);</span>

        GetResponse gr <span style="color:#f92672">=</span> client<span style="color:#f92672">.</span><span style="color:#a6e22e">prepareGet</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;test_index&#34;</span><span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;type&#34;</span><span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;1&#34;</span><span style="color:#f92672">).</span><span style="color:#a6e22e">execute</span><span style="color:#f92672">().</span><span style="color:#a6e22e">actionGet</span><span style="color:#f92672">();</span>

        assertNotNull<span style="color:#f92672">(</span>gr<span style="color:#f92672">);</span>
        assertEquals<span style="color:#f92672">(</span>gr<span style="color:#f92672">.</span><span style="color:#a6e22e">getSourceAsString</span><span style="color:#f92672">(),</span> <span style="color:#e6db74">&#34;{\&#34;value\&#34;:\&#34;value\&#34;,\&#34;size\&#34;:0.33,\&#34;price\&#34;:3.0}&#34;</span><span style="color:#f92672">);</span>
    <span style="color:#f92672">}</span>

    <span style="color:#a6e22e">@Test</span>
    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">restClient_should_success</span><span style="color:#f92672">()</span> <span style="color:#66d9ef">throws</span> IOException<span style="color:#f92672">,</span> JSONException <span style="color:#f92672">{</span>

        RestClient restClient <span style="color:#f92672">=</span> RestClient<span style="color:#f92672">.</span><span style="color:#a6e22e">builder</span><span style="color:#f92672">(</span>
                <span style="color:#66d9ef">new</span> HttpHost<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;localhost&#34;</span><span style="color:#f92672">,</span> 9200<span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;http&#34;</span><span style="color:#f92672">)).</span><span style="color:#a6e22e">build</span><span style="color:#f92672">();</span>

        org<span style="color:#f92672">.</span><span style="color:#a6e22e">elasticsearch</span><span style="color:#f92672">.</span><span style="color:#a6e22e">client</span><span style="color:#f92672">.</span><span style="color:#a6e22e">Response</span> response <span style="color:#f92672">=</span> restClient<span style="color:#f92672">.</span><span style="color:#a6e22e">performRequest</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;GET&#34;</span><span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;/&#34;</span><span style="color:#f92672">,</span>
                Collections<span style="color:#f92672">.</span><span style="color:#a6e22e">singletonMap</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;pretty&#34;</span><span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;true&#34;</span><span style="color:#f92672">));</span>
        System<span style="color:#f92672">.</span><span style="color:#a6e22e">out</span><span style="color:#f92672">.</span><span style="color:#a6e22e">println</span><span style="color:#f92672">(</span>EntityUtils<span style="color:#f92672">.</span><span style="color:#a6e22e">toString</span><span style="color:#f92672">(</span>response<span style="color:#f92672">.</span><span style="color:#a6e22e">getEntity</span><span style="color:#f92672">()));</span>

        <span style="color:#75715e">// indexing document
</span><span style="color:#75715e"></span>        HttpEntity entity <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> NStringEntity<span style="color:#f92672">(</span>
                <span style="color:#e6db74">&#34;{\n&#34;</span> <span style="color:#f92672">+</span>
                        <span style="color:#e6db74">&#34;    \&#34;user\&#34; : \&#34;kimchy\&#34;,\n&#34;</span> <span style="color:#f92672">+</span>
                        <span style="color:#e6db74">&#34;    \&#34;post_date\&#34; : \&#34;2009-11-15T14:12:12\&#34;,\n&#34;</span> <span style="color:#f92672">+</span>
                        <span style="color:#e6db74">&#34;    \&#34;message\&#34; : \&#34;trying out Elasticsearch\&#34;\n&#34;</span> <span style="color:#f92672">+</span>
                        <span style="color:#e6db74">&#34;}&#34;</span><span style="color:#f92672">,</span> ContentType<span style="color:#f92672">.</span><span style="color:#a6e22e">APPLICATION_JSON</span><span style="color:#f92672">);</span>

        org<span style="color:#f92672">.</span><span style="color:#a6e22e">elasticsearch</span><span style="color:#f92672">.</span><span style="color:#a6e22e">client</span><span style="color:#f92672">.</span><span style="color:#a6e22e">Response</span> indexResponse <span style="color:#f92672">=</span> restClient<span style="color:#f92672">.</span><span style="color:#a6e22e">performRequest</span><span style="color:#f92672">(</span>
                <span style="color:#e6db74">&#34;PUT&#34;</span><span style="color:#f92672">,</span>
                <span style="color:#e6db74">&#34;/twitter/tweet/1&#34;</span><span style="color:#f92672">,</span>
                Collections<span style="color:#f92672">.&lt;</span>String<span style="color:#f92672">,</span> String<span style="color:#f92672">&gt;</span>emptyMap<span style="color:#f92672">(),</span>
                entity<span style="color:#f92672">);</span>

        response <span style="color:#f92672">=</span> restClient<span style="color:#f92672">.</span><span style="color:#a6e22e">performRequest</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;GET&#34;</span><span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;/_search&#34;</span><span style="color:#f92672">,</span>
                Collections<span style="color:#f92672">.</span><span style="color:#a6e22e">singletonMap</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;pretty&#34;</span><span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;true&#34;</span><span style="color:#f92672">));</span>

        String result <span style="color:#f92672">=</span> EntityUtils<span style="color:#f92672">.</span><span style="color:#a6e22e">toString</span><span style="color:#f92672">(</span>response<span style="color:#f92672">.</span><span style="color:#a6e22e">getEntity</span><span style="color:#f92672">());</span>
        System<span style="color:#f92672">.</span><span style="color:#a6e22e">out</span><span style="color:#f92672">.</span><span style="color:#a6e22e">println</span><span style="color:#f92672">(</span>result<span style="color:#f92672">);</span>
        JSONObject obj <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> JSONObject<span style="color:#f92672">(</span>result<span style="color:#f92672">);</span>
        <span style="color:#66d9ef">int</span> nbResult <span style="color:#f92672">=</span> obj<span style="color:#f92672">.</span><span style="color:#a6e22e">getJSONObject</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;hits&#34;</span><span style="color:#f92672">).</span><span style="color:#a6e22e">getInt</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;total&#34;</span><span style="color:#f92672">);</span>
        assertThat<span style="color:#f92672">(</span>nbResult<span style="color:#f92672">).</span><span style="color:#a6e22e">isEqualTo</span><span style="color:#f92672">(</span>1<span style="color:#f92672">);</span>

        restClient<span style="color:#f92672">.</span><span style="color:#a6e22e">close</span><span style="color:#f92672">();</span>
    <span style="color:#f92672">}</span>

<span style="color:#f92672">}</span>

<span style="color:#a6e22e">@EqualsAndHashCode</span>
<span style="color:#a6e22e">@Data</span>
<span style="color:#a6e22e">@AllArgsConstructor</span>
<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Sample</span> <span style="color:#66d9ef">implements</span> Serializable <span style="color:#f92672">{</span>
    <span style="color:#66d9ef">private</span> String value<span style="color:#f92672">;</span>
    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">double</span> size<span style="color:#f92672">;</span>
    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">double</span> price<span style="color:#f92672">;</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>Dépendence maven (façon gradle) :</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-plain" data-lang="plain">dependencies {
    compile group: &#39;org.apache.logging.log4j&#39;, name: &#39;log4j-to-slf4j&#39;, version:&#39;2.7&#39;
    compile group: &#39;org.slf4j&#39;, name: &#39;slf4j-api&#39;, version:&#39;1.7.12&#39;
    compile group: &#39;ch.qos.logback&#39;, name: &#39;logback-classic&#39;, version:&#39;1.1.3&#39;
    testCompile group: &#39;pl.allegro.tech&#39;, name: &#39;embedded-elasticsearch&#39;, version:&#39;2.2.0&#39;
    testCompile group: &#39;org.elasticsearch.client&#39;, name: &#39;transport&#39;, version:&#39;5.4.3&#39;
    testCompile group: &#39;org.elasticsearch.client&#39;, name: &#39;rest&#39;, version:&#39;5.4.3&#39;
    testCompile group: &#39;com.fasterxml.jackson.core&#39;, name: &#39;jackson-core&#39;, version:&#39;2.7.1&#39;
    testCompile group: &#39;com.fasterxml.jackson.core&#39;, name: &#39;jackson-databind&#39;, version:&#39;2.7.1&#39;
    testCompile group: &#39;org.codehaus.jettison&#39;, name: &#39;jettison&#39;, version:&#39;1.3.8&#39;
    testCompile group: &#39;org.assertj&#39;, name: &#39;assertj-core&#39;, version:&#39;3.8.0&#39;
    testCompile group: &#39;junit&#39;, name: &#39;junit&#39;, version:&#39;4.11&#39;
    compile(group: &#39;org.projectlombok&#39;, name: &#39;lombok&#39;, version:&#39;1.16.6&#39;) {
       /* This dependency was originally in the Maven provided scope, but the project was not of type war.
       This behavior is not yet supported by Gradle, so this dependency has been converted to a compile dependency.
       Please review and delete this closure when resolved. */
    }
</code></pre></div><h1 id="conclusion">Conclusion</h1>
<p>En conclusion, on a pu voir deux solutions qui permettent de faire des tests d&rsquo;intégration avec Elasticsearch.</p>
<p>Personnellement, j&rsquo;ai une préférence pour la deuxième solution qui me permet d&rsquo;avoir la main sur la récupération et installation d&rsquo;Elasticsearch.</p>
<p>Pour aller plus loin, quelques liens en vrac.</p>
<ul>
<li><a href="http://david.pilato.fr/blog/2016/10/18/elasticsearch-real-integration-tests-updated-for-ga/">http://david.pilato.fr/blog/2016/10/18/elasticsearch-real-integration-tests-updated-for-ga/</a></li>
<li><a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/testing-framework.html">https://www.elastic.co/guide/en/elasticsearch/reference/current/testing-framework.html</a></li>
<li><a href="https://gquintana.github.io/2016/11/30/Testing-a-Java-and-Elasticsearch-50-application.html">https://gquintana.github.io/2016/11/30/Testing-a-Java-and-Elasticsearch-50-application.html</a></li>
<li><a href="https://github.com/alexcojocaru/elasticsearch-maven-plugin">https://github.com/alexcojocaru/elasticsearch-maven-plugin</a></li>
<li><a href="https://github.com/allegro/embedded-elasticsearch">https://github.com/allegro/embedded-elasticsearch</a></li>
</ul>
  
  <h4><i class="fas fa-share-alt" aria-hidden="true"></i>&nbsp;Share!</h4>
<ul class="share-buttons">
	<li><a href="https://www.facebook.com/sharer/sharer.php?u=https%3a%2f%2fblog.jetoile.fr%2fpost%2f2017-07-11-tester-avec-elasticsearch%2f" target="_blank" title="Share on Facebook"><i class="fab fa-facebook" aria-hidden="true"></i><span class="sr-only">Share on Facebook</span></a>
	</li>&nbsp;&nbsp;&nbsp;
	<li><a href="https://twitter.com/intent/tweet?source=https%3a%2f%2fblog.jetoile.fr%2fpost%2f2017-07-11-tester-avec-elasticsearch%2f" target="_blank" title="Tweet"><i class="fab fa-twitter" aria-hidden="true"></i><span class="sr-only">Tweet</span></a>
	</li>&nbsp;&nbsp;&nbsp;
	<li><a href="https://plus.google.com/share?url=https%3a%2f%2fblog.jetoile.fr%2fpost%2f2017-07-11-tester-avec-elasticsearch%2f" target="_blank" title="Share on Google+"><i class="fab fa-google-plus" aria-hidden="true"></i><span class="sr-only">Share on Google+</span></a>
	</li>&nbsp;&nbsp;&nbsp;
	<li><a href="http://www.tumblr.com/share?v=3&u=https%3a%2f%2fblog.jetoile.fr%2fpost%2f2017-07-11-tester-avec-elasticsearch%2f" target="_blank" title="Post to Tumblr"><i class="fab fa-tumblr" aria-hidden="true"></i><span class="sr-only">Post to Tumblr</span></a>
	</li>&nbsp;&nbsp;&nbsp;
	<li><a href="http://pinterest.com/pin/create/button/?url=https%3a%2f%2fblog.jetoile.fr%2fpost%2f2017-07-11-tester-avec-elasticsearch%2f" target="_blank" title="Pin it"><i class="fab fa-pinterest-p" aria-hidden="true"></i><span class="sr-only">Pin it</span></a>
	</li>&nbsp;&nbsp;&nbsp;
	<li><a href="http://www.reddit.com/submit?url=https%3a%2f%2fblog.jetoile.fr%2fpost%2f2017-07-11-tester-avec-elasticsearch%2f" target="_blank" title="Submit to Reddit"><i class="fab fa-reddit-alien" aria-hidden="true"></i><span class="sr-only">Submit to Reddit</span></a>
	</li>
</ul>


<style>
	ul.share-buttons{
	  list-style: none;
	  padding: 0;
	}

	ul.share-buttons li{
	  display: inline;
	}

	ul.share-buttons .sr-only{
	  position: absolute;
	  clip: rect(1px 1px 1px 1px);
	  clip: rect(1px, 1px, 1px, 1px);
	  padding: 0;
	  border: 0;
	  height: 1px;
	  width: 1px;
	  overflow: hidden;
	}
</style>


  
<div class="prev-next-post pure-g">
  <div class="pure-u-1-24" style="text-align: left;">
    
    <a href="https://blog.jetoile.fr/post/2016-11-28-sqoop-et-parquet-mode-demploi/"><i class="fa fa-chevron-left"></i></a>
    
  </div>
  <div class="pure-u-10-24">
    
    <nav class="prev">
      <a href="https://blog.jetoile.fr/post/2016-11-28-sqoop-et-parquet-mode-demploi/">Sqoop et Parquet : Mode d&#39;emploi</a>
    </nav>
    
  </div>
  <div class="pure-u-2-24">
    &nbsp;
  </div>
  <div class="pure-u-10-24">
    
    <nav class="next">
      <a href="https://blog.jetoile.fr/post/2017-07-17-tester-avec-redis/">Des tests d&#39;intégration avec Redis</a>
    </nav>
    
  </div>
  <div class="pure-u-1-24" style="text-align: right;">
    
    <a href="https://blog.jetoile.fr/post/2017-07-17-tester-avec-redis/"><i class="fa fa-chevron-right"></i></a>
    
  </div>
</div>


  
  
  
  
<div id="disqus_thread"></div>
<script type="text/javascript">

(function() {
    
    
    if (window.location.hostname == "localhost")
        return;

    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    var disqus_shortname = 'jetoile';
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com/" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>


  

</div>

</div>
</div>
<script src="https://blog.jetoile.fr/js/ui.js"></script>
<script src="https://blog.jetoile.fr/js/menus.js"></script>




<script>
  
  if (window.location.hostname != "localhost") {
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-11955429-1', 'auto');
    ga('send', 'pageview');
  }
</script>





<script src="https://blog.jetoile.fr/js/math-code.js"></script>
  <script async src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/MathJax.js?config=TeX-MML-AM_CHTML"></script>
  


</body>
</html>

