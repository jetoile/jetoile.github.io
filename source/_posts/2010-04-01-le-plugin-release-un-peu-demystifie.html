---
layout: post
title: "Le plugin release (un peu) démystifié"
date: 2010-04-01
comments: false
categories:
 - java
 - maven
---

<div class='post'>
<div xmlns='http://www.w3.org/1999/xhtml'><div style='text-align: justify;'><div style='clear: left; float: left; margin-bottom: 1em; margin-right: 1em;'><img style='max-width: 800px;' src='http://maven.apache.org/images/maven-logo-2.gif'/><br /></div>J'ai déjà longuement parlé de maven 2 dans des posts précédents (<a href='http://jetoile.blogspot.com/2010/03/petites-astuces-avec-maven-2.html'>Petites astuces avec maven 2</a>, <a href='http://jetoile.blogspot.com/2010/02/de-l-du-livrable.html'>De l'art du livrable</a> et  <a href='http://jetoile.blogspot.com/2010/01/retour-sur-la-mise-en-uvre-d_04.html'>Retour sur la mise en œuvre d'un environnement de développement</a>). Ici, je vais revenir sur le plugin <a href='http://maven.apache.org/plugins/maven-release-plugin/'>release</a> en version 2.0 en explicitant ce que font ses goals <i>prepare</i> et <i>perform</i> plus concrètement. <br />En effet, il peut être utile de vouloir savoir quels sont les actions appelées et comment il est possible d'y ajouter son petit grain de sel... ;-)<br />Il est à noter que je ne reviendrai pas sur l'intérêt d'utiliser un tel plugin (ce n'est pas le sujet qui m'intéresse ici et d'autres blogs ou livres le feront mieux que moi) même si je ferai un petite piqure de rappel sur ce qu'il permet.<!-- more --><br /><h1>Plugin release? Quoiqu'il fait?</h1>Le principal intérêt du plugin release est de fournir un processus de livraison reproductible, maitrisé et auto-sufisant en permettant, entre autre, de :<br /><ul><li>vérifier que lors du lancement du processus de génération du livrable, le code est bien conforme à ce qui se trouve sur le SCM,</li><li>tagger le code source à partir duquel le livrable est produit et permettant ainsi sa reproductivité,</li><li>incrémenter le numéro de version des poms,</li><li>générer le livrable (ben oui... ;-) ), <br /></li><li>et le déployer sur le remote proxy repositorie.</li></ul>Pour se faire, il se décompose en 2 phases :<br /><ul><li>la préparation du livrable (<i>mvn release:prepare</i>) qui :</li><ul><li>vérifie que le code local ne diffère pas de ce qui se trouve sur le SCM</li><li>vérifie qu'il n'existe pas de dépendances en version SNAPSHOT (entrainant la non reproductivité du livrable)<br /></li><li>demande à l'utilisateur d'indiquer le numéro de version du livrable à fournir, le nom du tag qui sera posé et la version du numéro de projet à utiliser à la suite de la génération du livrable</li><li>vérifie la conformité du code récupéré du SCM en lançant le goal maven <i>verify</i><br /></li><li>modifie les informations des pom du projet avec le numéro de version du livrable<br /></li><li>commite le projet dans le SCM au tag indiqué<br /></li><li>modifie les informations des pom du projet avec le numéro de version à utiliser à la suite de la génération du livrable</li><li>commite le projet dans le SCM</li><li>prépare la phase suivante en générant le fichier <i>release.properties</i><br /></li></ul><li>la génération du livrable (<i>mvn release:perform</i>) qui :</li><ul><li>checkout le code source du SCM<br /></li><li>génère le livrable, la javadoc et la génération des source puis les déploie dans le remote proxy repository maven</li></ul></ul>Il est également à noter qu'il est possible de l'utiliser pour créer des branches à partir d'un tag donné mais que ce point ne sera pas traité dans cet article.<br /><h1>Et plus concrètement, comment qu'il marche?</h1>En fait, le goal <i>prepare</i> du plugin release dispose d'une liste d'actions qui sont effectuées séquentiellement et où chaque action est associée à une classe se trouvant dans le package org.apache.maven.shared.release.phase :<br /><ul><li><i>check-poms</i> qui appelle la classe CheckPomPhase qui vérifie que le pom déclare bien la balise &lt;developerConnection&gt;, que le repository est bien déclaré et qu'il existe bien au moins un module du projet qui est en version SNAPSHOT, <br /></li><li><i>scm-check-modifications</i> qui appelle la classe ScmCheckModificationsPhase qui vérifie qu'il n'y a pas de modifications locales par rapport à ce qui se trouve sur le SCM, </li><li><i>check-dependency-snapshots</i> qui appelle la classe CheckDependencySnapshotsPhase qui vérifie qu'il n'y a pas de dépendances en SNAPSHOT, </li><li><i>create-backup-poms</i> qui appelle la classe CreateBackupPomsPhase qui créer une sauvegarde des fichiers pom (<i>pom.xml.releaseBackup</i>) après avoir éventuellement supprimé ceux existant, </li><li><i>map-release-versions</i> qui appelle la classe MapVersionsPhase qui demande à l'utilisateur le numéro de version du projet à tagger, </li><li><i>input-variables</i> qui appelle la classe InputVariablesPhase qui calcule, à partir de l'information entrée par l'utilisateur dans la phase précédente, le label à poser et qui la propose à l'utilisateur en lui demandant si cela lui convient. Dans le cas contraire, il peut saisir le tag à poser, </li><li><i>map-development-versions</i> qui appelle la classe MapVersionsPhase qui demande à l'utilisateur le numéro de version à mettre dans les pom pour le trunk ou la branche courante suite à la phase prepare, </li><li><i>rewrite-poms-for-release</i> qui appelle la classe RewritePomsForReleasePhase qui réécrit les poms à la version qui sera taggée, </li><li><i>generate-release-poms</i> qui appelle la classe GenerateReleasePomsPhase, </li><li><i>run-preparation-goals</i> qui appelle la classe RunPrepareGoalsPhase qui appelle les goals maven par défaut (<i>clean</i> et <i>verify</i>) pour vérifier le projet, </li><li><i>scm-commit-release</i> qui appelle la classe ScmCommitPhase qui commite le projet dans le SCM, </li><li><i>scm-tag</i> qui appelle la classe ScmTagPhase qui pose le tag indiqué, </li><li><i>rewrite-poms-for-development</i> qui appelle la classe RewritePomsForDevelopmentPhase qui réécrit les poms avec la version suivante de développement, </li><li><i>remove-release-poms</i> qui appelle la classe RemoveReleasePomsPhase, </li><li><i>scm-commit-development</i> qui appelle la classe ScmCommitPhase qui commite le projet dans le SCM, </li><li><i>end-release</i>  qui appelle la classe EndReleasePhase qui finalise le processus en indiquant dans le fichier <i>release.properties</i> que la dernière phase du cycle s'est bien déroulée.<br /></li></ul>Il est à noter également que chaque action peuple le fichier <i>release.properties</i> qui indique, entre autre, la dernière action qui s'est déroulée sans erreur. <br /><br />Le goal perform dispose, quant à lui, de la liste d'actions suivantes : <br /><ul><li><i>verify-completed-prepare-phases</i> qui appelle la classe CheckCompletedPreparePhasesPhase qui vérifie dans le fichier <i>release.properties</i> que la phase <i>prepare</i> s'est bien déroulée (action effectuée par l'action <i>end-release</i> du goal prepare), </li><li><i>checkout-project-from-scm</i> qui appelle la classe CheckoutProjectFromScm qui checkout le projet du SCM dans le répertoire checkout de target, </li><li><i>run-perform-goals</i> qui appelle la classe RunPerformGoalsPhase qui exécute le goal maven <i>deploy</i> pour déployer le projet dans le repository maven.<br /></li></ul><h1>et sinon, comment qu'on l'utilise?</h1>On a donc vu ce que faisait concrètement le plugin release. Cependant, il peut parfois être utile de redéfinir certaines de ses actions, soit en précisant le profile à utiliser lors de la phase de déploiement (si le plugin <a href='http://maven.apache.org/plugins/maven-assembly-plugin/'>assembly</a> est utilisé par exemple), soit si l'environnement où est effectué le livrable dispose d'une configuration folklorique (oui, oui, c'est possible... :( ).<br />En fait, il est possible de préciser les goals à exécuter lors de l'action <i>run-preparation-goal</i> de la goal <i>prepare</i> (qui, pour rappel, exécute par défaut les goals <i>clean</i> et <i>verify</i>) en configurant le plugin release via la balise &lt;preparationGoals&gt; :<br />exemple :<br /><pre class="brush:xml; wrap-lines: false; auto-links: false">&lt;plugin&gt;<br /> &lt;groupId&gt;org.apache.maven.plugins&lt;/groupId&gt;<br /> &lt;artifactId&gt;maven-release-plugin&lt;/artifactId&gt;<br /> &lt;version&gt;2.0&lt;/version&gt;<br />  &lt;configuration&gt;<br />   &lt;preparationGoals&gt;clean verify -Plivraison&lt;/preparationGoals&gt;<br />   &lt;!-- clean et verify sont les goals de preparations par defaut --&gt;<br />  &lt;/configuration&gt;<br />&lt;/plugin&gt;<br /></pre>De même, il est également possible de préciser le profile à utiliser lors de l'action<i> run-perform-goals</i> de la phase perform via la balise <releaseprofiles><releaseprofiles>.<br />exemple : <br /><pre class="brush:xml; wrap-lines: false; auto-links: false">&lt;plugin&gt;&lt;br /&gt; &lt;groupId&gt;org.apache.maven.plugins&lt;/groupId&gt;&lt;br /&gt; &lt;artifactId&gt;maven-release-plugin&lt;/artifactId&gt;&lt;br /&gt; &lt;version&gt;2.0&lt;/version&gt;&lt;br /&gt;  &lt;configuration&gt;&lt;br /&gt;    &lt;releaseProfiles&gt;livraison&lt;/releaseProfiles&gt;&lt;br /&gt;    &lt;!-- during release:perform, enable livraison profile --&gt;&lt;br /&gt;  &lt;/configuration&gt;&lt;br /&gt;&lt;/plugin&gt;&lt;br /&gt;</pre>En outre, si les sources du projet ainsi que la javadoc ne sont pas désirés dans la phase de déploiement (par exemple à cause de <a href='http://bugs.sun.com/bugdatabase/view_bug.do?bug_id=5101868'>ça</a>), il est possible de positionner <i>useReleaseProfile</i> à <i>false</i> :<br /><pre class="brush:bash; wrap-lines: false; auto-links: false">mvn release:perform -DuseReleaseProfile=false</pre>ou en le configurant dans le pom :<br /></releaseprofiles></releaseprofiles><pre class="brush:xml; wrap-lines: false; auto-links: false">&lt;plugin&gt;&lt;br /&gt; &lt;groupId&gt;org.apache.maven.plugins&lt;/groupId&gt;&lt;br /&gt; &lt;artifactId&gt;maven-release-plugin&lt;/artifactId&gt;&lt;br /&gt; &lt;version&gt;2.0&lt;/version&gt;&lt;br /&gt;  &lt;configuration&gt;&lt;br /&gt;    &lt;useReleaseProfile&gt;false&lt;/useReleaseProfile&gt;&lt;br /&gt;  &lt;/configuration&gt;&lt;br /&gt;&lt;/plugin&gt;</pre><releaseprofiles><releaseprofiles/><h1>Conclusion</h1>Vous l'aurez donc compris, le maven-release-plugin est vraiment un outil puissant qui effectue un certain nombre d'opérations prédéfinis et qui sont généralement faites manuellement par l'utilisateur... Ainsi, il permet de gagner beaucoup de temps.<br />Attention toutefois à ne pas oublier ce qu'il fait. Cela évitera les petites surprises (enfin c'est le cas de tous les outils...) et permettra de le configurer aux petits oignons (par exemple, en utilisant les options disponibles ou un fichier de configuration pour éviter d'avoir un prompt de sa part)... ;-)<br /><br />A noter que certains points n'ont pas été traités dans cet article puisque le plugin release permet également d'effectuer, entre autre, :<br /><ul><li>un rollback en cas, soit d'échec de génération, soit d'anomalies détectées dans le livrable,</li><li>la création de branches permettant ainsi de produire des correctifs sur une version déjà livrée.</li></ul><h1>Pour aller plus loin...</h1><ul><li><b>Apache Maven</b> de N. De Loof, A. Héritier chez Pearson<br /></li><li><b>Better Builds with Maven</b> : <a href='http://repo.exist.com/dist/maestro/1.7.0/BetterBuildsWithMaven.pdf'>http://repo.exist.com/dist/maestro/1.7.0/BetterBuildsWithMaven.pdf</a></li><li> Maven. Definitive Guide : <a href='http://www.sonatype.com/products/maven/documentation/book-defguide'>http://www.sonatype.com/products/maven/documentation/book-defguide</a><br /></li></ul><ul><li>Site de maven : <a href='http://maven.apache.org/'>http://maven.apache.org/</a></li><li>Site du plugin release : <a href='http://maven.apache.org/plugins/maven-release-plugin/'>http://maven.apache.org/plugins/maven-release-plugin/</a></li></ul><releaseprofiles/></releaseprofiles></div></div></div>
<h2>Comments</h2>
<div class='comments'>
<div class='comment'>
<div class='author'>Khanh</div>
<div class='content'>
Salut Cyril.<br />Merci pour le commentaire et merci également pour m&#39;avoir cité dans ton article ;-)<br />Allez, du coup, un peu de pub pour toi ;-) : <br /><a href="http://cyrillakech.blogspot.com/2012/02/release-your-product-with.html" rel="nofollow">http://cyrillakech.blogspot.com/2012/02/release-your-product-with.html</a></div>
</div>
<div class='comment'>
<div class='author'>Cyril Lakech</div>
<div class='content'>
Super complet cet article. Ca fait plaisir de le relire ;)</div>
</div>
</div>
