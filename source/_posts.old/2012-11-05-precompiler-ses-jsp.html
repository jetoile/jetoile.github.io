---
layout: post
title: "Précompiler ses jsp"
date: 2012-11-05
comments: false
categories:
 - java
 - plugin
 - jsp
 - intégration continue
 - ant
 - tomcat
 - maven
---

<div class='post'>
<div class="separator" style="clear: both; text-align: center;"><a href="http://1.bp.blogspot.com/-9Hhc_8qdf1Y/UIhESh6Ls9I/AAAAAAAAAso/2fJIJUvqvIo/s1600/title.png" imageanchor="1" style="clear: left; float: left; margin-bottom: 1em; margin-right: 1em;"><img border="0" height="160" src="http://1.bp.blogspot.com/-9Hhc_8qdf1Y/UIhESh6Ls9I/AAAAAAAAAso/2fJIJUvqvIo/s320/title.png" width="320" /></a></div><div style="text-align: justify;">Parce qu'il est parfois nécessaire de valider ses jsp, cet article fera un petit retour sur comment cela peut être mis en oeuvre.</div><div style="text-align: justify;"><br /></div><div style="text-align: justify;">Oui, je sais, les jsp c'est <i>has been</i> me diront certains... Cependant, il ne faut pas oublier que dans le monde Java, cela reste une des technologies indispensables quelle que soit le framework utilisé (j'entends par là dans le cas où les pages sont rendus dynamiquement par une technologie java).</div><div style="text-align: justify;"><br /></div><div style="text-align: justify;">Ayant eu récemment à intégrer une phase de validation des jsp maintenus principalement par des équipes "front" n'ayant que peu de connaissance en Java, ce rapide retour d'expérience tentera d'exposer les quelques points qui ont pu me poser problème et en l'occurrence les quelques-unes des différentes solutions possibles pour traiter ce point.</div><div style="text-align: justify;"><br /></div><div style="text-align: justify;"><br /></div><div style="text-align: justify;">Aussi, dans une première partie, je présenterai le contexte, pour ensuite aborder trois des solutions possibles (et relativement récentes car il en existe plusieurs dans différentes versions...) pour valider les jsp.</div><!-- more --><br /><br /><h1>Contexte</h1><div style="text-align: justify;">Cette partie présentera le contexte de l'application web où j'ai eu à mettre en oeuvre une validation des jsp. Le but de l'application web étant d'offrir aux utilisateurs un site web, elle disposait de nombreuses pages jsp.</div><div style="text-align: justify;"><br /></div><div style="text-align: justify;">Coté organisation, les équipes étaient divisées en 2 : </div><ul><li style="text-align: justify;">l'équipe Java dont la charge était de fournir toute la partie controleur/modèle ainsi qu'un premier jet de la couche présentation au travers de jsp réduites à leurs plus simples appareils,</li><li style="text-align: justify;">l'équipe front dont la charge était de décorer les pages jsp avec toutes les parties CSS et Javascript.</li></ul><div style="text-align: justify;">Coté technologie, le site tournait sur un Tomcat 6 avec du Java 7. Pour la partie build/packaging, Maven 3 était de la partie et, pour la partie usine logicielle, un serveur Jenkins. </div><div style="text-align: justify;"><br /></div><div style="text-align: justify;">Le site étant assez vieux, il s'appuyait sur un framework de présentation maison ainsi que sur un framework de décoration : <a href="http://wiki.sitemesh.org/display/sitemesh/Home">Sitemesh 2</a>.</div><div style="text-align: justify;"><br /></div><div style="text-align: justify;"><br /></div><div style="text-align: justify;">La partie compilation des jsp ayant pour objectif de prévenir au plus tôt l'équipe de développeurs front de la non conformité (au sens compilation du terme) d'une page jsp, le but était de créer un job Jenkins dont la seule tâche était de compiler les jsp.  </div><div style="text-align: justify;"><br /></div><div style="text-align: justify;">Embarquer les jsp pré-compilés dans le livrable final (ie. le war) n'était donc pas la cible. </div><br /><h1>Mise en oeuvre</h1><h2>jspc-maven-plugin</h2><h3>Mise en oeuvre</h3><div style="text-align: justify;">Dans ma première tentative de mise en oeuvre, j'ai utilisé le goal compile du plugin jspc-maven-plugin pour tomcat6 :</div><div style="text-align: justify;"><br /></div><div style="text-align: justify;"><a href="http://mojo.codehaus.org/jspc-maven-plugin/usage.html">http://mojo.codehaus.org/jspc-maven-plugin/usage.html</a></div><div style="text-align: justify;"><br /></div><div style="text-align: justify;"><a href="http://mojo.codehaus.org/jspc/jspc-maven-plugin/usage.html">http://mojo.codehaus.org/jspc/jspc-maven-plugin/usage.html</a></div><div style="text-align: justify;"><br /></div><div style="text-align: justify;">Rien de bien compliqué si on regarde la documentation officielle puisqu'il n'y a cas déclarer dans le pom les informations suivantes :</div><pre class="brush:xml; wrap-lines: false; auto-links: false">    &lt;profiles&gt;<br />        &lt;profile&gt;<br />            &lt;id&gt;jsp-compile-jspc-maven&lt;/id&gt;<br />            &lt;build&gt;<br />                &lt;plugins&gt;<br />                    &lt;plugin&gt;<br />                        &lt;groupId&gt;org.codehaus.mojo&lt;/groupId&gt;<br />                        &lt;artifactId&gt;jspc-maven-plugin&lt;/artifactId&gt;<br />                        &lt;version&gt;2.0-alpha-3&lt;/version&gt;<br />                        &lt;executions&gt;<br />                            &lt;execution&gt;<br />                                &lt;id&gt;pre-compile-jsp&lt;/id&gt;<br />                                &lt;goals&gt;<br />                                    &lt;goal&gt;compile&lt;/goal&gt;<br />                                &lt;/goals&gt;<br />                                &lt;phase&gt;test&lt;/phase&gt;<br />                                &lt;configuration&gt;<br />                                &lt;/configuration&gt;<br />                            &lt;/execution&gt;<br />                        &lt;/executions&gt;<br />                        &lt;dependencies&gt;<br />                            &lt;dependency&gt;<br />                                &lt;groupId&gt;org.codehaus.mojo.jspc&lt;/groupId&gt;<br />                                &lt;artifactId&gt;jspc-compiler-tomcat6&lt;/artifactId&gt;<br />                                &lt;version&gt;2.0-alpha-3&lt;/version&gt;<br />                            &lt;/dependency&gt;<br /><br />                        &lt;/dependencies&gt;<br />                    &lt;/plugin&gt;<br /><br />                &lt;/plugins&gt;<br />            &lt;/build&gt;<br /><br />        &lt;/profile&gt;<br />        ...<br />    &lt;/profiles&gt;    <br />    ...<br />    &lt;build&gt;<br />        &lt;plugins&gt;<br />        &lt;plugin&gt;<br />            &lt;groupId&gt;org.apache.maven.plugins&lt;/groupId&gt;<br />            &lt;artifactId&gt;maven-compiler-plugin&lt;/artifactId&gt;<br />            &lt;version&gt;2.3.2&lt;/version&gt;<br />            &lt;configuration&gt;<br />                &lt;target&gt;1.7&lt;/target&gt;<br />                &lt;source&gt;1.7&lt;/source&gt;<br />            &lt;/configuration&gt;<br />        &lt;/plugin&gt;<br />        &lt;/plugins&gt;<br />    &lt;/build&gt;<br /><br />    &lt;dependencies&gt;<br />        &lt;dependency&gt;<br />            &lt;groupId&gt;opensymphony&lt;/groupId&gt;<br />            &lt;artifactId&gt;sitemesh&lt;/artifactId&gt;<br />            &lt;version&gt;2.4.2&lt;/version&gt;<br />        &lt;/dependency&gt;<br /><br />        &lt;dependency&gt;<br />            &lt;groupId&gt;jstl&lt;/groupId&gt;<br />            &lt;artifactId&gt;jstl&lt;/artifactId&gt;<br />            &lt;version&gt;1.2&lt;/version&gt;<br />        &lt;/dependency&gt;<br />    &lt;/dependencies&gt;<br /></pre><br /><div style="text-align: justify;">On constate que les dépendances à sitemesh ainsi qu'à la jstl ont été déclaré afin de fournir à la compilation des jsp le nécessaire. De même, il est important de noter que le plugin jspc-maven-plugin doit obligatoirement fournir un jspc-compiler qui est spécifique à la version de tomcat utilisé.</div><div style="text-align: justify;"><br /></div><div style="text-align: justify;">Malheureusement, après un petit coup de :</div><pre class="brush:bash; wrap-lines: false; auto-links: false">mvn test -Pjsp-compile-jspc-maven<br /></pre><br /><div style="text-align: justify;">on peut se rendre compte que, si les jsp contiennent des scritlets avec du code Java 5 telle qu'une petite enum (oui, je sais, les scriptlets c'est mal... mais, dans mon cas, c'était pour tester...), on se fait joliment insulté... : </div><div class="separator" style="clear: both; text-align: center;"><a href="http://2.bp.blogspot.com/-E1qsxbHRQfI/UIgT-ax6M_I/AAAAAAAAArY/p1RBmt2us0o/s1600/error01.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" height="89" src="http://2.bp.blogspot.com/-E1qsxbHRQfI/UIgT-ax6M_I/AAAAAAAAArY/p1RBmt2us0o/s640/error01.png" width="640" /></a></div><br /><div style="text-align: justify;">Après quelques recherches, je suis tombé sur ce lien :</div><div style="text-align: justify;"><a href="http://stackoverflow.com/questions/7156953/maven-jspc-should-use-external-jsp-files">http://stackoverflow.com/questions/7156953/maven-jspc-should-use-external-jsp-files</a></div><div style="text-align: justify;"><br /></div><div style="text-align: justify;">Cool, peut-on se dire, il suffit de mettre la configuration de compilation en 1.5... mais ma cible n'était-elle pas le jdk 1.7?</div><div style="text-align: justify;">Heureusement, le lien suivant semble annoncé que cela a été corrigé...</div><div style="text-align: justify;"><a href="http://jira.codehaus.org/browse/MJSPC-54">http://jira.codehaus.org/browse/MJSPC-54</a></div><div style="text-align: justify;"><br /></div><div style="text-align: justify;">Malheureusement, la version actuelle ne semble pas bénéficier de ces modifications (la alpha-3 date de 2008 et le ticket a été mis à jour en 2012...). Ne reste donc plus qu'à récupérer le code source du svn et à le recompiler... (svn checkout <a href="https://svn.codehaus.org/mojo/trunk/mojo/jspc">https://svn.codehaus.org/mojo/trunk/mojo/jspc</a>).</div><div style="text-align: justify;"><br /></div><div style="text-align: justify;">Donc, après avoir modifié dans mon pom les informations adéquates, je lance la précompilation et là... miracle...!!! Ca marche ;-)</div><div style="text-align: justify;"><br /></div><div style="text-align: justify;">Au final, on aura donc le code suivant :</div><pre class="brush:xml; wrap-lines: false; auto-links: false">    &lt;profiles&gt;<br />        &lt;profile&gt;<br />            &lt;id&gt;jsp-compile-jspc-maven&lt;/id&gt;<br />            &lt;build&gt;<br />                &lt;plugins&gt;<br />                    &lt;plugin&gt;<br />                        &lt;groupId&gt;org.codehaus.mojo&lt;/groupId&gt;<br />                        &lt;artifactId&gt;jspc-maven-plugin&lt;/artifactId&gt;<br />                        &lt;version&gt;2.0-alpha-4-SNAPSHOT&lt;/version&gt;<br />                        &lt;executions&gt;<br />                            &lt;execution&gt;<br />                                &lt;id&gt;pre-compile-jsp&lt;/id&gt;<br />                                &lt;goals&gt;<br />                                    &lt;goal&gt;compile&lt;/goal&gt;<br />                                &lt;/goals&gt;<br />                                &lt;phase&gt;test&lt;/phase&gt;<br />                                &lt;configuration&gt;<br />                                    &lt;source&gt;1.7&lt;/source&gt;<br />                                    &lt;target&gt;1.7&lt;/target&gt;<br />                                &lt;/configuration&gt;<br />                            &lt;/execution&gt;<br />                        &lt;/executions&gt;<br />                        &lt;dependencies&gt;<br />                            &lt;dependency&gt;<br />                                &lt;groupId&gt;org.codehaus.mojo.jspc&lt;/groupId&gt;<br />                                &lt;artifactId&gt;jspc-compiler-tomcat6&lt;/artifactId&gt;<br />                                &lt;version&gt;2.0-alpha-4-SNAPSHOT&lt;/version&gt;<br />                            &lt;/dependency&gt;<br /><br />                        &lt;/dependencies&gt;<br />                    &lt;/plugin&gt;<br /><br />                &lt;/plugins&gt;<br />            &lt;/build&gt;<br /><br />        &lt;/profile&gt;<br />        ...<br />    &lt;/profiles&gt;    <br />    ...<br />    &lt;build&gt;<br />        &lt;plugins&gt;<br />        &lt;plugin&gt;<br />            &lt;groupId&gt;org.apache.maven.plugins&lt;/groupId&gt;<br />            &lt;artifactId&gt;maven-compiler-plugin&lt;/artifactId&gt;<br />            &lt;version&gt;2.3.2&lt;/version&gt;<br />            &lt;configuration&gt;<br />                &lt;target&gt;1.7&lt;/target&gt;<br />                &lt;source&gt;1.7&lt;/source&gt;<br />            &lt;/configuration&gt;<br />        &lt;/plugin&gt;<br />        &lt;/plugins&gt;<br />    &lt;/build&gt;<br /><br />    &lt;dependencies&gt;<br />        &lt;dependency&gt;<br />            &lt;groupId&gt;opensymphony&lt;/groupId&gt;<br />            &lt;artifactId&gt;sitemesh&lt;/artifactId&gt;<br />            &lt;version&gt;2.4.2&lt;/version&gt;<br />        &lt;/dependency&gt;<br /><br />        &lt;dependency&gt;<br />            &lt;groupId&gt;jstl&lt;/groupId&gt;<br />            &lt;artifactId&gt;jstl&lt;/artifactId&gt;<br />            &lt;version&gt;1.2&lt;/version&gt;<br />        &lt;/dependency&gt;<br />    &lt;/dependencies&gt;<br /></pre><br /><h3>Conclusion</h3><div style="text-align: justify;">Au final, ce plugin m'aura bien fait suer (et là, je n'ai fait qu'un rapide condenser de mes recherches et de mes galères - modification des pom en cascade, recherche internet, ...), mais bon... la solution est fonctionnelle même si elle demande une petite recompilation du plugin.</div><div style="text-align: justify;"><br /></div><div style="text-align: justify;">Cependant, le plugin jspc-maven-plugin ne propose pas (si j'ai bien regardé le code source) d'exclure certaines pages de la compilation, chose qui m'était nécessaire... :'(</div><div style="text-align: justify;"><br /></div><div style="text-align: justify;">Du coup, cette solution n'a pas été retenue...</div><br /><h2>jsp-compile-maven-jetty</h2><h3>Mise en oeuvre</h3><div style="text-align: justify;">Dans cette deuxième tentative de mise en oeuvre, j'ai utilisé le goal jspc du plugin jsp-compile-maven-plugin. On peut se demander pourquoi choisir le plugin Jetty alors que la cible était Tomcat. La réponse est que, vu que ce qui m'intéressait était la partie compilation pure et non la partie packaging, cela m'était égal.</div><div style="text-align: justify;">Pour mettre en place, ce plugin, il suffit de suivre la documentation officielle :</div><div style="text-align: justify;"><a href="http://docs.codehaus.org/display/JETTY/Maven+Jetty+Jspc+Plugin">http://docs.codehaus.org/display/JETTY/Maven+Jetty+Jspc+Plugin</a></div><br /><pre class="brush:xml; wrap-lines: false; auto-links: false">    &lt;profiles&gt;<br />        &lt;profile&gt;<br />            &lt;id&gt;jsp-compile-maven-jetty&lt;/id&gt;<br />            &lt;build&gt;<br />                &lt;plugins&gt;<br />                    &lt;plugin&gt;<br />                        &lt;groupId&gt;org.mortbay.jetty&lt;/groupId&gt;<br />                        &lt;artifactId&gt;jetty-jspc-maven-plugin&lt;/artifactId&gt;<br />                        &lt;version&gt;8.1.7.v20120910&lt;/version&gt;<br />                        &lt;executions&gt;<br />                            &lt;execution&gt;<br />                                &lt;id&gt;pre-compile-jsp&lt;/id&gt;<br />                                &lt;goals&gt;<br />                                    &lt;goal&gt;jspc&lt;/goal&gt;<br />                                &lt;/goals&gt;<br />                                &lt;phase&gt;test&lt;/phase&gt;<br />                                &lt;configuration&gt;<br />                                    &lt;includes/&gt;<br />                                    &lt;excludes/&gt;<br />                                    &lt;verbose&gt;true&lt;/verbose&gt;<br />                                &lt;/configuration&gt;<br />                            &lt;/execution&gt;<br />                        &lt;/executions&gt;<br />                    &lt;/plugin&gt;<br /><br />                &lt;/plugins&gt;<br />            &lt;/build&gt;<br /><br />        &lt;/profile&gt;<br />        ...<br />    &lt;/profiles&gt;    <br />    ...<br />    &lt;build&gt;<br />        &lt;plugins&gt;<br />        &lt;plugin&gt;<br />            &lt;groupId&gt;org.apache.maven.plugins&lt;/groupId&gt;<br />            &lt;artifactId&gt;maven-compiler-plugin&lt;/artifactId&gt;<br />            &lt;version&gt;2.3.2&lt;/version&gt;<br />            &lt;configuration&gt;<br />                &lt;target&gt;1.7&lt;/target&gt;<br />                &lt;source&gt;1.7&lt;/source&gt;<br />            &lt;/configuration&gt;<br />        &lt;/plugin&gt;<br />        &lt;/plugins&gt;<br />    &lt;/build&gt;<br /><br />    &lt;dependencies&gt;<br />        &lt;dependency&gt;<br />            &lt;groupId&gt;opensymphony&lt;/groupId&gt;<br />            &lt;artifactId&gt;sitemesh&lt;/artifactId&gt;<br />            &lt;version&gt;2.4.2&lt;/version&gt;<br />        &lt;/dependency&gt;<br /><br />        &lt;dependency&gt;<br />            &lt;groupId&gt;jstl&lt;/groupId&gt;<br />            &lt;artifactId&gt;jstl&lt;/artifactId&gt;<br />            &lt;version&gt;1.2&lt;/version&gt;<br />        &lt;/dependency&gt;<br />    &lt;/dependencies&gt;        <br /></pre><br /><div style="text-align: justify;">Malheureusement, même en épluchant la documentation et le code source, on constate qu'il n'est pas possible de spécifier la version du compilateur.</div><div style="text-align: justify;"><br /></div><div style="text-align: justify;">Aussi, avec mon code de test qui utilise de superbes "switch case" avec des String seulement disponible à partir de Java 7, j'obtiens le résultat suivant :</div><div class="separator" style="clear: both; text-align: center;"><a href="http://2.bp.blogspot.com/-MM9hVOZq5sg/UIgxyuqIjFI/AAAAAAAAAsA/Y_9ELLHlMM0/s1600/error02.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" height="136" src="http://2.bp.blogspot.com/-MM9hVOZq5sg/UIgxyuqIjFI/AAAAAAAAAsA/Y_9ELLHlMM0/s640/error02.png" width="640" /></a></div><br /><div style="text-align: justify;">En effet, après analyses (si je ne me suis pas fourvoyé...), le code source (<a href="git://git.codehaus.org/jetty-project.git">git://git.codehaus.org/jetty-project.git</a>) ne positionne pas le compilerTarget sur JspC et donc, à part hacker le plugin, impossible de surmonter ce manque...</div><div style="text-align: justify;"><br /></div><h3>Conclusion</h3><div style="text-align: justify;">On a vu que le plugin jetty-jspc-maven-plugin était très simple à mettre en oeuvre mais qu'il manquait quelques fonctionnalités comme la possibilité de compiler avec une version supérieure au jdk 1.5.</div><div style="text-align: justify;"><br /></div><div style="text-align: justify;">Du coup, cette solution n'a pas été retenue...</div><br /><h2>Ant</h2><h3>Mise en oeuvre</h3><div style="text-align: justify;">Dans cette troisième tentative de mise en oeuvre, j'ai gentiment suivi les préconisations présentes sur le site de Tomcat pour précompiler les jsp (<a href="http://tomcat.apache.org/tomcat-6.0-doc/jasper-howto.html">http://tomcat.apache.org/tomcat-6.0-doc/jasper-howto.html</a>) :</div><pre class="brush:xml; wrap-lines: false; auto-links: false">    &lt;profiles&gt;<br />        &lt;profile&gt;<br />            &lt;id&gt;jsp-compile-ant&lt;/id&gt;<br />            &lt;build&gt;<br />                &lt;plugins&gt;<br />                    &lt;plugin&gt;<br />                        &lt;groupId&gt;org.apache.maven.plugins&lt;/groupId&gt;<br />                        &lt;artifactId&gt;maven-antrun-plugin&lt;/artifactId&gt;<br />                        &lt;version&gt;1.6&lt;/version&gt;<br />                        &lt;executions&gt;<br />                            &lt;execution&gt;<br />                                &lt;id&gt;pre-compile-jsp&lt;/id&gt;<br />                                &lt;phase&gt;test&lt;/phase&gt;<br />                                &lt;configuration&gt;<br />                                    &lt;target name="pre-compile-jsp"&gt;<br />                                        &lt;property name="maven.dependencies.classpath" refid="maven.test.classpath"/&gt;<br />                                        &lt;ant antfile="${basedir}/build.xml"&gt;<br />                                            &lt;target name="all"/&gt;<br />                                        &lt;/ant&gt;<br />                                    &lt;/target&gt;<br />                                &lt;/configuration&gt;<br />                                &lt;goals&gt;<br />                                    &lt;goal&gt;run&lt;/goal&gt;<br />                                &lt;/goals&gt;<br />                            &lt;/execution&gt;<br />                        &lt;/executions&gt;<br />                        &lt;dependencies&gt;<br />                            &lt;!-- http://docs.codehaus.org/display/MAVENUSER/Running+ant+tasks+that+use+the+JDK --&gt;<br />                            &lt;dependency&gt;<br />                                &lt;groupId&gt;com.sun&lt;/groupId&gt;<br />                                &lt;artifactId&gt;tools&lt;/artifactId&gt;<br />                                &lt;version&gt;1.6.0&lt;/version&gt;<br />                                &lt;scope&gt;system&lt;/scope&gt;<br />                                &lt;systemPath&gt;${java.home}/../lib/tools.jar&lt;/systemPath&gt;<br />                            &lt;/dependency&gt;<br /><br />                            &lt;dependency&gt;<br />                                &lt;groupId&gt;org.apache.tomcat&lt;/groupId&gt;<br />                                &lt;artifactId&gt;jasper&lt;/artifactId&gt;<br />                                &lt;version&gt;6.0.35&lt;/version&gt;<br />                            &lt;/dependency&gt;<br /><br />                            &lt;dependency&gt;<br />                                &lt;groupId&gt;org.apache.tomcat&lt;/groupId&gt;<br />                                &lt;artifactId&gt;jsp-api&lt;/artifactId&gt;<br />                                &lt;version&gt;6.0.35&lt;/version&gt;<br />                            &lt;/dependency&gt;<br /><br />                            &lt;dependency&gt;<br />                                &lt;groupId&gt;jstl&lt;/groupId&gt;<br />                                &lt;artifactId&gt;jstl&lt;/artifactId&gt;<br />                                &lt;version&gt;1.2&lt;/version&gt;<br />                            &lt;/dependency&gt;<br /><br />                            &lt;dependency&gt;<br />                                &lt;groupId&gt;opensymphony&lt;/groupId&gt;<br />                                &lt;artifactId&gt;sitemesh&lt;/artifactId&gt;<br />                                &lt;version&gt;2.4.2&lt;/version&gt;<br />                            &lt;/dependency&gt;<br />                        &lt;/dependencies&gt;<br />                    &lt;/plugin&gt;<br /><br />                &lt;/plugins&gt;<br />            &lt;/build&gt;<br /><br />            &lt;dependencies&gt;<br />                &lt;dependency&gt;<br />                    &lt;groupId&gt;org.apache.tomcat&lt;/groupId&gt;<br />                    &lt;artifactId&gt;jasper&lt;/artifactId&gt;<br />                    &lt;version&gt;6.0.35&lt;/version&gt;<br />                    &lt;scope&gt;test&lt;/scope&gt;<br />                &lt;/dependency&gt;<br /><br />                &lt;dependency&gt;<br />                    &lt;groupId&gt;opensymphony&lt;/groupId&gt;<br />                    &lt;artifactId&gt;sitemesh&lt;/artifactId&gt;<br />                    &lt;version&gt;2.4.2&lt;/version&gt;<br />                    &lt;scope&gt;test&lt;/scope&gt;<br />                &lt;/dependency&gt;<br /><br />            &lt;/dependencies&gt;<br />        &lt;/profile&gt;<br />        ...<br />    &lt;/profiles&gt;    <br />    ...<br />    &lt;build&gt;<br />        &lt;plugins&gt;<br />        &lt;plugin&gt;<br />            &lt;groupId&gt;org.apache.maven.plugins&lt;/groupId&gt;<br />            &lt;artifactId&gt;maven-compiler-plugin&lt;/artifactId&gt;<br />            &lt;version&gt;2.3.2&lt;/version&gt;<br />            &lt;configuration&gt;<br />                &lt;target&gt;1.7&lt;/target&gt;<br />                &lt;source&gt;1.7&lt;/source&gt;<br />            &lt;/configuration&gt;<br />        &lt;/plugin&gt;<br />        &lt;/plugins&gt;<br />    &lt;/build&gt;<br /><br />    &lt;dependencies&gt;<br />        &lt;dependency&gt;<br />            &lt;groupId&gt;opensymphony&lt;/groupId&gt;<br />            &lt;artifactId&gt;sitemesh&lt;/artifactId&gt;<br />            &lt;version&gt;2.4.2&lt;/version&gt;<br />        &lt;/dependency&gt;<br /><br />        &lt;dependency&gt;<br />            &lt;groupId&gt;jstl&lt;/groupId&gt;<br />            &lt;artifactId&gt;jstl&lt;/artifactId&gt;<br />            &lt;version&gt;1.2&lt;/version&gt;<br />        &lt;/dependency&gt;<br />    &lt;/dependencies&gt;        <br /></pre><br />avec le fichier build.xml suivant : <br /><pre class="brush:xml; wrap-lines: false; auto-links: false">&lt;?xml version="1.0" encoding="UTF-8"?&gt;<br /><br />&lt;project name="Webapp Precompilation" default="all" basedir="."&gt;<br /><br /><br />    &lt;property name="webapp.path" value="${basedir}/src/main/webapp" /&gt;<br />    &lt;property name="jsp.dest.compile" value="${basedir}/target/jsp-generated"/&gt;<br />    &lt;property name="jsp.dest" value="${basedir}/target/jsp"/&gt;<br />    &lt;!--&lt;property name="tomcat.home" value="/opt/apache-tomcat-7.0.23"/&gt;--&gt;<br />    &lt;property name="tomcat.home" value="/usr/local/tomcat60"/&gt;<br /><br />    &lt;import file="${tomcat.home}/bin/catalina-tasks.xml"/&gt;<br /><br />    &lt;target name="jspc"&gt;<br />        &lt;jasper<br />                validateXml="false"<br />                uriroot="${webapp.path}"<br />                webXmlFragment="${basedir}/target/generated_web.xml"<br />                outputDir="${jsp.dest}"<br />                compiler="${java.version}"<br />                compilersourcevm="${java.version}"<br />                compilertargetvm="${java.version}"<br />                failonerror="true"<br />                verbose="9"/&gt;<br />    &lt;/target&gt;<br /><br />    &lt;target name="compile"&gt;<br /><br />        &lt;mkdir dir="${jsp.dest}"/&gt;<br />        &lt;mkdir dir="${jsp.dest.compile}"/&gt;<br /><br />        &lt;javac destdir="${jsp.dest.compile}"<br />               optimize="off"<br />               fork="true"<br />               failonerror="true"<br />               srcdir="${jsp.dest}"<br />               memoryinitialsize="1024m"<br />               memoryMaximumSize="1024m"&gt;<br />            &lt;classpath&gt;<br />                &lt;path path="${maven.dependencies.classpath}"/&gt;<br />            &lt;/classpath&gt;<br />            &lt;include name="**" /&gt;<br />            &lt;!--&lt;exclude name="**/blabla*_jsp.java"/&gt;--&gt;<br />        &lt;/javac&gt;<br /><br />    &lt;/target&gt;<br /><br />    &lt;target name="all" depends="jspc,compile"&gt;<br />    &lt;/target&gt;<br /><br />&lt;/project&gt;<br /></pre><div style="text-align: justify;">On peut constater quelques petites adaptations sur le script ant par rapport à la version proposée. Les raisons sont les suivantes :</div><ul><li style="text-align: justify;">il ne me plaisait pas de dépendre de l'emplacement d'un conteneur de servlets pour effectuer une simple compilation : j'ai préféré déclarer les lib de Tomcat via Maven.&nbsp;Etant dans un profil Maven particulié, l'impact était négligeable pour le reste du projet,</li><li style="text-align: justify;">je ne voulais pas que mes ressources générées partent n'importe où : j'ai donc précisé ces éléments dans les taches jasper et compile,</li><li style="text-align: justify;">je n'ai pas pris la target cleanup car j'ai redirigé toutes mes générations dans le répertoire target géré par Maven.</li></ul><div><div style="text-align: justify;">Par contre, j'ai malheureusement été obligé de garder une dépendance à Tomcat pour le fichier catalina-tasks.xml. J'aurais pu l'embarqué en le customisant un peu et en récupérant, via Maven, les jars déclarés via la variable CATALINA_HOME, mais j'avoue avoir été paresseux sur ce point... par contre, je pense que c'est tout à fait possible de le faire.</div></div><div style="text-align: justify;"><br /></div><div style="text-align: justify;"><br /></div><div style="text-align: justify;">On notera que la phase se fait en 2 passes : </div><ul><li style="text-align: justify;">la première qui transforme les jsp en java (target jspc)</li><li style="text-align: justify;">la deuxième qui compile réellement les java en class (target compile)</li></ul><div style="text-align: justify;"><br /></div><div style="text-align: justify;">Cependant, il reste encore un point qui mérite qu'on s'attarde un peu à cette solution... En effet, le maven-ant-plugin utilisé ici pour invoquer la target Ant depuis Maven s'exécute avec la variable d'environnement JAVA_HOME positionnée sur le JRE :&nbsp;<a href="http://docs.codehaus.org/display/MAVENUSER/Running+ant+tasks+that+use+the+JDK">http://docs.codehaus.org/display/MAVENUSER/Running+ant+tasks+that+use+the+JDK</a>.</div><div style="text-align: justify;"><br /></div><div style="text-align: justify;">Afin de palier à ce point, il convient de référencer&nbsp;en dépendance du plugin Ant la librairie tools.jar... (si ça, c'est pas laid...!!!) et, en plus, de l'utiliser avec un scope system... :'(</div><br /><pre class="brush:xml; wrap-lines: false; auto-links: false">    &lt;dependency&gt;<br />        &lt;groupId&gt;com.sun&lt;/groupId&gt;<br />        &lt;artifactId&gt;tools&lt;/artifactId&gt;<br />        &lt;version&gt;1.7.0&lt;/version&gt;<br />        &lt;scope&gt;system&lt;/scope&gt;<br />        &lt;systemPath&gt;${java.home}/../lib/tools.jar&lt;/systemPath&gt;<br />    &lt;/dependency&gt;<br /></pre><h3>Conclusion</h3><div style="text-align: justify;">Au final, le plugin Ant fonctionne bien (même si je ne suis pas fan d'appeler du Ant via Maven...) et répond au besoin de mon cahier des charges.</div><div style="text-align: justify;"><br /></div><div style="text-align: justify;">Même si cela m'embête, c'est la solution qui a été retenue... :'(</div><div style="text-align: justify;"><br /></div><div style="text-align: justify;"><br /></div><h1 style="text-align: justify;">Conclusion</h1><div style="text-align: justify;">En conclusion, comme vous avez pu le constater, j'ai bien galéré avec une tache enfantine qui n'était qu'une simple validation des jsp par compilation. </div><div style="text-align: justify;">Parmi les 3 solutions testées, seule une a réussi à remplir le cahier des charges qui, pourtant, était simple...</div><div style="text-align: justify;"><br /></div><div style="text-align: justify;">Aussi pas grand chose à conclure si ce n'est que je tenais à faire partager mes petites galères si cela pouvait servir à quelqu'un... ;-) </div><div style="text-align: justify;"><br /></div><div style="text-align: justify;">Le code est disponible <a href="https://github.com/jetoile/jsp-compile">ici</a>&nbsp;avec les différents profils :</div><div style="text-align: justify;"></div><ul><li>jsp-compile-ant,</li><li>jsp-compile-jspc-maven,</li><li>jspc-compile-maven-jetty.</li></ul><br /><div style="text-align: justify;"><br /></div><div style="text-align: justify;">Autre point (transverse) concernant Sitemesh (mais là, j'y vais avec des pincettes car je connais très peu ce framework...)... :</div><div style="text-align: justify;">La visibilité des variables (au sens scriptlet) n'est pas possible entre le décorateur et la page décorée puisque les jsp sont compilées avant le passage de Sitemesh (<a href="http://wiki.sitemesh.org/display/sitemesh/Flow+Diagram">http://wiki.sitemesh.org/display/sitemesh/Flow+Diagram</a>). Par contre, les el sont tout à fait possible d'un coté comme de l'autre.</div><div style="text-align: justify;">Pour avoir un exemple là dessus, c'est accessible sur mon github (<a href="https://github.com/jetoile/jsp-compile">https://github.com/jetoile/jsp-compile</a>) dans les jsp menu.jsp, include.jsp et basic-theme.jsp qui sont, elles-même issues d'un ensemble de copier/coller des tutoriels officiels.</div><div style="text-align: justify;">En fait, c'est surtout ce dernier point que les différents tests présentés dans cet article voulait validé... ;-)</div><br /></div>
