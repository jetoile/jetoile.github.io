---
layout: post
title: "Retour sur la mise en œuvre d'un environnement de développement"
date: 2010-01-04
comments: false
categories:
 - java
 - cargo
 - maven
 - jetspeed
---

<div class='post'>
<div style="text-align: justify;" xmlns="http://www.w3.org/1999/xhtml"><div style="clear: left; float: left; margin-bottom: 1em; margin-right: 1em;"><img src="http://maven.apache.org/images/maven-logo-2.gif" style="max-width: 800px;" /></div>Cet article présente la mise en œuvre que j'ai appliquée lors de la mise en place d'un environnement de développement devant s'interfacer, dans une démarche pseudo-agile, avec des outils d'intégration continue.<br />Il présentera, dans un premier temps, le contexte et les problématiques puis, dans un second temps, comment j'ai tenté de répondre à ces problématiques que ce soit d'un point de vue méthodologique que d'un point de vue technique. Bien sûr, les choix et les implémentations utilisés sont discutables, mais c'est aussi pour cela que j'ai créé ce blog (afin de faire partager mon expérience et d'avoir un retour) ;-)<br />Il ne présentera ni l'utilité des outils d'intégration continue ni celle d'une démarche agile (ce projet ne fonctionnait pas en agile mais mettait en œuvre quelques-unes de ses pratiques) qui sont très bien expliqués sur d'autres sites ou blogs. Enfin, il est à noter que ce projet possédait un existant et que mon rôle n'était pas de remettre en cause les solutions retenues.<br /><!-- more --><br /><h1>Présentation du contexte et des problématiques</h1><h2>Contexte</h2>Le projet concerné avait pour but, entre autre, de fournir un site web à destination du grand public. Il s'appuyait sur le portail Jetspeed 2 (qui pour rappel est un portail permettant d'héberger des portlets 2 - JSR 286 à l'image de Liferay ou GateIn) dont les fonctionnalités d'édition avaient été désactivées. Aussi, le portail Jetspeed n'était utilisé que pour ses capacités à "modularisé" les composants d'affichage à l'aide de portlets qui étaient figés dans les pages. Des services web étaient également utilisés pour permettre de s'interconnecter avec un progiciel utilisé pour implémenter le cœur du métier.<br />Les outils de build utilisés étaient maven 2 et plus précisément le plugin Jetspeed fournit par ce dernier.<br />Enfin, le cycle d'itération des développements étaient de 2 semaines... 2 semaines qui incluaient la définition de ce qu'allait embarquer la livraison (ou si on peut l'appeler comme cela, ce qu'il y aurait dans le sprint), les tests fonctionnels ainsi que la mise en production du livrable... <br />L'équipe incluait 12 développeurs et, dans la globalité, un environnement de développement hétérogène (la faute n'incubant pas foncièrement aux développeurs mais plutôt à des délais beaucoup trop serrés ainsi qu'à une très grosse charge de travail).<br /><h2>Problématiques</h2>Au vu du contexte, un certain nombre de constatation pouvait être fait rapidement :<br /><ul><li>des cycles de développement très court,</li><li>un grand nombre de développeurs dont il fallait intégrer le code,</li><li>un environnement très hétérogène (eclipse, netbeans, intelliJ idea pour la partie IDE, des PCs sous Windows, des PCs sous Linux et des macs pour la partie matérielle),</li><li>une procédure de livraison difficile...<br /></li></ul>En effet, pour revenir sur ce dernier point, les développeurs utilisaient, pour développer, pluto (le moteur de portlet de référence) en raison de machines pas suffisamment véloces et déployaient en local en utilisant directement le plugin mis à disposition par Jetspeed qui construisait le portail, créait sa base de données dans derby, associait son schéma et la peuplait à l'aide de son mécanisme utilisant Torque. Les fichiers de configurations utilisés par les applications web et contenant des paramètres dépendant de l'environnement où elles étaient déployées étaient embarqués dans les jars qui étaient eux-mêmes embarqués dans les applications web (portlets et services web) (ndlr : pour rappel, Jetspeed ainsi que ses portlets sont packagés sous forme de war).<br />En outre, afin de permettre une meilleure évolutivité du système, les portlets n'étaient pas déployés via le mécanisme préconisé par Jetspeed (qui est de les déposer dans son répertoire deploy) mais directement déployés comme une application web normale.<br />En conséquence, la procédure de livraison sur le serveur de production incluait l'utilisation d'une base de données Derby, et une recompilation/redéploiement complet du portail et de ses portlets à l'aide du plugin maven Jetspeed 2 effectués après récupération des sources de notre SCM, modification des fichiers de configuration et lancement du goal install de maven 2 :<br /><pre class="brush:bash; wrap-lines: false; auto-links: false">cd project<br />mvn install<br />mvn jetspeed:mvn -Pall</pre><h2>Méthodologie et Objectifs</h2>Suite à ces constatations, mes objectifs étaient (par ordre de priorité) :<br /><ul><li>Définir un environnement propre, c'est-à-dire ne faisant plus de choses obscures (comme la modification des web.xml des portlets, le peuplement de la base de données derby ou l'ajout dans notre conteneur de Servlets d'un contexte où était déclarée la ressource jndi pour la base de données derby). Cela était un prérequis à la mise en place d'outils d'intégration continue.</li><li>Externaliser les fichiers de configuration se trouvant dans les jars afin de permettre à notre équipe de production de ne pas avoir à recompiler et redéployer les jars à chaque fois qu'une modification devait être effectuée sur ces derniers.</li><li>Mettre en place un processus pour générer un livrable (par exemple sous forme de zip) à destination de notre équipe de production afin ne pas avoir à recompiler le projet (oui, oui, je sais... c'est mal mais c'est la vie! ;-) ) et surtout permettre la reproductivité de l'installation des environnements.</li><li>Fournir, via les outils d'intégration continue, une photo journalière des développements de la veille déployées et opérationnelles (c'est à dire avec une réinitialisation et une injection de données de contenu se trouvant dans une base de données type MySQL).</li></ul>De plus, en parallèle, j'avais pour objectif de fournir aux développeurs un processus de travail plus rigoureux où chaque étape était distincte afin d'avoir une meilleure maitrise des environnements :<br /><ul><li>installation d'un conteneur de servlet spécifique au projet (c'est-à-dire avec les bon jars dans son classpath et sa configuration prédéfinie)<br /></li><li>création des bases de données, des schémas et injection des données</li><li>déploiement de toutes les applications web de manière automatique</li><li>au besoin, déploiement unitaire d'une application web<br /></li></ul><h2>Description de l'arborescence maven</h2><small><span style="font-family: Comic Sans MS;">parent<br />&nbsp;&nbsp; |-- portail<br />&nbsp;&nbsp; |-- portlets<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; |-- portlet1<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; |-- portlet2 <br />&nbsp;&nbsp; |-- ws<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; |-- ws1<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; |-- ws2<br />&nbsp;&nbsp; |-- config<br />&nbsp;&nbsp; |-- assembly<br />&nbsp;&nbsp; |-- src<br />&nbsp;&nbsp; &nbsp; &nbsp;&nbsp;&nbsp;&nbsp; |-- main<br />&nbsp;&nbsp; &nbsp; &nbsp;&nbsp;&nbsp;&nbsp; |-- resources<br />&nbsp;&nbsp; &nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; |-- sql</span></small><br /><h1>Mise en œuvre</h1><h2>Un environnement de développement "propre" avec Maven 2</h2>Le but de ce point était de proposer une meilleure façon de faire pour générer les wars (ie. modules portail, portlet1, portlet2, ws1 et ws2), à savoir, n'avoir à faire qu'un <i>mvn install</i> pour avoir une application web qu'il était possible de déployer automatiquement dans notre conteneur de Servlet   (et non plus un obscur mvn jetspeed:mvn -Pdeploy). En effet, le plugin maven2 de Jetpseed permettait de compiler, générer les wars (le sien et les portlets), et de les déployer dans le conteneur de servlet indiqué. En outre, il permettait également de créer et peupler la base de données utile à son fonctionnement ; la base de données (ie. ses accès et son type) pouvant être indiquée via un fichier de configuration. Pour ce dernier point, le peuplement était fait via la mécanique interne de Jetspeed, à savoir, l'utilisation du framework Torque.<br />La première tache a été de <i>dumper</i> la base de données afin d'obtenir un fichier sql pouvant être utilisé sur la base de données cible et afin de s'abstraire de Torque.<br />Une fois la base de données créée et peuplée à l'aide de ce fichier sql, elle nécessitait d'être renseignée dans le contexte de l'application web du portail. Afin d'éviter un couplage fort entre l'application web et son contexte (et ainsi permettre un déploiement à chaud), la datasource a été renseignée directement dans le fichier conf/context.xml du conteneur de servlet tomcat (bon, pour ce coup, on a parlé implémentation parce que je ne sais pas si le fonctionnement est identique pour tous les conteneurs de Servlet...) partagé par l'ensemble des applications web :<br /><br /><pre class="brush:xml; wrap-lines: false; auto-links: false"><?xml version='1.0' encoding='utf-8'?><br />&lt;Context antiJARLocking="true"><br /> &lt;WatchedResource>WEB-INF/web.xml&lt;/WatchedResource><br /> <resource name="jdbc/jetspeed" auth="Container"<br />  factory="org.apache.commons.dbcp.BasicDataSourceFactory" type="javax.sql.DataSource"<br />  username="xxx" password="xxx" driverClassName="xxx" url="jdbc:xxx://xxx:xxx/j2"<br />  maxActive="100" maxIdle="30" maxWait="10000" ></resource><br />&lt;/Context></pre><br />Ce fichier a également été mis dans le module config dans le répertoire src/main/resources.<br /><br />La seconde tache a été de mettre le plugin Jetspeed dans le cycle de vie maven utilisé par défaut lors de l'exécution du goal maven <i>compile</i> du module portail afin de générer un war qu'il était possible de copier directement dans le répertoire adéquate du conteneur de Servlet afin de permettre son déploiement :<br /><br /><pre class="brush:xml; wrap-lines: false; auto-links: false"><project xmlns="http://maven.apache.org/POM/4.0.0" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"<br /> xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/maven-v4_0_0.xsd"><br /> <parent><br />  ...<br /> </parent><br /><br /> &lt;modelVersion>4.0.0&lt;/modelVersion><br /> <prerequisites><br />  <maven>2.0.9</maven><br /> </prerequisites><br /> &lt;groupId>com.xxx&lt;/groupId><br /> &lt;artifactId>portail&lt;/artifactId><br /> <name>${project.artifactId}</name><br /> <url>${urlRacineSite}/${project.artifactId}</url><br /> <version>0.0.1</version><br /> <packaging>war</packaging><br /><br /> <dependencies><br />  <!-- jetspeed war dependencies --><br />  <dependency><br />   &lt;groupId>org.apache.portals.jetspeed-2&lt;/groupId><br />   &lt;artifactId>jetspeed-dependencies&lt;/artifactId><br />   <version>${org.apache.portals.jetspeed.version}</version><br />   <type>pom</type><br />  </dependency><br />  <dependency><br />   &lt;groupId>org.apache.portals.jetspeed-2&lt;/groupId><br />   &lt;artifactId>jetspeed&lt;/artifactId><br />   <version>${org.apache.portals.jetspeed.version}</version><br />   <type>war</type><br />  </dependency><br />  <dependency><br />   &lt;groupId>org.apache.portals.jetspeed-2&lt;/groupId><br />   &lt;artifactId>jetspeed-api&lt;/artifactId><br />   <version>${org.apache.portals.jetspeed.version}</version><br />   <scope>provided</scope><br />  </dependency><br />  <dependency><br />   &lt;groupId>org.apache.portals.pluto&lt;/groupId><br />   &lt;artifactId>pluto-container-api&lt;/artifactId><br />   <version>${org.apache.pluto.version}</version><br />   <scope>provided</scope><br />  </dependency><br /> </dependencies><br /><br /> <build><br />  &lt;finalName>${project.artifactId}&lt;/finalName><br />  <plugins><br /><br />   <plugin><br />    &lt;groupId>org.apache.maven.plugins&lt;/groupId><br />    &lt;artifactId>maven-war-plugin&lt;/artifactId><br />   </plugin><br /><br />   <plugin><br />    &lt;groupId>org.apache.portals.jetspeed-2&lt;/groupId><br />    &lt;artifactId>jetspeed-deploy-maven-plugin&lt;/artifactId><br />    <version>${org.apache.portals.jetspeed.version}</version><br />    <executions><br />     <execution><br />      <id>deploy-jetspeed-layouts</id><br />      <goals><br />       <goal>deploy</goal><br />      </goals><br />      <phase>process-resources</phase><br />      <configuration><br />       &lt;targetBaseDir><br />        ${project.build.directory}/${project.build.finalName}&lt;/targetBaseDir><br />       <destinations><br />        <local>WEB-INF/deploy/local</local><br />       </destinations><br />       <deployments><br />        <deployment><br />         <artifact><br />          org.apache.portals.jetspeed-2:jetspeed-layouts:war<br />         </artifact><br />         <destination>local</destination><br />        </deployment><br />       </deployments><br />      </configuration><br />     </execution><br />    </executions><br />    <dependencies><br />     <dependency><br />      &lt;groupId>org.apache.portals.jetspeed-2&lt;/groupId><br />      &lt;artifactId>jetspeed-layouts&lt;/artifactId><br />      <version>${org.apache.portals.jetspeed.version}</version><br />      <type>war</type><br />     </dependency><br />    </dependencies><br />   </plugin><br /><br />   <plugin><br />    &lt;groupId>org.apache.maven.plugins&lt;/groupId><br />    &lt;artifactId>maven-war-plugin&lt;/artifactId><br />    <configuration><br />     &lt;warName>${pom.artifactId}&lt;/warName><br />     <overlays><br />      <overlay><br />       <id>jetspeed1</id><br />       &lt;groupId>org.apache.portals.jetspeed-2&lt;/groupId><br />       &lt;artifactId>jetspeed&lt;/artifactId><br />      </overlay><br />      <overlay><br />       <id>jetspeed2</id><br />       &lt;groupId>org.apache.portals.jetspeed-2&lt;/groupId><br />       &lt;artifactId>jetspeed&lt;/artifactId><br />      </overlay><br />     </overlays><br />    </configuration><br />   </plugin><br />  </plugins><br /> </build><br /></project></pre><br />De la même manière, les portlets (et donc les modules portlet1 et portlet2) devaient pouvoir être générés avec l'exécution du goal maven2 <i>compile</i> (n'oublions pas que les portlets devaient pouvoir être enregistrés dans le portail Jetspeed sans avoir à être déposés dans son répertoire deploy mais juste dans le répertoire de déploiement du conteneur de Servlet). Pour ce faire, le projet maven n'avait qu'à être indiqué comme étant un type war et le web.xml contenu dans le répertoire src/main/webapps/WEB-INF n'avait qu'à être renseigné comme utilisant le Servlet controleur de Jetspeed :<br /><br /><pre class="brush:xml; wrap-lines: false; auto-links: false"><?xml version="1.0" encoding="UTF-8"?><br /><web-app xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"<br /> xsi:schemaLocation="http://java.sun.com/xml/ns/javaee<br />http://java.sun.com/xml/ns/javaee/web-app_2_5.xsd"<br /> version="2.5" xmlns="http://java.sun.com/xml/ns/javaee" id="xxx"><br /><br /> <filter-mapping><br />  <filter-name>encoding-filter</filter-name><br />  <url-pattern>/*</url-pattern><br /> </filter-mapping><br /><br /> <servlet><br />  <description><br />   MVC Servlet for Jetspeed Portlet Applications<br />  </description><br />  <display-name>Jetspeed Container</display-name><br />  <servlet-name>JetspeedContainer</servlet-name><br /><br />  <servlet-class><br />   org.apache.jetspeed.container.JetspeedContainerServlet<br />  </servlet-class><br /><br />  <init-param><br />   <param-name>contextName</param-name><param-value>xxx</param-value></init-param><br />  <load-on-startup>0</load-on-startup><br /> </servlet><br /><br /> <servlet-mapping><br />  <servlet-name>JetspeedContainer</servlet-name><br />  <url-pattern>/container/*</url-pattern><br /> </servlet-mapping><br /><br /> <jsp-config><br />  <taglib><br />   <taglib-uri>http://java.sun.com/portlet</taglib-uri><br />   <taglib-location>/WEB-INF/tld/portlet.tld</taglib-location><br />  </taglib><br />  <taglib><br />   <taglib-uri>http://java.sun.com/portlet_2_0</taglib-uri><br />   <taglib-location><br />    /WEB-INF/tld/portlet_2_0.tld<br />   </taglib-location><br />  </taglib><br /> </jsp-config><br /></web-app></pre><br />Grâce à ces actions simples, la simple exécution du goal maven 2 <i>compile</i> était suffisant pour générer les war directement exploitables dans le conteneur de Servlet.<br />Il est à noter que la base de données originellement peuplée par le portail ne l'est pas ici. Ce point est traité par le paragraphe suivant.<br /><h2>Une gestion maitrisée des bases de données</h2>Comme il a été indiqué dans le paragraphe précédent la base de données utilisée par Jetspeed a été dissociée de son processus de génération. Afin de permettre sa création et son peuplement simplement, le plugin maven sql associé à un <i>profile</i> particulié a été utilisé :<br /><br /><pre class="brush:xml; wrap-lines: false; auto-links: false"><profile><br /> <id>initdb</id><br /> <build><br />  <plugins><br /><br />   <plugin><br />    &lt;groupId>org.codehaus.mojo&lt;/groupId><br />    &lt;artifactId>sql-maven-plugin&lt;/artifactId><br />    <dependencies><br />     <!-- specify the dependent jdbc driver here --><br />     <dependency><br />      &lt;groupId>xxx&lt;/groupId><br />      &lt;artifactId>xxx&lt;/artifactId><br />      <version>${xxx.version}</version><br />     </dependency><br />    </dependencies><br />    <configuration><br />     <driver>xxx.Driver</driver><br />     <url>jdbc:xxx://xxx:xxxx</url><br />     <username>xxx</username><br />     <password>xxx</password><br />     &lt;settingsKey>sensibleKey&lt;/settingsKey><br />     <!--all executions are ignored if -Dmaven.test.skip=true --><br />     <skip>${maven.test.skip}</skip><br />    </configuration><br />    <executions><br /><br />     <execution><br />      <id>drop-db-after-test-j2</id><br />      <phase>test-compile</phase><br />      <goals><br />       <goal>execute</goal><br />      </goals><br />      <configuration><br />       <autocommit>true</autocommit><br />       &lt;sqlCommand>drop database j2&lt;/sqlCommand><br />       &lt;onError>continue&lt;/onError><br />      </configuration><br />     </execution><br /><br />     <execution><br />      <id>create-db-j2</id><br />      <phase>test</phase><br />      <goals><br />       <goal>execute</goal><br />      </goals><br />      <configuration><br />       <url>jdbc:xxx://xxx:xxxx:j2</url><br />       <autocommit>true</autocommit><br />       &lt;sqlCommand>create database j2&lt;/sqlCommand><br />      </configuration><br />     </execution><br /><br />     <execution><br />      <id>create-schema-j2</id><br />      <phase>test</phase><br />      <goals><br />       <goal>execute</goal><br />      </goals><br />      <configuration><br />       <url>jdbc:xxx://xxx:xxxx/j2</url><br />       <autocommit>true</autocommit><br />       &lt;srcFiles><br />        &lt;srcFile>src/sql/create-schema.sql&lt;/srcFile><br />       &lt;/srcFiles><br />      </configuration><br />     </execution><br /><br />     <execution><br />      <id>create-data-j2</id><br />      <phase>pre-integration-test</phase><br />      <goals><br />       <goal>execute</goal><br />      </goals><br />      <configuration><br />       <url>jdbc:xxx://xxx:xxxx/j2</url><br />       <autocommit>true</autocommit><br />       &lt;srcFiles><br />        &lt;srcFile>src/sql/create-data.sql&lt;/srcFile><br />       &lt;/srcFiles><br />      </configuration><br />     </execution><br />    </executions><br />   </plugin><br /><br />  </plugins><br /> </build><br /></profile></pre><br />Ici, les fichiers sql utilisés pour peupler la base de données Jetspeed sont issus du dump de la base alors que les fichiers de création du schéma sont issus des sources de Jetspeed (à noter qu'il aurait également été possible de les dumper) et ont été mis dans le répertoire src/main/sql du module parent.<br /><br />Il est à noter également que différentes phases du cycle de vie ont été utilisés et qu'elles ne sont pas foncièrement très logique... (une création d'une base de données sur la phase test n'est pas très adéquate...). Cependant, cela a été fait en raison d'un bug sur maven qui indique qu'il n'est pas possible de prédire&nbsp; l'ordonnancement de l'exécution des plugins dans une même phase. Il s'agit donc d'un contournement (certes pas très propre mais qui fonctionne... ;-) ).<br /><br /><h2>Un déploiement automatisé avec Cargo</h2>Le plugin Jetspeed permettait un déploiement automatique dans le conteneur de Servlet indiqué. Afin de fournir un comportement plus ou moins iso-fonctionnel, j'ai utilisé le plugin maven Cargo pour permettre un déploiement sur le conteneur de Servlet cible (dans notre cas, en local). Pour ce faire, un <i>profile</i> maven a été utilisé :<br /><br /><pre class="brush:xml; wrap-lines: false; auto-links: false"><profiles><br /> <profile><br />  <id>deployer</id><br />  <build><br />   <plugins><br /><br />    <plugin><br />     &lt;groupId>org.codehaus.cargo&lt;/groupId><br />     &lt;artifactId>cargo-maven2-plugin&lt;/artifactId><br />     <version>1.0</version><br />     <executions><br />      <execution><br />       <id>undeploy</id><br />       <phase>pre-integration-test</phase><br />       <goals><br />        <goal>undeploy</goal><br />       </goals><br />      </execution><br /><br />      <execution><br />       <id>start</id><br />       <phase>integration-test</phase><br />       <goals><br />        <goal>deploy</goal><br />       </goals><br />      </execution><br /><br />     </executions><br /><br />     <configuration><br />      <wait>true</wait><br />      <container><br />       &lt;containerId>xxx&lt;/containerId><br />       <type>remote</type><br />      </container><br />      <configuration><br />       <type>runtime</type><br />       <properties><br />        <cargo.remote.username>xxx</cargo.remote.username><br />        <cargo.remote.password>xxx</cargo.remote.password><br />       </properties><br />      </configuration><br /><br />      <deployer><br />       <type>remote</type><br />       <deployables><br />        <deployable><br />         &lt;groupId>xxx&lt;/groupId><br />         &lt;artifactId>xxx&lt;/artifactId><br />         <type>war</type><br />         <properties><br />          <context>xxx</context><br />         </properties><br />        </deployable><br />       </deployables><br />      </deployer><br />     </configuration><br />    </plugin><br /><br />   </plugins><br />  </build><br /> </profile><br /></profiles></pre><br />Suite à ces actions, le portail, les portlets et les autres applications web étaient déployables via les commandes :<br /><pre class="brush:bash; wrap-lines: false; auto-links: false">mvn install -Pinitdb<br />mvn install -Pdeployer</pre><br />En outre, la commande <i>mvn install </i>permettait également de générer un war directement exploitable par un conteneur de Servlet (et donc directement utilisable dans un livrable à destination de la production).<br /><h2>Externaliser les fichiers de configuration</h2>Comme il a été indiqué dans l'introduction, les fonctions métiers (disponible au travers de jars fournis via des modules maven) utilisées par les applications web étaient dépendantes de variables liées à l'environnement, ces variables étant contenues dans un fichier de configuration présent dans le jar. Afin de permettre une meilleure maitrise et une meilleure évolutivité du système, il était indispensable de sortir ces fichiers de configuration des jars et même des applications web. <br />Pour ce faire, il a été décidé de les mettre dans le classpath serveur. Cependant, Tomcat 6.0 (arf, pour ce coup, je vais devoir parler implémentation... ;-) ) semble avoir désactivé par défaut cette fonctionnalité. Aussi, il a été nécessaire d'éditer le fichier catalina.properties se trouvant dans le répertoire conf de notre Tomcat et d'indiquer comme valeur à la clé shared.loader l'emplacement de nos fichiers de configuration (ici, ${catalina.home}/lib/conf).<br />Ces fichiers ont, bien sûr, été sortis des jars (et mis dans le répertoire src/main/resources du module config) et ont été <i>templatisés</i> pour permettre de modifier facilement leur contenu en fonction de l'environnement d'exécution.<br /><br />En outre, les fichiers utilisés par l'application et par les tests unitaires mais dont le contenu ne pouvait pas être <i>templatisé</i> simplement (par exemple, la déclaration de la <i>datasource</i> utilisant, lorsque les jars étaient exécutés au sein du conteneur de Servlet, une référence à un annuaire jndi -et donc une ligne de configuration- et, lorsque les jars étaient utilisés unitairement, une référence directe -et donc 4 lignes de configuration-) ont été dupliqués (modulo les modifications adéquates) dans le répertoire src/test/resources du module config. Cela a permis de créer une dépendance de scope test pour les projets qui avait besoin de cette configuration pour exécuter les tests unitaires :<br /><pre class="brush:xml; wrap-lines: false; auto-links: false"><dependency><br /> &lt;groupId>com.xxx&lt;/groupId><br /> &lt;artifactId>config&lt;/artifactId><br /> <classifier>tests</classifier><br /> <type>test-jar</type><br /> <scope>test</scope><br /></dependency></pre><br /><br />Afin de <i>templatiser</i> ces fichiers de configuration, la fonctionnalité de filtrage de maven a été utilisée en complément de l'utilisation de profiles maven :<br /><pre class="brush:xml; wrap-lines: false; auto-links: false"><build><br /> <resources><br />  <resource><br />   <filtering>true</filtering><br />   <directory>src/main/resources</directory><br />  </resource><br /> </resources><br /> <filters><br />  <filter>src/main/filters/filter-${environment}.properties</filter><br /> </filters><br /> ...<br /></build></pre><br />où les profiles étaient :<br /><pre class="brush:xml; wrap-lines: false; auto-links: false"><profiles><br /> <profile><br />  <id>dev</id><br />  <activation><br />   &lt;activeByDefault>true&lt;/activeByDefault><br />  </activation><br />  <properties><br />   <environment>dev</environment><br />  </properties><br /> </profile><br /><br /> <profile><br />  <id>dev-integ</id><br />  <properties><br />   <environment>dev-integ</environment><br />  </properties><br /> </profile><br /></profiles></pre><br />et où les fichiers src/main/filters/filter-${environment}.properties contenaient les association clé/valeur en fonction de l'environnement.<br /><h2>Mise en place d'un livrable</h2>Suite au travail décrit dans les paragraphes précédents, cela avait permis de mettre en place un environnement de développement et de build propre. Une réflexion sur la génération d'un livrable à destination de la production était désormais possible.<br />Pour cela, nous avons décidé d'utiliser le plugin assembly de maven en créant un module supplémentaire (module assembly) et dont le rôle était de générer notre livrable. <br /><br />Ci-joint notre fichier assembly se trouvant dans le répertoire src/main/assembly du module assembly :<br /><br /><pre class="brush:xml; wrap-lines: false; auto-links: false"><assembly><br /> <id>1.0</id><br /> <formats><br />  <format>zip</format><br /> </formats><br /> &lt;includeBaseDirectory>false&lt;/includeBaseDirectory><br /> &lt;dependencySets><br /><br />  &lt;dependencySet><br />   &lt;outputDirectory>webapps&lt;/outputDirectory><br />   &lt;outputFileNameMapping><br />    ${artifact.artifactId}.${artifact.extension}<br />   &lt;/outputFileNameMapping><br />   <includes><br />    <include><br />     *:war<br />    </include><br />   </includes><br />  &lt;/dependencySet><br /><br />  &lt;dependencySet><br />   <scope>provided</scope><br />   <!-- notre pom déclarait les jars à mettre dans le classpath serveur avec <br />    un scope provided --><br />   &lt;useProjectArtifact>false&lt;/useProjectArtifact><br />   &lt;useTransitiveDependencies>false&lt;/useTransitiveDependencies><br />   &lt;outputDirectory>tomcat_bin/lib&lt;/outputDirectory><br />   <includes><br />    <include><br />     *:jar<br />    </include><br />   </includes><br />  &lt;/dependencySet><br /> &lt;/dependencySets><br /> &lt;fileSets><br />  &lt;fileSet><br />   <directory>../config/target/classes</directory><br />   &lt;outputDirectory>tomcat_parameters/lib/conf&lt;/outputDirectory><br />   <includes><br />    <include><br />     **<br />    </include><br />   </includes><br />  &lt;/fileSet><br /><br />  &lt;fileSet><br />   <directory>../src/main/sql/j2</directory><br />   &lt;outputDirectory>portal-sql-db&lt;/outputDirectory><br />   <includes><br />    <include><br />     **<br />    </include><br />   </includes><br />  &lt;/fileSet><br /> &lt;/fileSets><br /></assembly></pre><br />et où le pom.xml utilisant le plugin était :<br /><pre class="brush:xml; wrap-lines: false; auto-links: false"><build><br /> <plugins><br />  <plugin><br />   &lt;artifactId>maven-assembly-plugin&lt;/artifactId><br />   <configuration><br />    <descriptors><br />     <descriptor>src/main/assembly/src.xml</descriptor><br />    </descriptors><br />   </configuration><br />   <executions><br />    <execution><br />     <id>make-assembly</id><br />     <phase>package</phase><br />     <goals><br />      <goal>single</goal><br />     </goals><br />    </execution><br />   </executions><br />  </plugin><br /> </plugins><br /></build></pre><br /><h2>Compilation, génération et déploiement automatisé</h2>Cette phase faisait suite aux travaux décrits dans les paragraphes précédents et avait pour objectif de fournir une version de la veille de ce qui était présent sur le trunk du SCM, et cela, dans l'idée de permettre aux développeurs de se voir avancer et de tester de manière intégré leur code.<br />Pour ce faire, le plugin maven cargo a été utilisé conjointement à un profile particulier. En outre, c'est le mode <i>remote</i> qui a été choisi afin de permettre un déploiement des applications web au sein du conteneur de servlet local, ce conteneur de servlet ayant préalablement été modifié afin d'avoir en son sein les variables de configuration dans son classpath ainsi que ses fichiers de configuration modifiés.<br /><br /><br /><pre class="brush:xml; wrap-lines: false; auto-links: false"><profile><br /> <id>dev-integ</id><br /> <build><br />  <plugins><br />   <plugin><br />    &lt;groupId>org.apache.maven.plugins&lt;/groupId><br />    &lt;artifactId>maven-antrun-plugin&lt;/artifactId><br />    <executions><br /><br />     <execution><br />      <id>stop-tomcat</id><br />      <phase>generate-test-sources</phase><br />      <goals><br />       <goal>run</goal><br />      </goals><br />      <configuration><br />       <tasks><br />        <exec dir="/home/dev/tomcat/bin" executable="sh"><br />         <arg line="shutdown.sh"><br />         </arg><br />         <sleep seconds="20"><br />         </sleep><br />        </exec><br />       </tasks><br />      </configuration><br />     </execution><br /><br />     <execution><br />      <id>start-tomcat</id><br />      <phase>integration-test</phase><br />      <goals><br />       <goal>run</goal><br />      </goals><br />      <configuration><br />       <tasks><br />        <exec dir="/home/dev/tomcat/bin" executable="sh"><br />         <arg line="startup.sh"><br />         </arg><br />        </exec><br />       </tasks><br />      </configuration><br />     </execution><br />    </executions><br />   </plugin><br /><br />   <plugin><br />    &lt;groupId>org.codehaus.mojo&lt;/groupId><br />    &lt;artifactId>sql-maven-plugin&lt;/artifactId><br />    <dependencies><br />     <dependency><br />      &lt;groupId>bdd&lt;/groupId><br />      &lt;artifactId>bdd&lt;/artifactId><br />      <version>${bdd.version}</version><br />     </dependency><br />    </dependencies><br /><br />    <configuration><br />     <driver>org.bdd.Driver</driver><br />     <url>jdbc:xxx://localhost:xxx</url><br />     <username>xxx</username><br />     <password>xxx</password><br />     &lt;settingsKey>sensibleKey&lt;/settingsKey><br />     <skip>${maven.test.skip}</skip><br />    </configuration><br /><br />    <executions><br />     <execution><br />      <id>drop-db-after-test-j2</id><br />      <phase>test-compile</phase><br />      <goals><br />       <goal>execute</goal><br />      </goals><br />      <configuration><br />       <autocommit>true</autocommit><br />       &lt;sqlCommand>drop database j2&lt;/sqlCommand><br />       &lt;onError>continue&lt;/onError><br />      </configuration><br />     </execution><br /><br />     <execution><br />      <id>create-db-j2</id><br />      <phase>test</phase><br />      <goals><br />       <goal>execute</goal><br />      </goals><br />      <configuration><br />       <url>jdbc:postgresql://localhost:xxx:j2</url><br />       <autocommit>true</autocommit><br />       &lt;sqlCommand>create database j2&lt;/sqlCommand><br />      </configuration><br />     </execution><br /><br />     <execution><br />      <id>create-schema-j2</id><br />      <phase>test</phase><br />      <goals><br />       <goal>execute</goal><br />      </goals><br />      <configuration><br />       <url>jdbc:postgresql://localhost:xxx/j2</url><br />       <autocommit>true</autocommit><br />       &lt;srcFiles><br />        &lt;srcFile><br />         ${project.basedir}/../src/main/sql/j2/create-schema.sql<br />        &lt;/srcFile><br />       &lt;/srcFiles><br />      </configuration><br />     </execution><br /><br />     <execution><br />      <id>create-data-j2</id><br />      <phase>pre-integration-test</phase><br />      <goals><br />       <goal>execute</goal><br />      </goals><br />      <configuration><br />       <url>jdbc:postgresql://localhost:5432/j2</url><br />       <autocommit>true</autocommit><br />       &lt;srcFiles><br />        &lt;srcFile><br />         ${project.basedir}/../src/main/sql/j2/postgresql-data.sql<br />        &lt;/srcFile><br />       &lt;/srcFiles><br />      </configuration><br />     </execution><br />    </executions><br />   </plugin><br /><br />   <plugin><br />    &lt;groupId>org.codehaus.cargo&lt;/groupId><br />    &lt;artifactId>cargo-maven2-plugin&lt;/artifactId><br />    <version>1.0</version><br />    <executions><br /><br />     <execution><br />      <id>undeploy</id><br />      <phase>integration-test</phase><br />      <goals><br />       <goal>undeploy</goal><br />      </goals><br />     </execution><br /><br />     <execution><br />      <id>start</id><br />      <phase>integration-test</phase><br />      <goals><br />       <goal>deploy</goal><br />      </goals><br />     </execution><br />    </executions><br /><br />    <configuration><br />     <wait>true</wait><br />     <container><br />      &lt;containerId>tomcat6x&lt;/containerId><br />      <type>remote</type><br />     </container><br /><br />     <configuration><br />      <type>runtime</type><br />      <properties><br />       <cargo.remote.username>xxx</cargo.remote.username><br />       <cargo.remote.password>xxx</cargo.remote.password><br />      </properties><br />     </configuration><br /><br />     <deployer><br />      <type>remote</type><br />      <deployables><br />       <deployable><br />        &lt;groupId>xxx&lt;/groupId><br />        &lt;artifactId>portail&lt;/artifactId><br />        <type>war</type><br />       </deployable><br />       <deployable><br />        &lt;groupId>xxx&lt;/groupId><br />        &lt;artifactId>portlet1&lt;/artifactId><br />        <type>war</type><br />       </deployable><br />       <deployable><br />        &lt;groupId>xxx&lt;/groupId><br />        &lt;artifactId>ws1&lt;/artifactId><br />        <type>war</type><br />       </deployable><br />       ...<br />      </deployables><br />     </deployer><br />    </configuration><br />   </plugin><br />  </plugins><br /> </build><br /></profile></pre><br />Il est à noter qu'ici, les phases utilisés ne sont pas foncièrement cohérente... en effet, j'ai supprimé quelques petites actions afin de ne pas géner à la visibilité ;-)<br /><h1>Conclusion</h1>Il a été vu dans les paragraphes précédents que maven 2 a servi de point central à la mise en place de l'environnement de développement même s'il est vrai que je n'ai pas utilisé pleinement ses fonctionnalités (les goals <i>deploy</i> ou <i>release</i> par exemple)...<br />En outre, je n'ai pas mentionné les outils d'intégration continue qui, bien sûr, exécutait périodiquement certaines de ces phases ainsi qu'une phase transverse où était exécutés des tests d'intégration et d'acceptance sur une instance de type <i>embedded</i> déployée via le plugin cargo.<br />De même, les outils mis en place de type <i>Sonar</i> n'ont pas été mentionnés ici : cet article n'avait pour but que de présenter <b>une</b> mise en oeuvre d'un environnement de développement (bonne ou mauvaise, je vous laisse en juger...) qui j'espère donnera quelques idées...<br /><br /><h1>Pour aller plus loin...</h1><ul><li><b>Apache Maven</b> de N. De Loof, A. Héritier chez Pearson<br /></li><li><b>Better Builds with Maven</b> : <a href="http://repo.exist.com/dist/maestro/1.7.0/BetterBuildsWithMaven.pdf">http://repo.exist.com/dist/maestro/1.7.0/BetterBuildsWithMaven.pdf</a></li><li> <b>Maven. Definitive Guide</b> : <a href="http://www.sonatype.com/products/maven/documentation/book-defguide">http://www.sonatype.com/products/maven/documentation/book-defguide</a><br /></li></ul><ul><li>Site de maven : <a href="http://maven.apache.org/">http://maven.apache.org/</a></li><li>Site de Cargo : <a href="http://cargo.codehaus.org/Maven2+plugin">http://cargo.codehaus.org/Maven2+plugin</a></li><li>Site du plugin SQL maven : <a href="http://mojo.codehaus.org/sql-maven-plugin/">http://mojo.codehaus.org/sql-maven-plugin/</a></li><li>Site de Tomcat : <a href="http://tomcat.apache.org/">http://tomcat.apache.org/</a></li><li>Site de Jetspeed 2 : <a href="http://portals.apache.org/jetspeed-2/">http://portals.apache.org/jetspeed-2/</a></li><li>Blog de Xebia sur Cargo et Maven : <a href="http://blog.xebia.fr/2008/11/05/lintegration-continue-avec-cargo/">http://blog.xebia.fr/2008/11/05/lintegration-continue-avec-cargo/</a> </li><li>Article sur Cargo : <a href="http://www.waltercedric.com/java-j2ee-mainmenu-53/361-maven-build-system/1555-deploy-to-tomcat-6-using-maven.html">http://www.waltercedric.com/java-j2ee-mainmenu-53/361-maven-build-system/1555-deploy-to-tomcat-6-using-maven.html</a><br /></li></ul><ul><li>Présentation de Maven 2 par le BreizhJUG : <a href="http://sites.google.com/a/breizhjug.org/home/2008/Maven">http://sites.google.com/a/breizhjug.org/home/2008/Maven</a></li><li>Présentation de l'intégration continue par le BreizhJUG : <a href="http://sites.google.com/a/breizhjug.org/home/2008/IntegrationContinue">http://sites.google.com/a/breizhjug.org/home/2008/IntegrationContinue</a><br /></li></ul><ul></ul><br /></div></div>
<h2>Comments</h2>
<div class='comments'>
<div class='comment'>
<div class='author'>Khanh</div>
<div class='content'>
A titre informatif, <a href="http://blog.loof.fr/" rel="nofollow">Nicolas De Loof</a> a laissé le commentaire suivant sur le <a href="http://blog.soat.fr/" rel="nofollow">blog de So@t</a> :<br />&quot;Plutôt qu’une combinaison d’execs du plugin SQL, j’utilise Unitils (plus précisement le module DBMaintainer). Ceci évite de recréer la base inutilement lorsqu’elle est à jour tout en assurant que les scripts et le code qui accède à la base sont cohérents&quot;<br /><br />Ci-joint le pointeur sur Unitils :<br /><a href="http://www.unitils.org/tutorial.html#Automatic_test_database_maintenance" rel="nofollow">http://www.unitils.org/tutorial.html#Automatic_test_database_maintenance</a></div>
</div>
<div class='comment'>
<div class='author'>Khanh</div>
<div class='content'>
Article également posté sur le blog de So@t : http://blog.soat.fr/</div>
</div>
</div>
