---
layout: post
title: "Jetty, Maven et JMX"
date: 2011-09-26
comments: false
categories:
 - java
 - jmx
 - jetty
 - maven
---

<div class='post'>
<div class="separator" style="clear: both; text-align: center;"><a href="http://2.bp.blogspot.com/-bGP4Fnvfp1s/TnEtqz-UNkI/AAAAAAAAAa4/KBXNM8QXHKc/s1600/logoArticle.png" imageanchor="1" style="clear: left; float: left; margin-bottom: 1em; margin-right: 1em;"><img border="0" height="162" src="http://2.bp.blogspot.com/-bGP4Fnvfp1s/TnEtqz-UNkI/AAAAAAAAAa4/KBXNM8QXHKc/s320/logoArticle.png" width="320" /></a></div><div style="text-align: justify;">Vous avez peut être remarqué que ces derniers temps, j'étais très Maven et JMX. Cet article ne déroge pas à la règle puisque je vais parler de... Maven et de JMX. </div><div style="text-align: justify;">Enfin pour être plus précis, je vais montrer comment il est facilement possible de déployer une application web dans le conteneur embarqué Jetty via Maven en activant la couche JMX afin de pouvoir tester de manière intégrée cette couche.</div>Pour ce faire, je présenterai dans un premier temps le contexte, puis comment cela peut être mise en œuvre. <br /><div style="text-align: justify;">Bien sûr, cet article montre comment j'ai fait mais il ne représente pas la seule manière de faire... ;-). En outre, il ne présente rien de novateur mais je me suis dit que cela pouvait toujours être utile afin d'éviter de faire perdre du temps à d'autres personnes. </div><!-- more --><h1>  Contexte</h1><div style="text-align: justify;">Ce paragraphe présente mes motivations pour avoir eu un besoin d'une utilisation d'un Jetty embedded à Maven en activant la couche JMX car, c'est vrai, ce n'est pas un besoin très courant et qu'il peut même sembler, au premier abord, paraitre un peu stupide (en effet, utiliser un Jetty embedded répond plutôt à un besoin de poste de développement ou au pire (et je dis bien au pire!!) à un pseudo TU qui n'est, du coup, pas un TU... (ndlr : enfin, encore une fois, je diverge... ;-) )).</div><div style="text-align: justify;">En fait, pour les besoins d'une démonstration, je voulais juste présenter une petite application web qui remontait des métriques via JMX.  N'ayant pas foncièrement envie d'avoir à décompresser un Jetty sur mon poste, je me suis dit qu'un Jetty embedded dans Maven suffisait largement à ma petite démo.</div><div style="text-align: justify;">En outre, cela offrait également la possibilité à n'importe qui de rejouer la démo sans avoir à installer localement un conteneur de Servlets et sans à avoir à modifier le paramétrage de ce dernier pour activer la couche JMX de la JVM.</div><div style="text-align: justify;">L'application web utilisée pour ce petit POC est assez basique puisqu'il ne s'agit que d'un simple Servlet redirigeant vers une simple jsp. </div><div style="text-align: justify;">Ce Servlet incrémentera un compteur exposé en JMX afin de fournir cette métrique basique à la couche de supervision.</div><div style="text-align: justify;">Spring 3 sera également utilisé pour lier le tout... </div><br /><div style="text-align: justify;">En fait, si vous me demandez pourquoi j'ai branché Spring pour une application ausi simple, c'est, en fait, que JMX n'était pas le seul composant que je voulais montrer pendant la petite démonstration...</div><div style="text-align: justify;">Si vous avez l'esprit chagrin et que vous me re-demandez pourquoi je n'ai pas utilisé un aspect, c'est que l'aspect était justement l'autre aspect de ma démo ;-). </div><h1>  Mise en œuvre</h1><div style="text-align: justify;">Pour ce paragraphe de mise en œuvre, je présenterai successivement : </div><ul><li style="text-align: justify;">Le code de l'application web utilisé.</li><li style="text-align: justify;">La configuration Maven utilisée permettant de démarrer l'application web dans un Jetty embedded.</li><li style="text-align: justify;">Les subtilités de la configuration à effectuer pour ajouter la couche JMX.</li></ul><h2>  Application web cible</h2><div style="text-align: justify;">Comme annoncé précédemment, notre application web cible se compose de : </div><ul><li style="text-align: justify;">un Servlet,</li><li style="text-align: justify;">une page JSP,</li><li style="text-align: justify;">un POJO utilisé par Spring pour la partie MBean (Spring aura, à sa charge, sa <i>proxification</i> en MBean Standard et son enregistrement au sein du MBean Server), </li><li style="text-align: justify;">un fichier de configuration web.xml,</li><li style="text-align: justify;">et un fichier de contexte Spring.</li></ul><div style="text-align: justify;">Il est à noter qu'elle utilisera la spécification 2.5 des Servlets afin de permettre, dans les parties suivantes, de montrer la différence de configuration qu'il existe entre Jetty 6 et 7. </div><h3>  Code du Servlet</h3><pre class="brush:java; wrap-lines: false; auto-links: false">public class SimpleServlet extends HttpServlet {<br />    private static Logger LOGGER = LoggerFactory.getLogger(SimpleServlet.class);<br /><br />    @Override<br />    protected void service(HttpServletRequest req, HttpServletResponse resp) throws ServletException, IOException {<br />        ApplicationContext beanFactory = WebApplicationContextUtils.getRequiredWebApplicationContext(getServletContext());<br />        SimpleCounter jmxTestBean = beanFactory.getBean("simpleCounter", SimpleCounter.class);<br />        jmxTestBean.inc();<br /><br />        req.setAttribute("nbInvocation", jmxTestBean.getNbGet());<br /><br />        RequestDispatcher dispatcher = req.getRequestDispatcher("WEB-INF/jsp/simpleDisplay.jsp");<br />        if (dispatcher != null) {<br />            dispatcher.forward(req, resp);<br />        } else {<br />            LOGGER.warn("unable to get the request dispatcher");<br />        }<br />    }<br />}<br /></pre><div style="text-align: justify;">On constate que le Servlet est basique. Il n'y a donc rien à dire dessus si ce n'est la récupération du POJO <i>proxifié</i> par Spring pour incrémenter un compteur qui sera exposé en JMX.  </div><h3>  Code du POJO utilisé comme MBean Standard</h3><pre class="brush:java; wrap-lines: false; auto-links: false">public class SimpleCounter {<br />    private int nbGet = 0;<br /><br />    public void inc() {<br />        this.nbGet++;<br />    }<br /><br />    public void setNbGet(int nbGet) {<br />        this.nbGet = nbGet;<br />    }<br /><br />    public int getNbGet() {<br />        return nbGet;<br />    }<br />}<br /></pre><div style="text-align: justify;">Concernant le POJO, rien de spécial non plus à remarquer. Juste à noter que les setter et getter sont nécessaires afin de rendre l'attribut nbGet accessible en lecture/écriture par la couche cliente JMX. </div><h3>  Code de la jsp</h3><pre class="brush:html; wrap-lines: false; auto-links: false">&lt;%@ page language="java" contentType="text/html; charset=UTF-8" pageEncoding="UTF-8"%&gt;<br />&lt;!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd"&gt;<br />&lt;html&gt;<br />    &lt;head&gt;<br />        &lt;meta http-equiv="Content-Type" content="text/html; charset=UTF-8"&gt;<br />        &lt;title&gt;simple display&lt;/title&gt;<br />    &lt;/head&gt;<br />    &lt;body&gt;<br />        &lt;h1&gt;This is a simple display&lt;/h1&gt;<br />        Has been invoked: ${nbInvocation} times<br />    &lt;/body&gt;<br />&lt;/html&gt;</pre><div style="text-align: justify;">Rien de particulier non plus à dire sur la jsp... </div><h3>  Code du web.xml</h3><pre class="brush:xml; wrap-lines: false; auto-links: false">&lt;web-app version="2.5" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns="http://java.sun.com/xml/ns/javaee" xsi:schemalocation="http://java.sun.com/xml/ns/javaee <br /> http://java.sun.com/xml/ns/javaee/web-app_2_5.xsd"&gt;<br /> &lt;context-param&gt;<br />  &lt;param-name&gt;contextConfigLocation&lt;/param-name&gt;<br />  &lt;param-value&gt;classpath:applicationContext*.xml&lt;/param-value&gt;<br /> &lt;/context-param&gt;<br /> &lt;listener&gt;<br />  &lt;listener-class&gt;org.springframework.web.context.ContextLoaderListener&lt;/listener-class&gt;<br /> &lt;/listener&gt;<br /><br /> &lt;servlet&gt;<br />  &lt;servlet-name&gt;SimpleServlet&lt;/servlet-name&gt;<br />  &lt;servlet-class&gt;fr.jetoile.demo.servlet.SimpleServlet&lt;/servlet-class&gt;<br />  &lt;init-param&gt;<br />   &lt;param-name&gt;sleep-time-in-seconds&lt;/param-name&gt;<br />   &lt;param-value&gt;10&lt;/param-value&gt;<br />  &lt;/init-param&gt;<br />  &lt;load-on-startup&gt;1&lt;/load-on-startup&gt;<br /> &lt;/servlet&gt;<br /><br /> &lt;servlet-mapping&gt;<br />  &lt;servlet-name&gt;SimpleServlet&lt;/servlet-name&gt;<br />  &lt;url-pattern&gt;/sample&lt;/url-pattern&gt;<br /> &lt;/servlet-mapping&gt;<br />&lt;/web-app&gt;<br /></pre><div style="text-align: justify;">Le fichier descripteur web.xml est classique donc rien de nouveau sur les tropiques ;-). Comme dit plus haut, c'est ici la version 2.5 des servlets qui est utilisée afin de permettre un choix plus important de conteneurs de Servlets.   </div><h3>  Code du contexte Spring</h3><pre class="brush:xml; wrap-lines: false; auto-links: false">&lt;beans xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns="http://www.springframework.org/schema/beans" xsi:schemalocation="http://www.springframework.org/schema/beans<br /> http://www.springframework.org/schema/beans/spring-beans-3.0.xsd"&gt;<br /> &lt;bean class="org.springframework.jmx.support.MBeanServerFactoryBean" id="mbeanServer"&gt;<br />  &lt;property name="locateExistingServerIfPossible" value="true"&gt;&lt;/property&gt;<br /> &lt;/bean&gt;<br /><br /> &lt;bean class="org.springframework.jmx.export.MBeanExporter" id="exporter"&gt;<br />  &lt;property name="beans"&gt;<br />   &lt;map&gt;<br />    &lt;entry key="bean:application=jmx-sample,name=simpleCounter" value-ref="simpleCounter"&gt;&lt;/entry&gt;<br />   &lt;/map&gt;<br />  &lt;/property&gt;<br />   &lt;property name="server" ref="mbeanServer"&gt;&lt;/property&gt;<br /> &lt;/bean&gt;<br /><br /> &lt;bean class="fr.jetoile.demo.jmx.SimpleCounter" id="simpleCounter"&gt;&lt;/bean&gt;<br />&lt;/beans&gt;<br /></pre><div style="text-align: justify;">Concernant le fichier descripteur de Spring, on constate que la classe MBeanServerFactoryBean de Spring est utilisée comme moyen de récupération/création du MBeanServer et que c'est le MBeanExporter qui a la charge de l'enregistrement du MBean injecté.  </div><h2>  Application web exécutable via Jetty au sein de Maven</h2><div style="text-align: justify;">Afin de permettre une exécution de notre application web dans un Jetty embedded dans Maven, il faut, bien sûr, une structure Maven.</div><div style="text-align: justify;">Elle est la suivante :</div><div class="separator" style="clear: both; text-align: center;"></div><div class="separator" style="clear: both; text-align: center;"><a href="http://3.bp.blogspot.com/-q2jJEYSygfg/TnErFlaNEDI/AAAAAAAAAag/2vgwO_zYc6A/s1600/jmx-sample-tree.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" height="275" src="http://3.bp.blogspot.com/-q2jJEYSygfg/TnErFlaNEDI/AAAAAAAAAag/2vgwO_zYc6A/s320/jmx-sample-tree.png" width="320" /></a></div><br /><div style="text-align: justify;">Concernant le fichier descripteur pom.xml, il contiendra, bien sûr, le plugin nécessaire au lancement de jetty.</div><div style="text-align: justify;">Afin d'être plus exhaustif, dans notre POC, deux profils Maven seront utilisés afin de pouvoir spécifier la version de Jetty à utiliser (le choix sera laissé entre Jetty 6 et 7). En outre, le port d'écoute est forcé à 9090 : </div><pre class="brush:xml; wrap-lines: false; auto-links: false">&lt;?xml version="1.0" encoding="UTF-8"?&gt;<br />&lt;project xmlns="http://maven.apache.org/POM/4.0.0" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"<br /> xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd"&gt;<br /> &lt;modelVersion&gt;4.0.0&lt;/modelVersion&gt;<br /> &lt;groupId&gt;fr.jetoile.demo&lt;/groupId&gt;<br /> &lt;artifactId&gt;jmx-sample&lt;/artifactId&gt;<br /> &lt;packaging&gt;war&lt;/packaging&gt;<br /> &lt;version&gt;1.0-SNAPSHOT&lt;/version&gt;<br /><br /> &lt;properties&gt;<br />  &lt;java.version&gt;1.5&lt;/java.version&gt;<br />  &lt;project.build.sourceEncoding&gt;UTF-8&lt;/project.build.sourceEncoding&gt;<br /><br />  &lt;slf4j.version&gt;1.6.1&lt;/slf4j.version&gt;<br />  &lt;logback.version&gt;0.9.27&lt;/logback.version&gt;<br />  &lt;commons-lang.version&gt;2.5&lt;/commons-lang.version&gt;<br />  &lt;spring.version&gt;3.0.6.RELEASE&lt;/spring.version&gt;<br />  &lt;servlet.version&gt;2.5&lt;/servlet.version&gt;<br /> &lt;/properties&gt;<br /><br /> &lt;dependencies&gt;<br />  &lt;dependency&gt;<br />   &lt;groupId&gt;ch.qos.logback&lt;/groupId&gt;<br />   &lt;artifactId&gt;logback-classic&lt;/artifactId&gt;<br />   &lt;version&gt;${logback.version}&lt;/version&gt;<br />  &lt;/dependency&gt;<br />  &lt;dependency&gt;<br />   &lt;groupId&gt;org.slf4j&lt;/groupId&gt;<br />   &lt;artifactId&gt;slf4j-api&lt;/artifactId&gt;<br />   &lt;version&gt;${slf4j.version}&lt;/version&gt;<br />  &lt;/dependency&gt;<br />  &lt;dependency&gt;<br />   &lt;groupId&gt;commons-lang&lt;/groupId&gt;<br />   &lt;artifactId&gt;commons-lang&lt;/artifactId&gt;<br />   &lt;version&gt;${commons-lang.version}&lt;/version&gt;<br />  &lt;/dependency&gt;<br />  &lt;dependency&gt;<br />   &lt;groupId&gt;org.springframework&lt;/groupId&gt;<br />   &lt;artifactId&gt;spring-context&lt;/artifactId&gt;<br />   &lt;version&gt;${spring.version}&lt;/version&gt;<br />  &lt;/dependency&gt;<br />  &lt;dependency&gt;<br />   &lt;groupId&gt;org.springframework&lt;/groupId&gt;<br />   &lt;artifactId&gt;spring-web&lt;/artifactId&gt;<br />   &lt;version&gt;${spring.version}&lt;/version&gt;<br />  &lt;/dependency&gt;<br />  &lt;dependency&gt;<br />   &lt;groupId&gt;javax.servlet&lt;/groupId&gt;<br />   &lt;artifactId&gt;servlet-api&lt;/artifactId&gt;<br />   &lt;version&gt;${servlet.version}&lt;/version&gt;<br />   &lt;scope&gt;provided&lt;/scope&gt;<br />  &lt;/dependency&gt;<br /> &lt;/dependencies&gt;<br /><br /> &lt;build&gt;<br />  &lt;plugins&gt;<br /><br />   &lt;plugin&gt;<br />    &lt;artifactId&gt;maven-deploy-plugin&lt;/artifactId&gt;<br />    &lt;version&gt;2.6&lt;/version&gt;<br />   &lt;/plugin&gt;<br /><br />   &lt;plugin&gt;<br />    &lt;artifactId&gt;maven-release-plugin&lt;/artifactId&gt;<br />    &lt;version&gt;2.1&lt;/version&gt;<br />   &lt;/plugin&gt;<br /><br />   &lt;plugin&gt;<br />    &lt;artifactId&gt;maven-compiler-plugin&lt;/artifactId&gt;<br />    &lt;version&gt;2.3.2&lt;/version&gt;<br />    &lt;configuration&gt;<br />     &lt;source&gt;${java.version}&lt;/source&gt;<br />     &lt;target&gt;${java.version}&lt;/target&gt;<br />     &lt;encoding&gt;UTF-8&lt;/encoding&gt;<br />    &lt;/configuration&gt;<br />   &lt;/plugin&gt;<br /><br />   &lt;plugin&gt;<br />    &lt;artifactId&gt;maven-resources-plugin&lt;/artifactId&gt;<br />    &lt;version&gt;2.4.3&lt;/version&gt;<br />    &lt;configuration&gt;<br />     &lt;encoding&gt;UTF-8&lt;/encoding&gt;<br />    &lt;/configuration&gt;<br />   &lt;/plugin&gt;<br />  &lt;/plugins&gt;<br /> &lt;/build&gt;<br /> <br /> <br /> &lt;profiles&gt;<br />  &lt;profile&gt;<br />   &lt;id&gt;jetty6&lt;/id&gt;<br />   &lt;properties&gt;<br />    &lt;jetty.version&gt;6.1.26&lt;/jetty.version&gt;<br />   &lt;/properties&gt;<br />   &lt;build&gt;<br />    &lt;plugins&gt;<br />     &lt;plugin&gt;<br />      &lt;groupId&gt;org.mortbay.jetty&lt;/groupId&gt;<br />      &lt;artifactId&gt;maven-jetty-plugin&lt;/artifactId&gt;<br />      &lt;version&gt;${jetty.version}&lt;/version&gt;<br />      &lt;configuration&gt;<br />       &lt;scanIntervalSeconds&gt;10&lt;/scanIntervalSeconds&gt;<br />       &lt;webAppConfig&gt;<br />        &lt;contextPath&gt;/jmx-sample&lt;/contextPath&gt;<br />       &lt;/webAppConfig&gt;<br />       &lt;connectors&gt;<br />         &lt;connector implementation="org.mortbay.jetty.nio.SelectChannelConnector"&gt;<br />         &lt;port&gt;9090&lt;/port&gt;<br />         &lt;host&gt;0.0.0.0&lt;/host&gt;<br />         &lt;maxIdleTime&gt;60000&lt;/maxIdleTime&gt;<br />        &lt;/connector&gt;<br />       &lt;/connectors&gt;  <br />      &lt;/configuration&gt;<br />     &lt;/plugin&gt;<br />    &lt;/plugins&gt;<br />   &lt;/build&gt;<br />  &lt;/profile&gt;<br />  &lt;profile&gt;<br />   &lt;id&gt;jetty7&lt;/id&gt;<br />   &lt;properties&gt;<br />    &lt;jetty.version&gt;7.4.5.v20110725&lt;/jetty.version&gt;<br />   &lt;/properties&gt;<br />   &lt;build&gt;<br />    &lt;plugins&gt;<br />     &lt;plugin&gt;<br />      &lt;groupId&gt;org.mortbay.jetty&lt;/groupId&gt;<br />      &lt;artifactId&gt;jetty-maven-plugin&lt;/artifactId&gt;<br />      &lt;version&gt;${jetty.version}&lt;/version&gt;<br />      &lt;configuration&gt;<br />       &lt;scanIntervalSeconds&gt;10&lt;/scanIntervalSeconds&gt;<br />       &lt;webAppConfig&gt;<br />        &lt;contextPath&gt;/jmx-sample&lt;/contextPath&gt;<br />       &lt;/webAppConfig&gt;<br />       &lt;connectors&gt;<br />           &lt;connector implementation="org.eclipse.jetty.server.nio.SelectChannelConnector"&gt;<br />         &lt;port&gt;9090&lt;/port&gt;<br />         &lt;host&gt;0.0.0.0&lt;/host&gt;<br />         &lt;maxIdleTime&gt;60000&lt;/maxIdleTime&gt;<br />        &lt;/connector&gt;<br />       &lt;/connectors&gt;  <br />      &lt;/configuration&gt;<br />     &lt;/plugin&gt;<br />    &lt;/plugins&gt;<br />   &lt;/build&gt;<br />  &lt;/profile&gt;<br /> &lt;/profiles&gt;<br />&lt;/project&gt;<br /></pre><div style="text-align: justify;">Il n'y a rien de particulier à remarquer si ce n'est une version de plugin maven pour Jetty qui diffère, ainsi qu'un changement de package pour le SelectChannelConnector utilisé pour spécifier le port d'écoute.</div><div style="text-align: justify;">Pour démarrer notre Jetty, il ne reste plus qu'à exécuter, au choix, la commande : </div><pre class="brush:bash; wrap-lines: false; auto-links: false">mvn -Pjetty6 jetty:run</pre>ou :<br /><pre class="brush:bash; wrap-lines: false; auto-links: false">mvn -Pjetty7 jetty:run </pre><h2>  Activation de JMX</h2><div style="text-align: justify;">Après avoir montré l'application web ainsi que la configuration du  plugin Maven de Jetty nécessaire à son exécution dans le conteneur embarqué, il est possible de démarrer l'application web dans  le Jetty embedded. </div><div class="separator" style="clear: both; margin-bottom: 0px; margin-left: 0px; margin-right: 0px; margin-top: 0px; text-align: center;"><a href="http://1.bp.blogspot.com/-MC5ASoy7hYY/TnEsBl97o9I/AAAAAAAAAao/wKFzpPyRaI0/s1600/visualVM.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" height="117" src="http://1.bp.blogspot.com/-MC5ASoy7hYY/TnEsBl97o9I/AAAAAAAAAao/wKFzpPyRaI0/s320/visualVM.png" style="cursor: move;" width="320" /></a></div><div style="margin-bottom: 0px; margin-left: 0px; margin-right: 0px; margin-top: 0px;"><br /></div><div class="separator" style="clear: both; margin-bottom: 0px; margin-left: 0px; margin-right: 0px; margin-top: 0px; text-align: center;"><a href="http://1.bp.blogspot.com/-h1-h-jZ47Ys/TnEr6OFgvnI/AAAAAAAAAak/hkrxFyewmwA/s1600/jconsole.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" height="318" src="http://1.bp.blogspot.com/-h1-h-jZ47Ys/TnEr6OFgvnI/AAAAAAAAAak/hkrxFyewmwA/s320/jconsole.png" style="cursor: move;" width="320" /></a></div><div><br /></div><br /><div style="text-align: justify;">Cependant, même si nos JConsole ou VisualVM préférées proposent une connexion au MBean Server local (visible au travers notre processus Maven3 org.codehaus.plexus.classworlds.launcher.Launcher), il n'est pas possible d'effectuer une connexion en spécifiant le JMXServiceURL de type : <b>service:jmx:rmi:///jndi/rmi://localhost:1099/jmxrmi</b> .</div><div style="text-align: justify;">En effet, par défaut, Jetty ne créé pas de MBeanServer et, à fortiori, n'enregistre aucun connecteur RMI nécessaire à une application JMX cliente.</div><div style="text-align: justify;">A titre informatif, même en démarrant un serveur Jetty en mode standalone, il est nécessaire de préciser, à son démarrage, le fichier de configuration jetty-jmx.xml se trouvant, par défaut, dans son répertoire etc et qu'il faut éditer (pour préciser le port du serveur RMI à démarrer et le JMXServiceURL du connecteur JMX RMI).</div><div style="text-align: justify;">Pour Jetty 7, cela peut être fait, soit en modifiant le fichier start.ini, soit en démarrant Jetty en ligne de commande :  </div><pre class="brush:bash; wrap-lines: false; auto-links: false">java -jar start.jar etc/jetty-jmx.xml etc/jetty.xml</pre><div style="text-align: justify;">Pour Jetty 6, cela peut être fait, soit en modifiant le fichier bin/jetty-service.conf, soit en démarrant Jetty en ligne de commande : </div><pre class="brush:bash; wrap-lines: false; auto-links: false">java -DOPTIONS=jmx -jar start.jar etc/jetty-jmx.xml etc/jetty.xml</pre><br /><div style="text-align: justify;">Aussi, pour activer la création d'un serveur RMI et créer un MBean Server dans le Jetty embarqué par Maven, il est nécessaire de fournir au plugin le fichier jetty-jmx.xml.</div><div style="text-align: justify;">Pour ce faire, il est possible de spécifier une configuration à Jetty via l'élément : &lt;jettyConfig&gt; </div><pre class="brush:xml; wrap-lines: false; auto-links: false"> &lt;profiles&gt;<br />  &lt;profile&gt;<br />   &lt;id&gt;jetty6&lt;/id&gt;<br />   &lt;properties&gt;<br />    &lt;jetty.version&gt;6.1.26&lt;/jetty.version&gt;<br />   &lt;/properties&gt;<br />   &lt;build&gt;<br />    &lt;plugins&gt;<br />     &lt;plugin&gt;<br />      &lt;groupId&gt;org.mortbay.jetty&lt;/groupId&gt;<br />      &lt;artifactId&gt;maven-jetty-plugin&lt;/artifactId&gt;<br />      &lt;version&gt;${jetty.version}&lt;/version&gt;<br />      &lt;configuration&gt;<br />       &lt;scanIntervalSeconds&gt;10&lt;/scanIntervalSeconds&gt;<br />       &lt;jettyConfig&gt;${basedir}/src/config/jetty-jmx-6.xml&lt;/jettyConfig&gt;<br />       &lt;webAppConfig&gt;<br />        &lt;contextPath&gt;/jmx-sample&lt;/contextPath&gt;<br />       &lt;/webAppConfig&gt;<br />       &lt;connectors&gt;<br />         &lt;connector implementation="org.mortbay.jetty.nio.SelectChannelConnector"&gt;<br />         &lt;port&gt;9090&lt;/port&gt;<br />         &lt;host&gt;0.0.0.0&lt;/host&gt;<br />         &lt;maxIdleTime&gt;60000&lt;/maxIdleTime&gt;<br />        &lt;/connector&gt;<br />       &lt;/connectors&gt;<br />      &lt;/configuration&gt;<br />     &lt;/plugin&gt;<br />    &lt;/plugins&gt;<br />   &lt;/build&gt;<br />  &lt;/profile&gt;<br />  &lt;profile&gt;<br />   &lt;id&gt;jetty7&lt;/id&gt;<br />   &lt;properties&gt;<br />    &lt;jetty.version&gt;7.4.5.v20110725&lt;/jetty.version&gt;<br />   &lt;/properties&gt;<br />   &lt;build&gt;<br />    &lt;plugins&gt;<br />     &lt;plugin&gt;<br />      &lt;groupId&gt;org.mortbay.jetty&lt;/groupId&gt;<br />      &lt;artifactId&gt;jetty-maven-plugin&lt;/artifactId&gt;<br />      &lt;version&gt;${jetty.version}&lt;/version&gt;<br />      &lt;configuration&gt;<br />       &lt;scanIntervalSeconds&gt;10&lt;/scanIntervalSeconds&gt;<br />       &lt;jettyConfig&gt;${basedir}/src/config/jetty-jmx.xml&lt;/jettyConfig&gt;<br />       &lt;webAppConfig&gt;<br />        &lt;contextPath&gt;/jmx-sample&lt;/contextPath&gt;<br />       &lt;/webAppConfig&gt;<br />       &lt;connectors&gt;<br />           &lt;connector implementation="org.eclipse.jetty.server.nio.SelectChannelConnector"&gt;<br />         &lt;port&gt;9090&lt;/port&gt;<br />         &lt;host&gt;0.0.0.0&lt;/host&gt;<br />         &lt;maxIdleTime&gt;60000&lt;/maxIdleTime&gt;<br />        &lt;/connector&gt;<br />       &lt;/connectors&gt;  <br />      &lt;/configuration&gt;<br />     &lt;/plugin&gt;<br />    &lt;/plugins&gt;<br />   &lt;/build&gt;<br />  &lt;/profile&gt;<br /> &lt;/profiles&gt;</pre><div style="text-align: justify;">La nouvelle arborescence de notre projet devient donc :</div><div class="separator" style="clear: both; text-align: center;"><a href="http://1.bp.blogspot.com/-isxZpdoIozo/TnHVHTqIwRI/AAAAAAAAAbA/urXO-bvkGsM/s1600/jmx-sample-tree2.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" height="314" src="http://1.bp.blogspot.com/-isxZpdoIozo/TnHVHTqIwRI/AAAAAAAAAbA/urXO-bvkGsM/s320/jmx-sample-tree2.png" width="320" /></a></div><div style="text-align: justify;">En outre, il est nécessaire de démarrer la JVM avec l'option -Dcom.sun.management.jmxremote : </div><pre class="brush:bash; wrap-lines: false; auto-links: false">mvn -Dcom.sun.management.jmxremote -Pjetty6 package jetty:run</pre><pre class="brush:bash; wrap-lines: false; auto-links: false">mvn -Dcom.sun.management.jmxremote -Pjetty7 package jetty:run</pre><div style="text-align: justify;">Suite au lancement du serveur Jetty via Maven, il est alors possible d'y accéder au travers d'un client JMX en mode distant :</div><div class="separator" style="clear: both; text-align: center;"><a href="http://4.bp.blogspot.com/-neKAz6J3YXk/TnEsy6vJiZI/AAAAAAAAAa0/S8go6tW4weA/s1600/connection.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" height="231" src="http://4.bp.blogspot.com/-neKAz6J3YXk/TnEsy6vJiZI/AAAAAAAAAa0/S8go6tW4weA/s400/connection.png" width="400" /></a></div><br /><div class="separator" style="clear: both; text-align: center;"><a href="http://4.bp.blogspot.com/-FlX8ZwRcjTU/TnEsVSwh0yI/AAAAAAAAAas/VxjMj6QeEHU/s1600/visualVM2.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" height="280" src="http://4.bp.blogspot.com/-FlX8ZwRcjTU/TnEsVSwh0yI/AAAAAAAAAas/VxjMj6QeEHU/s400/visualVM2.png" width="400" /></a></div><div class="separator" style="clear: both; text-align: center;"><br /></div><div class="separator" style="clear: both; text-align: center;"><a href="http://3.bp.blogspot.com/-WYs5-5s-Aik/TnEsZ24uHdI/AAAAAAAAAaw/3bTMjhjYLdg/s1600/visualVM3.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" height="280" src="http://3.bp.blogspot.com/-WYs5-5s-Aik/TnEsZ24uHdI/AAAAAAAAAaw/3bTMjhjYLdg/s400/visualVM3.png" width="400" /></a></div><br /><div style="text-align: justify;">A titre informatif, ci-joint les fichiers de configuration de Jetty permettant la création d'un serveur RMI, du MBean Server et du connecteur RMI ainsi que de sa configuration.</div><div style="text-align: justify;">Pour Jetty 6 : </div><pre class="brush:xml; wrap-lines: false; auto-links: false">&lt;?xml version="1.0"?&gt;<br />&lt;!DOCTYPE Configure PUBLIC "-//Mort Bay Consulting//DTD Configure//EN" "http://jetty.mortbay.org/configure.dtd"&gt;<br /><br />&lt;Configure id="Server" class="org.mortbay.jetty.Server"&gt;<br />    &lt;Call id="MBeanServer" class="java.lang.management.ManagementFactory" name="getPlatformMBeanServer"/&gt;<br /><br />    &lt;Get id="Container" name="container"&gt;<br />      &lt;Call name="addEventListener"&gt;<br />        &lt;Arg&gt;<br />          &lt;New class="org.mortbay.management.MBeanContainer"&gt;<br />            &lt;Arg&gt;&lt;Ref id="MBeanServer"/&gt;&lt;/Arg&gt;<br />            &lt;Call name="start" /&gt;<br />          &lt;/New&gt;<br />        &lt;/Arg&gt;<br />      &lt;/Call&gt;<br />    &lt;/Get&gt;<br /><br />    &lt;Call id="rmiRegistry" class="java.rmi.registry.LocateRegistry" name="createRegistry"&gt;<br />      &lt;Arg type="int"&gt;1099&lt;/Arg&gt;<br />    &lt;/Call&gt;<br />    <br />    &lt;Call id="jmxConnectorServer" class="javax.management.remote.JMXConnectorServerFactory" name="newJMXConnectorServer"&gt;<br />      &lt;Arg&gt;<br />        &lt;New  class="javax.management.remote.JMXServiceURL"&gt;<br />          &lt;Arg&gt;service:jmx:rmi://localhost:1099/jndi/rmi://localhost:1099/jmxrmi&lt;/Arg&gt;<br />        &lt;/New&gt;<br />      &lt;/Arg&gt;<br />      &lt;Arg/&gt;<br />      &lt;Arg&gt;&lt;Ref id="MBeanServer"/&gt;&lt;/Arg&gt;<br />      &lt;Call name="start"/&gt;<br />    &lt;/Call&gt;<br />&lt;/Configure&gt;<br /></pre><div style="text-align: justify;">Pour Jetty 7 : </div><pre class="brush:xml; wrap-lines: false; auto-links: false">&lt;?xml version="1.0"?&gt;<br />&lt;!DOCTYPE Configure PUBLIC "-//Jetty//Configure//EN" "http://www.eclipse.org/jetty/configure.dtd"&gt;<br />&lt;Configure id="Server" class="org.eclipse.jetty.server.Server"&gt;<br /><br />  &lt;Call id="MBeanServer" class="java.lang.management.ManagementFactory"<br />    name="getPlatformMBeanServer" /&gt;<br /><br />  &lt;New id="MBeanContainer" class="org.eclipse.jetty.jmx.MBeanContainer"&gt;<br />    &lt;Arg&gt;<br />      &lt;Ref id="MBeanServer" /&gt;<br />    &lt;/Arg&gt;<br />  &lt;/New&gt;<br /><br />  &lt;Get id="Container" name="container"&gt;<br />    &lt;Call name="addEventListener"&gt;<br />      &lt;Arg&gt;<br />        &lt;Ref id="MBeanContainer" /&gt;<br />      &lt;/Arg&gt;<br />    &lt;/Call&gt;<br />  &lt;/Get&gt;<br /><br />  &lt;Call name="addBean"&gt;<br />    &lt;Arg&gt;<br />      &lt;Ref id="MBeanContainer" /&gt;<br />    &lt;/Arg&gt;<br />  &lt;/Call&gt;<br /><br />  &lt;Get id="Logger" class="org.eclipse.jetty.util.log.Log" name="log" /&gt;<br />  &lt;Ref id="MBeanContainer"&gt;<br />    &lt;Call name="addBean"&gt;<br />      &lt;Arg&gt;<br />        &lt;Ref id="Logger" /&gt;<br />      &lt;/Arg&gt;<br />    &lt;/Call&gt;<br />  &lt;/Ref&gt;<br />  <br />  &lt;Call name="createRegistry" class="java.rmi.registry.LocateRegistry"&gt;<br />    &lt;Arg type="java.lang.Integer"&gt;1099&lt;/Arg&gt;<br />    &lt;Call name="sleep" class="java.lang.Thread"&gt;<br />       &lt;Arg type="java.lang.Integer"&gt;1000&lt;/Arg&gt;<br />    &lt;/Call&gt;<br />  &lt;/Call&gt;<br /> <br /> &lt;New id="ConnectorServer" class="org.eclipse.jetty.jmx.ConnectorServer"&gt;<br />    &lt;Arg&gt;<br />      &lt;New class="javax.management.remote.JMXServiceURL"&gt;<br />        &lt;Arg type="java.lang.String"&gt;rmi&lt;/Arg&gt;<br />        &lt;Arg type="java.lang.String" /&gt;<br />        &lt;Arg type="java.lang.Integer"&gt;0&lt;/Arg&gt;<br />        &lt;Arg type="java.lang.String"&gt;/jndi/rmi://localhost:1099/jmxrmi&lt;/Arg&gt;<br />      &lt;/New&gt;<br />    &lt;/Arg&gt;<br />    &lt;Arg&gt;org.eclipse.jetty:name=rmiconnectorserver&lt;/Arg&gt;<br />    &lt;Call name="start" /&gt;<br />  &lt;/New&gt;<br />&lt;/Configure&gt;<br /></pre><h1>  Conclusion</h1><div style="text-align: justify;">Cet article avait pour objectif de montrer comment il pouvait être facile d'activer la couche JMX pour un serveur Jetty embedded dans Maven.</div><div style="text-align: justify;">C'est vrai que démarrer un Jetty embarqué n'a pas pour objectif de faire des tests d'intégration mais cela peut toujours être utile dans le cas d'un POC ou d'une démonstration (qui était d'ailleurs l'objectif de ce petit cas d'usage. ;-) ).</div></div>
<h2>Comments</h2>
<div class='comments'>
<div class='comment'>
<div class='author'>Brice</div>
<div class='content'>
Hello Khanh,<br /><br />Je dépile progressivement les articles de blog. Merci pour ça, c&#39;est vrai qu&#39;il fallait chercher. Tu peux nous faire ça pour Weblogic maintenant (bien sur en dehors de maven) ;)<br /><br />Merci pour l&#39;article<br />A+</div>
</div>
<div class='comment'>
<div class='author'>Khanh</div>
<div class='content'>
Salut José!<br />Merci pour le commentaire. En fait, ce qui n&#39;est pas écrit c&#39;est que j&#39;ai vachement galéré pour trouver une information cohérente pour activer la couche jmx dans le plugin. <br />Par contre, chose marrante, c&#39;est que, maintenant, si je cherche l&#39;information, je tombe tout de suite dessus... <br />Enfin, l&#39;important c&#39;est que ça marche et que j&#39;ai compris pourquoi ;-)<br />A+</div>
</div>
<div class='comment'>
<div class='author'>José Paumard</div>
<div class='content'>
&quot;montrer comment il pouvait être facile...&quot;<br />Une fois que l&#39;on a la solution sous les yeux, effectivement, c&#39;est &quot;facile&quot; de la lire...<br />Bravo pour l&#39;avoir écrite !</div>
</div>
</div>
