<!DOCTYPE html>
<html lang="en">

<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="">
  <meta name="generator" content="Hugo 0.111.3">

  <title>Hadoop Unit &middot; Jetoile</title>

    

  
  
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/pure/1.0.0/pure-min.css">

  <!--[if lte IE 8]>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/pure/1.0.0/grids-responsive-old-ie-min.css">
  <![endif]-->
  <!--[if gt IE 8]><!-->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/pure/1.0.0/grids-responsive-min.css">
  <!--<![endif]-->

  <!--[if lte IE 8]>
  <link rel="stylesheet" href="https://blog.jetoile.fr/css/side-menu-old-ie.css">
  <![endif]-->
  <!--[if gt IE 8]><!-->
  <link rel="stylesheet" href="https://blog.jetoile.fr/css/side-menu.css">
  <!--<![endif]-->

  <link rel="stylesheet" href="https://blog.jetoile.fr/css/blackburn.css">

  
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.2/css/all.min.css">

  
  <link rel="preconnect" href="https://fonts.gstatic.com">
  <link href="https://fonts.googleapis.com/css2?family=Raleway&display=swap" rel="stylesheet" type="text/css">

  
  <script async src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.9/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

 
  

  
  <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/10.6.0/styles/androidstudio.min.css">
  <script async src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/10.6.0/highlight.min.js"></script>
  
  <script async src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/10.6.0/languages/yaml.min.js"></script>
  
  <script>hljs.initHighlightingOnLoad();</script>
  

  <link rel="shortcut icon" href="https://blog.jetoile.fr/img/favicon.ico" type="image/x-icon" />

  
    
        <link rel="stylesheet" href="https://blog.jetoile.fr/css/my.css">
    
  
  
    
        <script src="https://blog.jetoile.fr/js/my.js"></script>
    
  

</head>


<body>
<div id="layout">

  
<a href="#menu" id="menuLink" class="menu-link">
  
  <span></span>
</a>
<div id="menu">

  
  <a class="pure-menu-heading brand" href="https://blog.jetoile.fr/">Jetoile</a>


  <div class="pure-menu">
    <ul class="pure-menu-list">
      
      
        <li class="pure-menu-item">
          <a class="pure-menu-link" href="https://blog.jetoile.fr/"><i class='fa fa-home fa-fw'></i>Home</a>
      
        </li>
      
      
        <li class="pure-menu-item">
          <a class="pure-menu-link" href="https://blog.jetoile.fr/post.html"><i class='fa fa-list fa-fw'></i>Posts</a>
      
        </li>
      
      
        <li class="pure-menu-item">
          <a class="pure-menu-link" href="https://blog.jetoile.fr/about.html"><i class='fa fa-user fa-fw'></i>About</a>
      
        </li>
      
      
        <li class="pure-menu-item">
          <a class="pure-menu-link" href="https://blog.jetoile.fr/contact.html"><i class='fa fa-phone fa-fw'></i>Contact</a>
      
        </li>
      
      
        <li class="pure-menu-item">
          <a class="pure-menu-link" href="https://blog.jetoile.fr/hadoop-unit"><i class='fa fa-list fa-fw'></i>Hadoop Unit</a>
      
        </li>
      
    </ul>
  </div>

  <div class="pure-menu social">
  <ul class="pure-menu-list">

    

    

    
    <li class="pure-menu-item">
      <a class="pure-menu-link" href="https://twitter.com/jetoile" rel="me" target="_blank"><i class="fab fa-twitter-square fa-fw"></i>Twitter</a>
    </li>
    

    

    

    

    

    

    

    

    

    

    

    

    

    
    <li class="pure-menu-item">
      <a class="pure-menu-link" href="http://slideshare.net/jetoile" rel="me" target="_blank"><i class="fab fa-slideshare fa-fw"></i>SlideShare</a>
    </li>
    

    

    
    <li class="pure-menu-item">
      <a class="pure-menu-link" href="https://linkedin.com/in/khanh-tuong-maudoux-11b92b19" rel="me" target="_blank"><i class="fab fa-linkedin fa-fw"></i>LinkedIn</a>
    </li>
    

    

    

    

    

    

    
    <li class="pure-menu-item">
      <a class="pure-menu-link" href="https://github.com/jetoile" rel="me" target="_blank"><i class="fab fa-github-square fa-fw"></i>GitHub</a>
    </li>
    

    

    

    

    

    

    

    

    

    

    

    

    

  </ul>
</div>


  <div>
  <div class="small-print">
    <small><a href='http://creativecommons.org/licenses/by/4.0/' rel='license'><img alt='Licence Creative Commons' src='https://blog.jetoile.fr/images/creative_common88x31.png' style='border-width:0'/></a></small>
  </div>
  <div class="small-print">
    <small>Built with&nbsp;<a href="https://gohugo.io/" target="_blank">Hugo</a></small>
    <small>Theme&nbsp;<a href="https://github.com/yoshiharuyamashita/blackburn" target="_blank">Blackburn</a></small>
  </div>
</div>

</div>


  <div id="main">


<div class="header">
  <h1>Hadoop Unit</h1>
  <h2></h2>
</div>
<div class="content">

  <div class="post-meta">

  <div>
    <i class="fa fa-calendar fa-fw"></i>
    <time>16 Apr 2016</time>
  </div>

  

  

  
  
  
  <div>
    <i class="fa fa-tags fa-fw"></i>
    
      <a class="post-taxonomy-tag" href="https://blog.jetoile.fr/tags/hadoop">Hadoop</a>
    
  </div>
  
  

</div>

  <p><img src="https://blog.jetoile.fr/images/hadoop-all.png" alt="left-small">
Dans mon dernier <a href="https://blog.jetoile.fr/2016/01/hadoop-ecosysteme-bootstrap.html">post</a>, j&rsquo;avais parlé d&rsquo;une surcouche que j&rsquo;avais développé afin de faciliter l&rsquo;utilisation de quelques-uns des composants de l&rsquo;écosystème Hadoop, à savoir :</p>
<ul>
<li>Hdfs,</li>
<li>Zookeeper,</li>
<li>HiveMetastore,</li>
<li>Hiveserver2,</li>
<li>SolR,</li>
<li>SolRCloud,</li>
<li>Oozie,</li>
<li>Kafka,</li>
<li>HBase,</li>
<li>MongoDB [New \o/ ],</li>
<li>et Cassandra [New \o/ ].</li>
</ul>
<p>Il s&rsquo;appelait alors Hadoop-Bootstrap mais il s&rsquo;agissait aussi d&rsquo;une première version qui a, bien sûr, évolué.</p>
<p>Cet article présentera donc quels ont été les améliorations qui ont été apportées.</p>
<p><em>Disclaimer</em> : je tiens à repréciser que Hadoop-unit n&rsquo;est qu&rsquo;une solution de contournement permettant de simuler une partie de l&rsquo;écosystème Hadoop afin de permettre de disposer en local d&rsquo;un ersatz de distribution afin de fluidifier le développement mais proposant aussi d&rsquo;effectuer des tests d&rsquo;intégration dans un environnement dégradé. Cela peut également permettre d&rsquo;éviter de monter un cluster Hadoop dédié aux tests d&rsquo;intégration.</p>
<!-- more -->
<h1 id="description-des-changementsévolutions">Description des changements/évolutions</h1>
<p>Alors que la première version d&rsquo;Hadoop Unit (aka. Hadoop Bootstrap) était monolithique, le projet a été découpé en modules permettant ainsi de ne démarrer que les composants qui sont présents dans le classpath de l&rsquo;environnement de test (en maven le scope de test).</p>
<p>Ainsi, par exemple, si l&rsquo;application nécessite HBase (qui nécessite lui-même Hdfs et Zookeeper), il n&rsquo;y a qu&rsquo;à ajouter au classpath de test la dépendance à HBase.</p>
<p>Dans ce cas, grâce à la transitivité Maven, les modules Zookeeper et Hdfs seront automatiquement ajoutés au classpath de test et les composants démarrés avant HBase.</p>
<p>En outre, cela permet de ne pas à avoir à se soucier de l&rsquo;ordre de démarrage.</p>
<p>Pour information, afin de permettre ce mécanisme, il y a dernier un simple SPI.</p>
<p>Ainsi dans un exemple, cela peut donner :</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-xml" data-lang="xml"><span style="display:flex;"><span><span style="color:#f92672">&lt;dependency&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;groupId&gt;</span>fr.jetoile.hadoop<span style="color:#f92672">&lt;/groupId&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;artifactId&gt;</span>hadoop-unit-hbase<span style="color:#f92672">&lt;/artifactId&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;version&gt;</span>1.2-SNAPSHOT<span style="color:#f92672">&lt;/version&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;scope&gt;</span>test<span style="color:#f92672">&lt;/scope&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">&lt;/dependency&gt;</span>
</span></span></code></pre></div><p>avec dans le test d&rsquo;intégration :</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#a6e22e">@BeforeClass</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">setup</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    HadoopBootstrap<span style="color:#f92672">.</span><span style="color:#a6e22e">INSTANCE</span><span style="color:#f92672">.</span><span style="color:#a6e22e">startAll</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@AfterClass</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">tearDown</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    HadoopBootstrap<span style="color:#f92672">.</span><span style="color:#a6e22e">INSTANCE</span><span style="color:#f92672">.</span><span style="color:#a6e22e">stopAll</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@Test</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">hBaseShouldStart</span><span style="color:#f92672">()</span> <span style="color:#66d9ef">throws</span> Exception <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    String tableName <span style="color:#f92672">=</span> configuration<span style="color:#f92672">.</span><span style="color:#a6e22e">getString</span><span style="color:#f92672">(</span>Config<span style="color:#f92672">.</span><span style="color:#a6e22e">HBASE_TEST_TABLE_NAME_KEY</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>    String colFamName <span style="color:#f92672">=</span> configuration<span style="color:#f92672">.</span><span style="color:#a6e22e">getString</span><span style="color:#f92672">(</span>Config<span style="color:#f92672">.</span><span style="color:#a6e22e">HBASE_TEST_COL_FAMILY_NAME_KEY</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>    String colQualiferName <span style="color:#f92672">=</span> configuration<span style="color:#f92672">.</span><span style="color:#a6e22e">getString</span><span style="color:#f92672">(</span>Config<span style="color:#f92672">.</span><span style="color:#a6e22e">HBASE_TEST_COL_QUALIFIER_NAME_KEY</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>    Integer numRowsToPut <span style="color:#f92672">=</span> configuration<span style="color:#f92672">.</span><span style="color:#a6e22e">getInt</span><span style="color:#f92672">(</span>Config<span style="color:#f92672">.</span><span style="color:#a6e22e">HBASE_TEST_NUM_ROWS_TO_PUT_KEY</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    org<span style="color:#f92672">.</span><span style="color:#a6e22e">apache</span><span style="color:#f92672">.</span><span style="color:#a6e22e">hadoop</span><span style="color:#f92672">.</span><span style="color:#a6e22e">conf</span><span style="color:#f92672">.</span><span style="color:#a6e22e">Configuration</span> hbaseConfiguration <span style="color:#f92672">=</span> HBaseConfiguration<span style="color:#f92672">.</span><span style="color:#a6e22e">create</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>    hbaseConfiguration<span style="color:#f92672">.</span><span style="color:#a6e22e">set</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;hbase.zookeeper.quorum&#34;</span><span style="color:#f92672">,</span> configuration<span style="color:#f92672">.</span><span style="color:#a6e22e">getString</span><span style="color:#f92672">(</span>Config<span style="color:#f92672">.</span><span style="color:#a6e22e">ZOOKEEPER_HOST_KEY</span><span style="color:#f92672">));</span>
</span></span><span style="display:flex;"><span>    hbaseConfiguration<span style="color:#f92672">.</span><span style="color:#a6e22e">setInt</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;hbase.zookeeper.property.clientPort&#34;</span><span style="color:#f92672">,</span> configuration<span style="color:#f92672">.</span><span style="color:#a6e22e">getInt</span><span style="color:#f92672">(</span>Config<span style="color:#f92672">.</span><span style="color:#a6e22e">ZOOKEEPER_PORT_KEY</span><span style="color:#f92672">));</span>
</span></span><span style="display:flex;"><span>    hbaseConfiguration<span style="color:#f92672">.</span><span style="color:#a6e22e">set</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;hbase.master&#34;</span><span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;127.0.0.1:&#34;</span> <span style="color:#f92672">+</span> configuration<span style="color:#f92672">.</span><span style="color:#a6e22e">getInt</span><span style="color:#f92672">(</span>Config<span style="color:#f92672">.</span><span style="color:#a6e22e">HBASE_MASTER_PORT_KEY</span><span style="color:#f92672">));</span>
</span></span><span style="display:flex;"><span>    hbaseConfiguration<span style="color:#f92672">.</span><span style="color:#a6e22e">set</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;zookeeper.znode.parent&#34;</span><span style="color:#f92672">,</span> configuration<span style="color:#f92672">.</span><span style="color:#a6e22e">getString</span><span style="color:#f92672">(</span>Config<span style="color:#f92672">.</span><span style="color:#a6e22e">HBASE_ZNODE_PARENT_KEY</span><span style="color:#f92672">));</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    LOGGER<span style="color:#f92672">.</span><span style="color:#a6e22e">info</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;HBASE: Creating table {} with column family {}&#34;</span><span style="color:#f92672">,</span> tableName<span style="color:#f92672">,</span> colFamName<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>    createHbaseTable<span style="color:#f92672">(</span>tableName<span style="color:#f92672">,</span> colFamName<span style="color:#f92672">,</span> hbaseConfiguration<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    LOGGER<span style="color:#f92672">.</span><span style="color:#a6e22e">info</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;HBASE: Populate the table with {} rows.&#34;</span><span style="color:#f92672">,</span> numRowsToPut<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> <span style="color:#f92672">(</span><span style="color:#66d9ef">int</span> i <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span><span style="color:#f92672">;</span> i <span style="color:#f92672">&lt;</span> numRowsToPut<span style="color:#f92672">;</span> i<span style="color:#f92672">++)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        putRow<span style="color:#f92672">(</span>tableName<span style="color:#f92672">,</span> colFamName<span style="color:#f92672">,</span> String<span style="color:#f92672">.</span><span style="color:#a6e22e">valueOf</span><span style="color:#f92672">(</span>i<span style="color:#f92672">),</span> colQualiferName<span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;row_&#34;</span> <span style="color:#f92672">+</span> i<span style="color:#f92672">,</span> hbaseConfiguration<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    LOGGER<span style="color:#f92672">.</span><span style="color:#a6e22e">info</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;HBASE: Fetching and comparing the results&#34;</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> <span style="color:#f92672">(</span><span style="color:#66d9ef">int</span> i <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span><span style="color:#f92672">;</span> i <span style="color:#f92672">&lt;</span> numRowsToPut<span style="color:#f92672">;</span> i<span style="color:#f92672">++)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        Result result <span style="color:#f92672">=</span> getRow<span style="color:#f92672">(</span>tableName<span style="color:#f92672">,</span> colFamName<span style="color:#f92672">,</span> String<span style="color:#f92672">.</span><span style="color:#a6e22e">valueOf</span><span style="color:#f92672">(</span>i<span style="color:#f92672">),</span> colQualiferName<span style="color:#f92672">,</span> hbaseConfiguration<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>        assertEquals<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;row_&#34;</span> <span style="color:#f92672">+</span> i<span style="color:#f92672">,</span> <span style="color:#66d9ef">new</span> String<span style="color:#f92672">(</span>result<span style="color:#f92672">.</span><span style="color:#a6e22e">value</span><span style="color:#f92672">()));</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><p>Bien sûr, il reste possible de préciser les composants à démarrer mais, dans ce cas, il est à la charge du développeur de vérifier que les modules sont bien dans son classpath et qu&rsquo;il démarre bien les composants dans le bon ordre.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#a6e22e">@BeforeClass</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">setup</span><span style="color:#f92672">()</span> <span style="color:#66d9ef">throws</span> NotFoundServiceException <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    HadoopBootstrap<span style="color:#f92672">.</span><span style="color:#a6e22e">INSTANCE</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">.</span><span style="color:#a6e22e">start</span><span style="color:#f92672">(</span>Component<span style="color:#f92672">.</span><span style="color:#a6e22e">ZOOKEEPER</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">.</span><span style="color:#a6e22e">start</span><span style="color:#f92672">(</span>Component<span style="color:#f92672">.</span><span style="color:#a6e22e">HDFS</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">.</span><span style="color:#a6e22e">start</span><span style="color:#f92672">(</span>Component<span style="color:#f92672">.</span><span style="color:#a6e22e">HBASE</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">.</span><span style="color:#a6e22e">startAll</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@AfterClass</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">tearDown</span><span style="color:#f92672">()</span> <span style="color:#66d9ef">throws</span> NotFoundServiceException <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    HadoopBootstrap<span style="color:#f92672">.</span><span style="color:#a6e22e">INSTANCE</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">.</span><span style="color:#a6e22e">stopAll</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><p>Enfin, il a été ajouté un plugin Maven permettant de démarrer les composants de l&rsquo;écosystème :</p>
<ul>
<li>soit dans le même classloader que le test,</li>
<li>soit de démarrer hadoop unit dans une autre jvm modulo que hadoop-unit-standalone ait été installé sur le poste en local.</li>
</ul>
<p>Ce dernier mode est celui à privilégier dans les tests d&rsquo;intégration car cela évite les problèmes de conflits de dépendances engendrés par le fait que tous les composants d&rsquo;Hadoop Unit s&rsquo;éxécute dans la même JVM (chose qui bien sûr n&rsquo;est pas le cas dans le vraie vie&hellip;).</p>
<p>Ainsi, en mode embedded, le plugin peut s&rsquo;utiliser de la manière suivante :</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-xml" data-lang="xml"><span style="display:flex;"><span><span style="color:#f92672">&lt;dependencies&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;dependency&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&lt;groupId&gt;</span>junit<span style="color:#f92672">&lt;/groupId&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&lt;artifactId&gt;</span>junit<span style="color:#f92672">&lt;/artifactId&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&lt;version&gt;</span>4.11<span style="color:#f92672">&lt;/version&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&lt;scope&gt;</span>test<span style="color:#f92672">&lt;/scope&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;/dependency&gt;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;dependency&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&lt;groupId&gt;</span>fr.jetoile.hadoop<span style="color:#f92672">&lt;/groupId&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&lt;artifactId&gt;</span>hadoop-unit-hdfs<span style="color:#f92672">&lt;/artifactId&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&lt;version&gt;</span>1.2-SNAPSHOT<span style="color:#f92672">&lt;/version&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&lt;scope&gt;</span>test<span style="color:#f92672">&lt;/scope&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;/dependency&gt;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;dependency&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&lt;groupId&gt;</span>fr.jetoile.hadoop<span style="color:#f92672">&lt;/groupId&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&lt;artifactId&gt;</span>hadoop-unit-client-hdfs<span style="color:#f92672">&lt;/artifactId&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&lt;version&gt;</span>1.2-SNAPSHOT<span style="color:#f92672">&lt;/version&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&lt;scope&gt;</span>test<span style="color:#f92672">&lt;/scope&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;/dependency&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">&lt;/dependencies&gt;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">&lt;build&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;plugins&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&lt;plugin&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&lt;groupId&gt;</span>org.apache.maven.plugins<span style="color:#f92672">&lt;/groupId&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&lt;artifactId&gt;</span>maven-surefire-plugin<span style="color:#f92672">&lt;/artifactId&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&lt;configuration&gt;</span>
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">&lt;excludes&gt;</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#f92672">&lt;exclude&gt;</span>**/*IntegrationTest.java<span style="color:#f92672">&lt;/exclude&gt;</span>
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">&lt;/excludes&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&lt;/configuration&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&lt;executions&gt;</span>
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">&lt;execution&gt;</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#f92672">&lt;id&gt;</span>integration-test<span style="color:#f92672">&lt;/id&gt;</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#f92672">&lt;goals&gt;</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#f92672">&lt;goal&gt;</span>test<span style="color:#f92672">&lt;/goal&gt;</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#f92672">&lt;/goals&gt;</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#f92672">&lt;phase&gt;</span>integration-test<span style="color:#f92672">&lt;/phase&gt;</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#f92672">&lt;configuration&gt;</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#f92672">&lt;excludes&gt;</span>
</span></span><span style="display:flex;"><span>                            <span style="color:#f92672">&lt;exclude&gt;</span>none<span style="color:#f92672">&lt;/exclude&gt;</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#f92672">&lt;/excludes&gt;</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#f92672">&lt;includes&gt;</span>
</span></span><span style="display:flex;"><span>                            <span style="color:#f92672">&lt;include&gt;</span>**/*IntegrationTest.java<span style="color:#f92672">&lt;/include&gt;</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#f92672">&lt;/includes&gt;</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#f92672">&lt;/configuration&gt;</span>
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">&lt;/execution&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&lt;/executions&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&lt;/plugin&gt;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&lt;plugin&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&lt;artifactId&gt;</span>hadoop-unit-maven-plugin<span style="color:#f92672">&lt;/artifactId&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&lt;groupId&gt;</span>fr.jetoile.hadoop<span style="color:#f92672">&lt;/groupId&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&lt;version&gt;</span>1.2-SNAPSHOT<span style="color:#f92672">&lt;/version&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&lt;executions&gt;</span>
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">&lt;execution&gt;</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#f92672">&lt;id&gt;</span>start<span style="color:#f92672">&lt;/id&gt;</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#f92672">&lt;goals&gt;</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#f92672">&lt;goal&gt;</span>embedded-start<span style="color:#f92672">&lt;/goal&gt;</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#f92672">&lt;/goals&gt;</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#f92672">&lt;phase&gt;</span>pre-integration-test<span style="color:#f92672">&lt;/phase&gt;</span>
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">&lt;/execution&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&lt;/executions&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&lt;configuration&gt;</span>
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">&lt;values&gt;</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#f92672">&lt;value&gt;</span>HDFS<span style="color:#f92672">&lt;/value&gt;</span>
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">&lt;/values&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&lt;/configuration&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&lt;/plugin&gt;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;/plugins&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">&lt;/build&gt;</span>
</span></span></code></pre></div><p>avec :</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">HdfsBootstrapIntegrationTest</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">private</span> Configuration configuration<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">@BeforeClass</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">setup</span><span style="color:#f92672">()</span> <span style="color:#66d9ef">throws</span> BootstrapException <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">try</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            configuration <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> PropertiesConfiguration<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;default.properties&#34;</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span> <span style="color:#66d9ef">catch</span> <span style="color:#f92672">(</span>ConfigurationException e<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> BootstrapException<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;bad config&#34;</span><span style="color:#f92672">,</span> e<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">@Test</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">hdfsShouldStart</span><span style="color:#f92672">()</span> <span style="color:#66d9ef">throws</span> Exception <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        FileSystem hdfsFsHandle <span style="color:#f92672">=</span> HdfsUtils<span style="color:#f92672">.</span><span style="color:#a6e22e">INSTANCE</span><span style="color:#f92672">.</span><span style="color:#a6e22e">getFileSystem</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        FSDataOutputStream writer <span style="color:#f92672">=</span> hdfsFsHandle<span style="color:#f92672">.</span><span style="color:#a6e22e">create</span><span style="color:#f92672">(</span><span style="color:#66d9ef">new</span> Path<span style="color:#f92672">(</span>configuration<span style="color:#f92672">.</span><span style="color:#a6e22e">getString</span><span style="color:#f92672">(</span>Config<span style="color:#f92672">.</span><span style="color:#a6e22e">HDFS_TEST_FILE_KEY</span><span style="color:#f92672">)));</span>
</span></span><span style="display:flex;"><span>        writer<span style="color:#f92672">.</span><span style="color:#a6e22e">writeUTF</span><span style="color:#f92672">(</span>configuration<span style="color:#f92672">.</span><span style="color:#a6e22e">getString</span><span style="color:#f92672">(</span>Config<span style="color:#f92672">.</span><span style="color:#a6e22e">HDFS_TEST_STRING_KEY</span><span style="color:#f92672">));</span>
</span></span><span style="display:flex;"><span>        writer<span style="color:#f92672">.</span><span style="color:#a6e22e">close</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// Read the file and compare to test string
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        FSDataInputStream reader <span style="color:#f92672">=</span> hdfsFsHandle<span style="color:#f92672">.</span><span style="color:#a6e22e">open</span><span style="color:#f92672">(</span><span style="color:#66d9ef">new</span> Path<span style="color:#f92672">(</span>configuration<span style="color:#f92672">.</span><span style="color:#a6e22e">getString</span><span style="color:#f92672">(</span>Config<span style="color:#f92672">.</span><span style="color:#a6e22e">HDFS_TEST_FILE_KEY</span><span style="color:#f92672">)));</span>
</span></span><span style="display:flex;"><span>        assertEquals<span style="color:#f92672">(</span>reader<span style="color:#f92672">.</span><span style="color:#a6e22e">readUTF</span><span style="color:#f92672">(),</span> configuration<span style="color:#f92672">.</span><span style="color:#a6e22e">getString</span><span style="color:#f92672">(</span>Config<span style="color:#f92672">.</span><span style="color:#a6e22e">HDFS_TEST_STRING_KEY</span><span style="color:#f92672">));</span>
</span></span><span style="display:flex;"><span>        reader<span style="color:#f92672">.</span><span style="color:#a6e22e">close</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>        hdfsFsHandle<span style="color:#f92672">.</span><span style="color:#a6e22e">close</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        URL url <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> URL<span style="color:#f92672">(</span>String<span style="color:#f92672">.</span><span style="color:#a6e22e">format</span><span style="color:#f92672">(</span> <span style="color:#e6db74">&#34;http://localhost:%s/webhdfs/v1?op=GETHOMEDIRECTORY&amp;user.name=guest&#34;</span><span style="color:#f92672">,</span>
</span></span><span style="display:flex;"><span>                        configuration<span style="color:#f92672">.</span><span style="color:#a6e22e">getInt</span><span style="color:#f92672">(</span> Config<span style="color:#f92672">.</span><span style="color:#a6e22e">HDFS_NAMENODE_HTTP_PORT_KEY</span> <span style="color:#f92672">)</span> <span style="color:#f92672">)</span> <span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>        URLConnection connection <span style="color:#f92672">=</span> url<span style="color:#f92672">.</span><span style="color:#a6e22e">openConnection</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>        connection<span style="color:#f92672">.</span><span style="color:#a6e22e">setRequestProperty</span><span style="color:#f92672">(</span> <span style="color:#e6db74">&#34;Accept-Charset&#34;</span><span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;UTF-8&#34;</span> <span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>        BufferedReader response <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> BufferedReader<span style="color:#f92672">(</span> <span style="color:#66d9ef">new</span> InputStreamReader<span style="color:#f92672">(</span> connection<span style="color:#f92672">.</span><span style="color:#a6e22e">getInputStream</span><span style="color:#f92672">()</span> <span style="color:#f92672">)</span> <span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>        String line <span style="color:#f92672">=</span> response<span style="color:#f92672">.</span><span style="color:#a6e22e">readLine</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>        response<span style="color:#f92672">.</span><span style="color:#a6e22e">close</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>        assertThat<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;{\&#34;Path\&#34;:\&#34;/user/guest\&#34;}&#34;</span><span style="color:#f92672">).</span><span style="color:#a6e22e">isEqualTo</span><span style="color:#f92672">(</span>line<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><p>En utilisation remote, cela donne :</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-xml" data-lang="xml"><span style="display:flex;"><span><span style="color:#f92672">&lt;dependencies&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;dependency&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&lt;groupId&gt;</span>junit<span style="color:#f92672">&lt;/groupId&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&lt;artifactId&gt;</span>junit<span style="color:#f92672">&lt;/artifactId&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&lt;version&gt;</span>4.11<span style="color:#f92672">&lt;/version&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&lt;scope&gt;</span>test<span style="color:#f92672">&lt;/scope&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;/dependency&gt;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;dependency&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&lt;groupId&gt;</span>fr.jetoile.hadoop<span style="color:#f92672">&lt;/groupId&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&lt;artifactId&gt;</span>hadoop-unit-client-hdfs<span style="color:#f92672">&lt;/artifactId&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&lt;version&gt;</span>1.2-SNAPSHOT<span style="color:#f92672">&lt;/version&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&lt;scope&gt;</span>test<span style="color:#f92672">&lt;/scope&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;/dependency&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">&lt;/dependencies&gt;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">&lt;plugin&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;groupId&gt;</span>org.apache.maven.plugins<span style="color:#f92672">&lt;/groupId&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;artifactId&gt;</span>maven-surefire-plugin<span style="color:#f92672">&lt;/artifactId&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;configuration&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&lt;excludes&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&lt;exclude&gt;</span>**/*IntegrationTest.java<span style="color:#f92672">&lt;/exclude&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&lt;/excludes&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;/configuration&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;executions&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&lt;execution&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&lt;id&gt;</span>integration-test<span style="color:#f92672">&lt;/id&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&lt;goals&gt;</span>
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">&lt;goal&gt;</span>test<span style="color:#f92672">&lt;/goal&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&lt;/goals&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&lt;phase&gt;</span>integration-test<span style="color:#f92672">&lt;/phase&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&lt;configuration&gt;</span>
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">&lt;excludes&gt;</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#f92672">&lt;exclude&gt;</span>none<span style="color:#f92672">&lt;/exclude&gt;</span>
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">&lt;/excludes&gt;</span>
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">&lt;includes&gt;</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#f92672">&lt;include&gt;</span>**/*IntegrationTest.java<span style="color:#f92672">&lt;/include&gt;</span>
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">&lt;/includes&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&lt;/configuration&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&lt;/execution&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;/executions&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">&lt;/plugin&gt;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">&lt;plugin&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;artifactId&gt;</span>hadoop-unit-maven-plugin<span style="color:#f92672">&lt;/artifactId&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;groupId&gt;</span>fr.jetoile.hadoop<span style="color:#f92672">&lt;/groupId&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;version&gt;</span>1.2-SNAPSHOT<span style="color:#f92672">&lt;/version&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;executions&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&lt;execution&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&lt;id&gt;</span>start<span style="color:#f92672">&lt;/id&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&lt;goals&gt;</span>
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">&lt;goal&gt;</span>start<span style="color:#f92672">&lt;/goal&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&lt;/goals&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&lt;phase&gt;</span>pre-integration-test<span style="color:#f92672">&lt;/phase&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&lt;/execution&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;/executions&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;configuration&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&lt;hadoopUnitPath&gt;</span>/home/khanh/tools/hadoop-unit-standalone<span style="color:#f92672">&lt;/hadoopUnitPath&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&lt;exec&gt;</span>./hadoop-unit-standalone<span style="color:#f92672">&lt;/exec&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&lt;values&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&lt;value&gt;</span>HDFS<span style="color:#f92672">&lt;/value&gt;</span>         
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&lt;/values&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&lt;outputFile&gt;</span>/tmp/toto.txt<span style="color:#f92672">&lt;/outputFile&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;/configuration&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">&lt;/plugin&gt;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">&lt;plugin&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;artifactId&gt;</span>hadoop-unit-maven-plugin<span style="color:#f92672">&lt;/artifactId&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;groupId&gt;</span>fr.jetoile.hadoop<span style="color:#f92672">&lt;/groupId&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;version&gt;</span>1.2-SNAPSHOT<span style="color:#f92672">&lt;/version&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;executions&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&lt;execution&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&lt;id&gt;</span>stop<span style="color:#f92672">&lt;/id&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&lt;goals&gt;</span>
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">&lt;goal&gt;</span>stop<span style="color:#f92672">&lt;/goal&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&lt;/goals&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&lt;phase&gt;</span>post-integration-test<span style="color:#f92672">&lt;/phase&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&lt;/execution&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;/executions&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;configuration&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&lt;hadoopUnitPath&gt;</span>/home/khanh/tools/hadoop-unit-standalone<span style="color:#f92672">&lt;/hadoopUnitPath&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&lt;exec&gt;</span>./hadoop-unit-standalone<span style="color:#f92672">&lt;/exec&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&lt;outputFile&gt;</span>/tmp/toto.txt<span style="color:#f92672">&lt;/outputFile&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;/configuration&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">&lt;/plugin&gt;</span>
</span></span></code></pre></div><h1 id="trucs-et-astuces">Trucs et astuces</h1>
<p>Il est possible d&rsquo;intéragir avec Hadoop Unit (et même si il s&rsquo;agit d&rsquo;un cluster Hadoop dégradé) avec les moyens standards, à savoir :</p>
<ul>
<li>hbase shell</li>
<li>kafka-console commande</li>
<li>hdfs commande</li>
<li>hive shell</li>
</ul>
<p>Ainsi, il devient possible de faire des choses comme :</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>kafka-console-consumer --zookeeper localhost:22010 --topic topic
</span></span><span style="display:flex;"><span>hdfs dfs -ls hdfs://localhost:20112/
</span></span></code></pre></div><p>ou lancer un hbase shell ou hive shell pour créer des tables ou des tables hive et/ou peupler et/ou requêter ces derniers.</p>
<p>Hadoop Unit propose également des classes utilitaires (à n&rsquo;utiliser que dans le contexte des tests bien sûr!) qui lisent directement la configuration d&rsquo;Hadoop Unit (le fichier <code>default.properties</code>) et qui permettent de bénéficier simplement :</p>
<ul>
<li>d&rsquo;un FileSystem Hdfs</li>
<li>d&rsquo;avoir une syntaxe fluent pour créer les tables hive via jdbc (cette partie est directement tirée de <a href="http://dbsetup.ninja-squad.com/">DBSetup</a> de <a href="http://ninja-squad.com/">Ninja Squad</a>)</li>
<li>des bonnes dépendances pour utiliser Spark 1.6.0 (cf. conflit de lib)</li>
<li>des bonnes dépendances pour utiliser Spark-solr (cf. conflit de lib)</li>
</ul>
<h1 id="conclusion">Conclusion</h1>
<p>Comme je l&rsquo;ai déjà dit maintes et maintes fois, Hadoop Unit n&rsquo;est qu&rsquo;une solution de contournement (ou la solution du pauvre au choix&hellip; ;) ) mais cela peut permettre d&rsquo;accélérer les phases de développement (en utilisant hadoop-unit-standalone par exemple) et peut permettre d&rsquo;effectuer quelques tests d&rsquo;intégration.</p>
<p>Hadoop Unit s&rsquo;appuie sur le travail de <a href="https://github.com/sakserv/hadoop-mini-clusters">Shane Kumpf</a> et est lié aux versions des composants d&rsquo;Hortonworks (d&rsquo;ailleurs, une grosse partie des tests est directement un copier/coller de ce qu&rsquo;à fait Shane Kumpf).</p>
<p>Il ne propose ni Spark ni Map/Reduce car ces derniers n&rsquo;ont pas besoin d&rsquo;être simulés puisqu&rsquo;ils proposent un mode de développement.</p>
<p>Enfin, pour plus d&rsquo;informations sur l&rsquo;utilisation d&rsquo;Hadoop-Unit, je vous invite à aller sur la page du projet <a href="https://github.com/jetoile/hadoop-unit">github</a> et/ou de faire des Pull Request si vous avez des remarques/bugs et/ou à forker si cela vous convient pas.</p>
<p>Pour conclure, et même si cela se trouve sur github, voilà un exemple de ce qu&rsquo;il est possible de faire avec Hadoop Unit :</p>
<ul>
<li>
<p>Exemple 1</p>
<ul>
<li>émettre des données dans un topic Kafka</li>
<li>consommer les données en utilisant Spark Streaming</li>
<li>écrire les résultats dans HBase et/ou SolrCloud et/ou HDFS</li>
</ul>
</li>
<li>
<p>Exemple 2</p>
<ul>
<li>upload dans hdfs un fichier au format csv</li>
<li>créer une table hive associée</li>
<li>transformer via Spark SQL le csv en parquet (en utilisant le métastore de Hive)</li>
<li>indexer les données au format parquet dans SolrCloud en utilisant Spark</li>
</ul>
</li>
</ul>
<p>soit :</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">SparkSolrIntegrationTest</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">private</span> Logger LOGGER <span style="color:#f92672">=</span> LoggerFactory<span style="color:#f92672">.</span><span style="color:#a6e22e">getLogger</span><span style="color:#f92672">(</span>SparkSolrIntegrationTest<span style="color:#f92672">.</span><span style="color:#a6e22e">class</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">static</span> Configuration configuration<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> Operation CREATE_TABLES <span style="color:#f92672">=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> Operation DROP_TABLES <span style="color:#f92672">=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">@BeforeClass</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">setUp</span><span style="color:#f92672">()</span> <span style="color:#66d9ef">throws</span> BootstrapException<span style="color:#f92672">,</span> SQLException<span style="color:#f92672">,</span> ClassNotFoundException<span style="color:#f92672">,</span> NotFoundServiceException <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">try</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            configuration <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> PropertiesConfiguration<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;default.properties&#34;</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span> <span style="color:#66d9ef">catch</span> <span style="color:#f92672">(</span>ConfigurationException e<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> BootstrapException<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;bad config&#34;</span><span style="color:#f92672">,</span> e<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        CREATE_TABLES <span style="color:#f92672">=</span>
</span></span><span style="display:flex;"><span>                sequenceOf<span style="color:#f92672">(</span>sql<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;CREATE EXTERNAL TABLE IF NOT EXISTS default.test(id INT, value STRING) &#34;</span> <span style="color:#f92672">+</span>
</span></span><span style="display:flex;"><span>                                <span style="color:#e6db74">&#34; ROW FORMAT DELIMITED FIELDS TERMINATED BY &#39;;&#39;&#34;</span> <span style="color:#f92672">+</span>
</span></span><span style="display:flex;"><span>                                <span style="color:#e6db74">&#34; STORED AS TEXTFILE&#34;</span> <span style="color:#f92672">+</span>
</span></span><span style="display:flex;"><span>                                <span style="color:#e6db74">&#34; LOCATION &#39;hdfs://localhost:&#34;</span> <span style="color:#f92672">+</span> configuration<span style="color:#f92672">.</span><span style="color:#a6e22e">getInt</span><span style="color:#f92672">(</span>Config<span style="color:#f92672">.</span><span style="color:#a6e22e">HDFS_NAMENODE_PORT_KEY</span><span style="color:#f92672">)</span> <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;/khanh/test&#39;&#34;</span><span style="color:#f92672">),</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        DROP_TABLES <span style="color:#f92672">=</span>
</span></span><span style="display:flex;"><span>                sequenceOf<span style="color:#f92672">(</span>sql<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;DROP TABLE IF EXISTS default.test&#34;</span><span style="color:#f92672">));</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">@Before</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">before</span><span style="color:#f92672">()</span> <span style="color:#66d9ef">throws</span> IOException<span style="color:#f92672">,</span> URISyntaxException <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        FileSystem fileSystem <span style="color:#f92672">=</span> HdfsUtils<span style="color:#f92672">.</span><span style="color:#a6e22e">INSTANCE</span><span style="color:#f92672">.</span><span style="color:#a6e22e">getFileSystem</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        fileSystem<span style="color:#f92672">.</span><span style="color:#a6e22e">mkdirs</span><span style="color:#f92672">(</span><span style="color:#66d9ef">new</span> Path<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;/khanh/test&#34;</span><span style="color:#f92672">));</span>
</span></span><span style="display:flex;"><span>        fileSystem<span style="color:#f92672">.</span><span style="color:#a6e22e">mkdirs</span><span style="color:#f92672">(</span><span style="color:#66d9ef">new</span> Path<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;/khanh/test_parquet&#34;</span><span style="color:#f92672">));</span>
</span></span><span style="display:flex;"><span>        fileSystem<span style="color:#f92672">.</span><span style="color:#a6e22e">copyFromLocalFile</span><span style="color:#f92672">(</span><span style="color:#66d9ef">new</span> Path<span style="color:#f92672">(</span>SparkSolrIntegrationTest<span style="color:#f92672">.</span><span style="color:#a6e22e">class</span><span style="color:#f92672">.</span><span style="color:#a6e22e">getClassLoader</span><span style="color:#f92672">().</span><span style="color:#a6e22e">getResource</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;test.csv&#34;</span><span style="color:#f92672">).</span><span style="color:#a6e22e">toURI</span><span style="color:#f92672">()),</span> <span style="color:#66d9ef">new</span> Path<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;/khanh/test/test.csv&#34;</span><span style="color:#f92672">));</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">new</span> HiveSetup<span style="color:#f92672">(</span>HiveConnectionUtils<span style="color:#f92672">.</span><span style="color:#a6e22e">INSTANCE</span><span style="color:#f92672">.</span><span style="color:#a6e22e">getDestination</span><span style="color:#f92672">(),</span> Operations<span style="color:#f92672">.</span><span style="color:#a6e22e">sequenceOf</span><span style="color:#f92672">(</span>CREATE_TABLES<span style="color:#f92672">)).</span><span style="color:#a6e22e">launch</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">@After</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">clean</span><span style="color:#f92672">()</span> <span style="color:#66d9ef">throws</span> IOException <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">new</span> HiveSetup<span style="color:#f92672">(</span>HiveConnectionUtils<span style="color:#f92672">.</span><span style="color:#a6e22e">INSTANCE</span><span style="color:#f92672">.</span><span style="color:#a6e22e">getDestination</span><span style="color:#f92672">(),</span> Operations<span style="color:#f92672">.</span><span style="color:#a6e22e">sequenceOf</span><span style="color:#f92672">(</span>DROP_TABLES<span style="color:#f92672">)).</span><span style="color:#a6e22e">launch</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        FileSystem fileSystem <span style="color:#f92672">=</span> HdfsUtils<span style="color:#f92672">.</span><span style="color:#a6e22e">INSTANCE</span><span style="color:#f92672">.</span><span style="color:#a6e22e">getFileSystem</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>        fileSystem<span style="color:#f92672">.</span><span style="color:#a6e22e">delete</span><span style="color:#f92672">(</span><span style="color:#66d9ef">new</span> Path<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;/khanh&#34;</span><span style="color:#f92672">),</span> <span style="color:#66d9ef">true</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">@Test</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">spark_should_read_parquet_file_and_index_into_solr</span><span style="color:#f92672">()</span> <span style="color:#66d9ef">throws</span> IOException<span style="color:#f92672">,</span> SolrServerException <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">//given
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        SparkConf conf <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> SparkConf<span style="color:#f92672">()</span>
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">.</span><span style="color:#a6e22e">setMaster</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;local[*]&#34;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">.</span><span style="color:#a6e22e">setAppName</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;test&#34;</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        JavaSparkContext context <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> JavaSparkContext<span style="color:#f92672">(</span>conf<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">//read hive-site from classpath
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        HiveContext hiveContext <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> HiveContext<span style="color:#f92672">(</span>context<span style="color:#f92672">.</span><span style="color:#a6e22e">sc</span><span style="color:#f92672">());</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        DataFrame sql <span style="color:#f92672">=</span> hiveContext<span style="color:#f92672">.</span><span style="color:#a6e22e">sql</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;SELECT * FROM default.test&#34;</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>        sql<span style="color:#f92672">.</span><span style="color:#a6e22e">write</span><span style="color:#f92672">().</span><span style="color:#a6e22e">parquet</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;hdfs://localhost:&#34;</span> <span style="color:#f92672">+</span> configuration<span style="color:#f92672">.</span><span style="color:#a6e22e">getInt</span><span style="color:#f92672">(</span>Config<span style="color:#f92672">.</span><span style="color:#a6e22e">HDFS_NAMENODE_PORT_KEY</span><span style="color:#f92672">)</span> <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;/khanh/test_parquet/file.parquet&#34;</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        context<span style="color:#f92672">.</span><span style="color:#a6e22e">close</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">//when
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        context <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> JavaSparkContext<span style="color:#f92672">(</span>conf<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>        SQLContext sqlContext <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> SQLContext<span style="color:#f92672">(</span>context<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        DataFrame file <span style="color:#f92672">=</span> sqlContext<span style="color:#f92672">.</span><span style="color:#a6e22e">read</span><span style="color:#f92672">().</span><span style="color:#a6e22e">parquet</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;hdfs://localhost:&#34;</span> <span style="color:#f92672">+</span> configuration<span style="color:#f92672">.</span><span style="color:#a6e22e">getInt</span><span style="color:#f92672">(</span>Config<span style="color:#f92672">.</span><span style="color:#a6e22e">HDFS_NAMENODE_PORT_KEY</span><span style="color:#f92672">)</span> <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;/khanh/test_parquet/file.parquet&#34;</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>        DataFrame select <span style="color:#f92672">=</span> file<span style="color:#f92672">.</span><span style="color:#a6e22e">select</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;id&#34;</span><span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;value&#34;</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        JavaRDD<span style="color:#f92672">&lt;</span>SolrInputDocument<span style="color:#f92672">&gt;</span> solrInputDocument <span style="color:#f92672">=</span> select<span style="color:#f92672">.</span><span style="color:#a6e22e">toJavaRDD</span><span style="color:#f92672">().</span><span style="color:#a6e22e">map</span><span style="color:#f92672">(</span>r <span style="color:#f92672">-&gt;</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            SolrInputDocument solr <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> SolrInputDocument<span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>            solr<span style="color:#f92672">.</span><span style="color:#a6e22e">setField</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;id&#34;</span><span style="color:#f92672">,</span> r<span style="color:#f92672">.</span><span style="color:#a6e22e">getInt</span><span style="color:#f92672">(</span><span style="color:#ae81ff">0</span><span style="color:#f92672">));</span>
</span></span><span style="display:flex;"><span>            solr<span style="color:#f92672">.</span><span style="color:#a6e22e">setField</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;value_s&#34;</span><span style="color:#f92672">,</span> r<span style="color:#f92672">.</span><span style="color:#a6e22e">getString</span><span style="color:#f92672">(</span><span style="color:#ae81ff">1</span><span style="color:#f92672">));</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> solr<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">});</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        String collectionName <span style="color:#f92672">=</span> configuration<span style="color:#f92672">.</span><span style="color:#a6e22e">getString</span><span style="color:#f92672">(</span>SolrCloudBootstrap<span style="color:#f92672">.</span><span style="color:#a6e22e">SOLR_COLLECTION_NAME</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>        String zkHostString <span style="color:#f92672">=</span> configuration<span style="color:#f92672">.</span><span style="color:#a6e22e">getString</span><span style="color:#f92672">(</span>Config<span style="color:#f92672">.</span><span style="color:#a6e22e">ZOOKEEPER_HOST_KEY</span><span style="color:#f92672">)</span> <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;:&#34;</span> <span style="color:#f92672">+</span> configuration<span style="color:#f92672">.</span><span style="color:#a6e22e">getInt</span><span style="color:#f92672">(</span>Config<span style="color:#f92672">.</span><span style="color:#a6e22e">ZOOKEEPER_PORT_KEY</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>        SolrSupport<span style="color:#f92672">.</span><span style="color:#a6e22e">indexDocs</span><span style="color:#f92672">(</span>zkHostString<span style="color:#f92672">,</span> collectionName<span style="color:#f92672">,</span> <span style="color:#ae81ff">1000</span><span style="color:#f92672">,</span> solrInputDocument<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">//then
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        CloudSolrClient client <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> CloudSolrClient<span style="color:#f92672">(</span>zkHostString<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>        SolrDocument collection1 <span style="color:#f92672">=</span> client<span style="color:#f92672">.</span><span style="color:#a6e22e">getById</span><span style="color:#f92672">(</span>collectionName<span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;1&#34;</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        assertNotNull<span style="color:#f92672">(</span>collection1<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>        assertThat<span style="color:#f92672">(</span>collection1<span style="color:#f92672">.</span><span style="color:#a6e22e">getFieldValue</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;value_s&#34;</span><span style="color:#f92672">)).</span><span style="color:#a6e22e">isEqualTo</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;value1&#34;</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        client<span style="color:#f92672">.</span><span style="color:#a6e22e">close</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>        context<span style="color:#f92672">.</span><span style="color:#a6e22e">close</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div>
  
  <h4><i class="fas fa-share-alt" aria-hidden="true"></i>&nbsp;Share!</h4>
<ul class="share-buttons">
	<li><a href="https://www.facebook.com/sharer/sharer.php?u=https%3a%2f%2fblog.jetoile.fr%2f2016%2f04%2fhadoop-unit.html" target="_blank" title="Share on Facebook"><i class="fab fa-facebook" aria-hidden="true"></i><span class="sr-only">Share on Facebook</span></a>
	</li>&nbsp;&nbsp;&nbsp;
	<li><a href="https://twitter.com/intent/tweet?source=https%3a%2f%2fblog.jetoile.fr%2f2016%2f04%2fhadoop-unit.html" target="_blank" title="Tweet"><i class="fab fa-twitter" aria-hidden="true"></i><span class="sr-only">Tweet</span></a>
	</li>&nbsp;&nbsp;&nbsp;
	<li><a href="https://plus.google.com/share?url=https%3a%2f%2fblog.jetoile.fr%2f2016%2f04%2fhadoop-unit.html" target="_blank" title="Share on Google+"><i class="fab fa-google-plus" aria-hidden="true"></i><span class="sr-only">Share on Google+</span></a>
	</li>&nbsp;&nbsp;&nbsp;
	<li><a href="http://www.tumblr.com/share?v=3&u=https%3a%2f%2fblog.jetoile.fr%2f2016%2f04%2fhadoop-unit.html" target="_blank" title="Post to Tumblr"><i class="fab fa-tumblr" aria-hidden="true"></i><span class="sr-only">Post to Tumblr</span></a>
	</li>&nbsp;&nbsp;&nbsp;
	<li><a href="http://pinterest.com/pin/create/button/?url=https%3a%2f%2fblog.jetoile.fr%2f2016%2f04%2fhadoop-unit.html" target="_blank" title="Pin it"><i class="fab fa-pinterest-p" aria-hidden="true"></i><span class="sr-only">Pin it</span></a>
	</li>&nbsp;&nbsp;&nbsp;
	<li><a href="http://www.reddit.com/submit?url=https%3a%2f%2fblog.jetoile.fr%2f2016%2f04%2fhadoop-unit.html" target="_blank" title="Submit to Reddit"><i class="fab fa-reddit-alien" aria-hidden="true"></i><span class="sr-only">Submit to Reddit</span></a>
	</li>
</ul>


<style>
	ul.share-buttons{
	  list-style: none;
	  padding: 0;
	}

	ul.share-buttons li{
	  display: inline;
	}

	ul.share-buttons .sr-only{
	  position: absolute;
	  clip: rect(1px 1px 1px 1px);
	  clip: rect(1px, 1px, 1px, 1px);
	  padding: 0;
	  border: 0;
	  height: 1px;
	  width: 1px;
	  overflow: hidden;
	}
</style>


  
<div class="prev-next-post pure-g">
  <div class="pure-u-1-24" style="text-align: left;">
    
    <a href="https://blog.jetoile.fr/2016/01/hadoop-ecosysteme-bootstrap.html"><i class="fa fa-chevron-left"></i></a>
    
  </div>
  <div class="pure-u-10-24">
    
    <nav class="prev">
      <a href="https://blog.jetoile.fr/2016/01/hadoop-ecosysteme-bootstrap.html">Hadoop ecosysteme bootstrap</a>
    </nav>
    
  </div>
  <div class="pure-u-2-24">
    &nbsp;
  </div>
  <div class="pure-u-10-24">
    
    <nav class="next">
      <a href="https://blog.jetoile.fr/2016/05/hadoop-unit-1-dot-3.html">Hadoop Unit 1.3</a>
    </nav>
    
  </div>
  <div class="pure-u-1-24" style="text-align: right;">
    
    <a href="https://blog.jetoile.fr/2016/05/hadoop-unit-1-dot-3.html"><i class="fa fa-chevron-right"></i></a>
    
  </div>
</div>


  
  
  
  
<div id="disqus_thread"></div>
<script type="text/javascript">

(function() {
    
    
    if (window.location.hostname == "localhost")
        return;

    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    var disqus_shortname = 'jetoile';
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com/" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>


  

</div>

</div>
</div>
<script src="https://blog.jetoile.fr/js/ui.js"></script>
<script src="https://blog.jetoile.fr/js/menus.js"></script>




<script>
  
  if (window.location.hostname != "localhost") {
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-11955429-1', 'auto');
    ga('send', 'pageview');
  }
</script>





<script src="https://blog.jetoile.fr/js/math-code.js"></script>
  <script async src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/MathJax.js?config=TeX-MML-AM_CHTML"></script>
  


</body>
</html>

